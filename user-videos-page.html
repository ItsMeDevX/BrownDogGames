<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BrownDogGames</title>
  <link rel="icon" href="https://raw.githubusercontent.com/ItsMeDevX/BrownDogGames/main/LogoDog.ico" type="image/x-icon">
</head>
   
 <meta name="description" content="Discover and play free games, watch videos, and explore art. Join the BrownDogGames community and support creators.">
 <meta name="keywords" content="free games, indie games, game community, discover games, videos, art, game platform, creators">
 <meta name="author" content="BrownDogGames">
 <meta property="og:title" content="BrownDogGames - Discover Games, Videos & Art">

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1336090735244829"
crossorigin="anonymous"></script>
  
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BrownDogGames - Adult Cartoon Games</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Rubik+Mono+One&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@700&display=swap');

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Rubik Mono One', sans-serif;
      background-color: #1e1b2e;
      color: #fefefe;
      min-height: 100vh;
      padding: 20px;
      background-image: linear-gradient(135deg, #2c1b33, #191425);
      text-align: center;
    }

    /* Access Choice Gate */
    #access-choice-gate {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      justify-content: flex-start;
      align-items: center;
      flex-direction: column;
      z-index: 10000;
      color: #ff69b4;
      font-family: 'Rubik Mono One', sans-serif;
      text-align: center;
      padding: 20px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    #access-choice-gate.show {
      display: flex;
    }

    .choice-gate-content {
      background: #2a243b;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 0 30px rgba(255, 105, 180, 0.5);
      max-width: 700px;
      width: 90%;
      margin: 20px auto;
    }

    .access-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin: 30px 0;
    }

    .access-option {
      background: #3b3750;
      padding: 30px 20px;
      border-radius: 12px;
      border: 3px solid transparent;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .access-option:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }

    .access-option.vip {
      border-color: #2ecc71;
      background: linear-gradient(135deg, #2d4a3a, #3b4d42);
    }

    .access-option.vip:hover {
      border-color: #27ae60;
      box-shadow: 0 10px 25px rgba(46, 204, 113, 0.3);
    }

    .access-option.free {
      border-color: #3498db;
      background: linear-gradient(135deg, #2c3e50, #34495e);
    }

    .access-option.free:hover {
      border-color: #2980b9;
      box-shadow: 0 10px 25px rgba(52, 152, 219, 0.3);
    }

    .access-option h3 {
      font-size: 1.5rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .access-option.vip h3 {
      color: #2ecc71;
    }

    .access-option.free h3 {
      color: #3498db;
    }

    .access-option .price {
      font-size: 2rem;
      font-weight: bold;
      margin: 15px 0;
    }

    .access-option.vip .price {
      color: #2ecc71;
    }

    .access-option.free .price {
      color: #3498db;
    }

    .feature-list {
      list-style: none;
      text-align: left;
      margin: 20px 0;
    }

    .feature-list li {
      padding: 8px 0;
      color: #ffc0cb;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
    }

    .feature-list .icon {
      width: 20px;
      text-align: center;
    }

    .vip-only-features {
      background: #2d4a3a;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border-left: 4px solid #2ecc71;
    }

    .free-features {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border-left: 4px solid #3498db;
    }

    /* VIP Process Steps */
    .vip-process {
      display: none;
      margin-top: 30px;
    }

    .vip-step {
      background: #3b3750;
      padding: 20px;
      border-radius: 8px;
      margin: 15px 0;
      border: 2px solid #ff69b4;
    }

    .vip-step.completed {
      background: #2a4d3a;
      border-color: #2ecc71;
    }

    .vip-step h4 {
      color: #ff69b4;
      margin-bottom: 15px;
      font-size: 1.1rem;
    }

    .vip-step.completed h4 {
      color: #2ecc71;
    }

    #github-login-btn {
      background: #333;
      color: #fff;
      border: none;
      padding: 12px 24px;
      font-weight: bold;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      margin: 10px 0;
    }

    #github-login-btn:hover {
      background: #555;
    }

    #github-login-btn:disabled {
      background: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .login-status {
      color: #2ecc71;
      font-size: 0.9rem;
      margin-top: 10px;
      display: none;
    }

    .login-status.show {
      display: block;
    }

    #vip-paypal-container {
      margin: 20px 0;
    }

    .gate-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .gate-buttons button {
      background: #666;
      color: #fff;
      border: none;
      padding: 12px 24px;
      font-weight: bold;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      min-width: 150px;
    }

    .gate-buttons button:hover {
      background: #888;
    }

    .gate-buttons button.primary {
      background: #ff69b4;
      color: #1e1b2e;
    }

    .gate-buttons button.primary:hover {
      background: #ff8edb;
    }

    #access-message {
      margin: 15px 0;
      padding: 12px;
      border-radius: 8px;
      display: none;
      font-size: 0.9rem;
    }

    .success-message {
      background: #2ecc71;
      color: white;
    }

    .error-message {
      background: #e74c3c;
      color: white;
    }

    /* Age Gate */
    #age-gate {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 9999;
      color: #ff69b4;
      font-family: 'Rubik Mono One', sans-serif;
      text-align: center;
      padding: 20px;
    }

    #age-gate.show {
      display: flex;
    }

    #age-gate h2 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }

    #age-gate p {
      margin-bottom: 1.5rem;
      font-size: 1.1rem;
      color: #ffc0cb;
    }

    #age-gate button {
      background: #ff69b4;
      color: #1e1b2e;
      border: none;
      padding: 0.7rem 1.4rem;
      font-weight: bold;
      font-size: 1rem;
      border-radius: 8px;
      margin: 0.5rem;
      cursor: pointer;
      transition: background 0.2s;
      min-width: 120px;
    }

    #age-gate button:hover {
      background: #ff8edb;
    }

    /* Taskbar */
    #taskbar {
      max-width: 1200px;
      margin: 20px auto;
      background-color: #2a243b;
      border-radius: 12px;
      box-shadow: 0 0 12px #00000055;
      padding: 15px 20px;
      font-family: 'Rubik Mono One', sans-serif;
      color: #fefefe;
      position: relative;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 20px;
    }

    .taskbar-logo {
      display: flex;
      align-items: center;
    }

    .taskbar-logo img {
      height: 90px;
      width: auto;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .taskbar-logo img:hover {
      transform: scale(1.1);
    }

    .taskbar-nav {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .taskbar-nav button {
      background-color: #ff69b4;
      color: #1e1b2e;
      border: none;
      padding: 0.5rem 1rem;
      font-weight: bold;
      font-size: 0.9rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
      white-space: nowrap;
    }

    .taskbar-nav button:hover {
      background-color: #ff8edb;
    }

    .taskbar-nav button.vip-only {
      background-color: #666;
      color: #999;
      cursor: not-allowed;
      position: relative;
    }

    .taskbar-nav button.vip-only:hover::after {
      content: "VIP Only";
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      white-space: nowrap;
    }

    .taskbar-search {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }

    .taskbar-search input {
      width: 200px;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      background-color: #3b3750;
      color: #fefefe;
    }

    .taskbar-search button {
      background-color: #ff69b4;
      color: #1e1b2e;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s;
    }

    .taskbar-search button:hover {
      background-color: #ff8edb;
    }

    /* Message Notifications */
    .taskbar-messages {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }

    .messages-button {
      background-color: #ff69b4;
      color: #1e1b2e;
      border: none;
      padding: 8px 16px;
      font-weight: bold;
      font-size: 0.9rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .messages-button:hover {
      background-color: #ff8edb;
      transform: scale(1.05);
    }

    .messages-button.has-unread {
      background: linear-gradient(45deg, #ff69b4, #ff1493);
      animation: pulse-glow 2s infinite;
    }

    .message-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: linear-gradient(45deg, #ff4444, #ff6666);
      color: white;
      border-radius: 50%;
      min-width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
      border: 2px solid #2a243b;
      animation: bounce-badge 1s infinite;
    }

    @keyframes pulse-glow {
      0%, 100% {
        box-shadow: 0 0 5px rgba(255, 105, 180, 0.5);
      }
      50% {
        box-shadow: 0 0 20px rgba(255, 105, 180, 0.8);
      }
    }

    @keyframes bounce-badge {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
    }

    .message-preview-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background-color: #2a243b;
      border: 2px solid #ff69b4;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
      min-width: 320px;
      max-width: 400px;
      display: none;
      flex-direction: column;
      z-index: 1000;
      margin-top: 10px;
      max-height: 400px;
      overflow-y: auto;
    }

    .message-preview-dropdown.show {
      display: flex;
    }

    .message-preview-header {
      background: #3b3750;
      padding: 12px 16px;
      border-bottom: 1px solid #ff69b4;
      font-weight: bold;
      color: #ff69b4;
      text-align: center;
      border-radius: 10px 10px 0 0;
    }

    .message-preview-item {
      padding: 12px 16px;
      border-bottom: 1px solid #3b3750;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .message-preview-item:hover {
      background-color: #3b3750;
    }

    .message-preview-item.unread {
      background: linear-gradient(90deg, rgba(255, 105, 180, 0.1), transparent);
      border-left: 3px solid #ff69b4;
    }

    .message-preview-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      border: 2px solid #ff69b4;
      object-fit: cover;
      flex-shrink: 0;
    }

    .message-preview-content {
      flex: 1;
      min-width: 0;
    }

    .message-preview-sender {
      font-weight: bold;
      color: #ff69b4;
      font-size: 0.9rem;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .message-preview-text {
      color: #fefefe;
      font-size: 0.8rem;
      line-height: 1.3;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .message-preview-time {
      color: #999;
      font-size: 0.7rem;
      margin-top: 2px;
    }

    .message-preview-footer {
      padding: 10px 16px;
      text-align: center;
      border-top: 1px solid #3b3750;
      background: #3b3750;
      border-radius: 0 0 10px 10px;
    }

    .message-preview-footer button {
      background: linear-gradient(45deg, #ff69b4, #ff8edb);
      color: #1e1b2e;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.8rem;
    }

    .message-preview-footer button:hover {
      transform: scale(1.05);
    }

    .no-messages {
      text-align: center;
      color: #999;
      font-style: italic;
      padding: 20px;
      font-size: 0.9rem;
    }

    .taskbar-vip {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .taskbar-vip button {
      background-color: #ff69b4;
      color: #1e1b2e;
      border: none;
      padding: 8px 16px;
      font-weight: bold;
      font-size: 0.9rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .taskbar-vip button:hover {
      background-color: #ff8edb;
    }

    .vip-status {
      color: #2ecc71;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .free-status {
      color: #3498db;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .taskbar-auth {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }

    .taskbar-auth button {
      background-color: #ff69b4;
      color: #1e1b2e;
      border: none;
      padding: 8px 16px;
      font-weight: bold;
      font-size: 0.9rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .taskbar-auth button:hover {
      background-color: #ff8edb;
    }

    /* Dropdown styles */
    #suggestions-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background-color: #3b3750;
      border-radius: 8px;
      box-shadow: 0 4px 12px #00000077;
      display: none;
      flex-direction: column;
      z-index: 10;
      margin-top: 5px;
    }

    #suggestions-dropdown > div {
      padding: 8px 12px;
      cursor: pointer;
      transition: background-color 0.2s;
      color: #fefefe;
    }

    #suggestions-dropdown > div:hover {
      background-color: #ff69b4;
      color: #1e1b2e;
    }

    #user-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background-color: #3b3750;
      border: 2px solid #ff69b4;
      border-radius: 8px;
      box-shadow: 0 4px 12px #00000077;
      min-width: 150px;
      display: none;
      flex-direction: column;
      z-index: 1000;
      margin-top: 5px;
    }

    #user-dropdown button {
      background: none;
      border: none;
      color: #fefefe;
      padding: 12px 16px;
      text-align: left;
      font-weight: bold;
      font-family: 'Rubik Mono One', sans-serif;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
      width: 100%;
      border-radius: 0;
    }

    #user-dropdown button:hover {
      background-color: #ff69b4;
      color: #1e1b2e;
    }

    #user-dropdown button:first-child {
      border-radius: 6px 6px 0 0;
    }

    #user-dropdown button:last-child {
      border-radius: 0 0 6px 6px;
    }

    #user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }

    #user-info img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid #ff69b4;
      object-fit: cover;
    }

    @media (max-width: 900px) {
      #taskbar {
        max-width: 95%;
        flex-direction: column;
        gap: 15px;
        text-align: center;
        padding: 20px;
      }

      .taskbar-logo img {
        height: 75px;
      }

      .taskbar-nav {
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
      }

      .taskbar-search input {
        width: 200px;
      }

      .access-options {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .gate-buttons {
        flex-direction: column;
        align-items: center;
      }

      .choice-gate-content {
        padding: 20px 15px;
        margin: 10px;
        max-width: 95%;
      }

      .message-preview-dropdown {
        right: -50px;
        min-width: 280px;
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 10px;
      }

      .taskbar-logo img {
        height: 65px;
      }

      .choice-gate-content {
        padding: 15px 10px;
        margin: 5px;
      }

      .access-option {
        padding: 20px 15px;
      }

      .access-option h3 {
        font-size: 1.2rem;
      }

      .access-option .price {
        font-size: 1.5rem;
      }

      .message-preview-dropdown {
        right: -100px;
        min-width: 260px;
      }
    }
  </style>
</head>
<body>

<!-- Access Choice Gate -->
<div id="access-choice-gate">
  <div class="choice-gate-content">
    <h2>🎮 Welcome to BrownDogGames</h2>
    <p>Choose your access level - VIP membership or free browsing:</p>

    <div class="access-options">
      <!-- VIP Option -->
      <div class="access-option vip" id="vip-option">
        <h3>⭐ VIP Access</h3>
        <div class="price">£2/month</div>
        <ul class="feature-list">
          <li><span class="icon">🎮</span> Access to all premium games</li>
          <li><span class="icon">✅</span> Verified member chats</li>
          <li><span class="icon">💰</span> Earn money from content</li>
          <li><span class="icon">🏅</span> VIP badges & status</li>
          <li><span class="icon">🚀</span> Priority support</li>
          <li><span class="icon">💬</span> Direct community access</li>
        </ul>
        <div class="vip-only-features">
          <strong>Premium Features:</strong> Enhanced experience, priority support, and community benefits
        </div>
      </div>

      <!-- Free Option -->
      <div class="access-option free" id="free-option">
        <h3>🆓 Free Access</h3>
        <div class="price">Free</div>
        <ul class="feature-list">
          <li><span class="icon">🎮</span> Browse all public games</li>
          <li><span class="icon">👀</span> View user profiles</li>
          <li><span class="icon">🖼️</span> See user art & videos</li>
          <li><span class="icon">🔍</span> Search & discover content</li>
          <li><span class="icon">📱</span> Mobile-friendly experience</li>
        </ul>
        <div class="free-features">
          <strong>Free Features:</strong> Perfect for casual browsing and discovering new content
        </div>
      </div>
    </div>

    <!-- VIP Process (hidden initially) -->
    <div class="vip-process" id="vip-process">
      <div class="vip-step" id="login-step">
        <h4>Step 1: Create Account</h4>
        <p>Login with GitHub to create your VIP account</p>
        <button id="github-login-btn">🔑 Login with GitHub</button>
        <div class="login-status" id="login-status">✅ Successfully logged in!</div>
      </div>

      <div class="vip-step" id="payment-step" style="display: none;">
        <h4>Step 2: Subscribe for VIP Access</h4>
        <p>Subscribe to VIP for just £2/month - includes age verification and unlocks all premium features!</p>
        <div id="vip-paypal-container"></div>
      </div>
    </div>
      
    <div id="access-message"></div>
      
    <div class="gate-buttons">
      <button id="back-to-options" style="display: none;">← Back to Options</button>
      <button id="exit-btn">I'm Under 18 - Exit</button>
    </div>
  </div>
</div>

<!-- Age Gate -->
<div id="age-gate">
  <h2>🔞 Adults Only</h2>
  <p>You must be 18 or older to access BrownDogGames.</p>
  <button id="yes-btn">Yes, I'm 18+</button>
  <button id="no-btn">No, Take Me Back</button>
</div>

<!-- Taskbar -->
<div id="taskbar">
  <div class="taskbar-logo">
    <img 
      src="https://raw.githubusercontent.com/ItsMeDevX/BrownDogGames/main/BrownDogGamesLogo.png" 
      alt="BrownDogGames Logo"
      onclick="window.location.href='index.html'"
    >
  </div>

  <div class="taskbar-nav" id="taskbar-nav">
    <!-- Navigation buttons injected by JS -->
  </div>
  
  <div class="taskbar-search">
    <input type="text" id="game-search-input" placeholder="Search games..." />
    <button id="search-button">Search</button>
    <div id="suggestions-dropdown"></div>
  </div>

  <!-- NEW: Message Notifications -->
  <div class="taskbar-messages" id="taskbar-messages" style="display: none;">
    <button class="messages-button" id="messages-button">
      💬 Messages
      <span class="message-badge" id="message-badge" style="display: none;">0</span>
    </button>
    <div class="message-preview-dropdown" id="message-preview-dropdown">
      <div class="message-preview-header">Recent Messages</div>
      <div id="message-preview-list">
        <div class="no-messages">No new messages</div>
      </div>
      <div class="message-preview-footer">
        <button onclick="window.location.href='user-profiles.html'">View All Messages</button>
      </div>
    </div>
  </div>

  <div class="taskbar-vip" id="taskbar-vip">
    <!-- VIP button/status injected by JS -->
  </div>
  
  <div class="taskbar-auth" id="taskbar-auth">
    <!-- Auth content injected by JS -->
  </div>
</div>

<!-- Scripts -->
<script src="https://www.paypal.com/sdk/js?client-id=AYgrpkjHd7Ycq_8vUWm9nb3qigcwALSTbyMZ5o6LjMqjC1YscFwQ_1kDEMr7tm2D1xysfHSEiyhZ1pZl&vault=true&intent=subscription"></script>

<script>
  // Global variables
  let gateUser = null;
  let supabaseClient = null;
  let authInitialized = false;
  let messageUpdateInterval = null;

  // Access Management
  document.addEventListener('DOMContentLoaded', () => {
    const accessChoiceGate = document.getElementById('access-choice-gate');
    const vipOption = document.getElementById('vip-option');
    const freeOption = document.getElementById('free-option');
    const vipProcess = document.getElementById('vip-process');
    const backToOptionsBtn = document.getElementById('back-to-options');
    const exitBtn = document.getElementById('exit-btn');
    const accessMessage = document.getElementById('access-message');
    const githubLoginBtn = document.getElementById('github-login-btn');
    const loginStep = document.getElementById('login-step');
    const paymentStep = document.getElementById('payment-step');
    const loginStatus = document.getElementById('login-status');

    // Check if user already has access
    function checkExistingAccess() {
      const hasVIPAccess = localStorage.getItem('vipAccess') === 'true';
      const hasFreeAccess = localStorage.getItem('freeAccess') === 'true';
      const isAgeVerified = localStorage.getItem('ageVerified') === 'true';

      // If user has any access and is age verified, don't show gate
      if ((hasVIPAccess || hasFreeAccess) && isAgeVerified) {
        return true;
      }
      return false;
    }

    // Show access gate if no existing access
    if (!checkExistingAccess()) {
      accessChoiceGate.classList.add('show');
    }

    // VIP Option Click
    vipOption.addEventListener('click', () => {
      vipProcess.style.display = 'block';
      backToOptionsBtn.style.display = 'inline-block';
      document.querySelector('.access-options').style.display = 'none';
    });

    // Free Option Click
    freeOption.addEventListener('click', () => {
      // Grant free access
      localStorage.setItem('freeAccess', 'true');
      localStorage.setItem('ageVerified', 'true');
      
      showAccessMessage('🎉 Free access granted! Welcome to BrownDogGames!');
      
      setTimeout(() => {
        accessChoiceGate.classList.remove('show');
        // Re-render taskbar to show free status
        if (window.renderVip) {
          window.renderVip();
        }
      }, 2000);
    });

    // Back to Options
    backToOptionsBtn.addEventListener('click', () => {
      vipProcess.style.display = 'none';
      backToOptionsBtn.style.display = 'none';
      document.querySelector('.access-options').style.display = 'grid';
      hideAccessMessage();
    });

    // Exit Button
    exitBtn.addEventListener('click', () => {
      alert('Thank you for being honest. Redirecting to a family-friendly site.');
      window.location.href = 'https://google.com';
    });

    // GitHub Login
    githubLoginBtn.addEventListener('click', () => {
      githubLoginBtn.disabled = true;
      githubLoginBtn.textContent = 'Connecting...';
      
      if (window.supabaseClient) {
        window.supabaseClient.auth.signInWithOAuth({ provider: 'github' });
      } else {
        showAccessMessage('Loading login system...', true);
        setTimeout(() => {
          if (window.supabaseClient) {
            window.supabaseClient.auth.signInWithOAuth({ provider: 'github' });
          } else {
            githubLoginBtn.disabled = false;
            githubLoginBtn.textContent = '🔑 Login with GitHub';
            showAccessMessage('Login system failed to load. Please refresh the page.', true);
          }
        }, 2000);
      }
    });

    // Listen for login success
    let loginHandlerAdded = false;
    
    function addLoginHandler() {
      if (!loginHandlerAdded) {
        window.addEventListener('vip-user-logged-in', (event) => {
          gateUser = event.detail;
          showLoginSuccess();
        });
        loginHandlerAdded = true;
      }
    }
    
    addLoginHandler();

    function showLoginSuccess() {
      loginStep.classList.add('completed');
      githubLoginBtn.style.display = 'none';
      loginStatus.classList.add('show');
      
      setTimeout(() => {
        showPaymentStep();
      }, 1500);
    }

    function showPaymentStep() {
      paymentStep.style.display = 'block';
      
      setTimeout(() => {
        initVIPPayPal();
      }, 500);
    }

    function showAccessMessage(text, isError = false) {
      accessMessage.textContent = text;
      accessMessage.className = isError ? 'error-message' : 'success-message';
      accessMessage.style.display = 'block';
    }

    function hideAccessMessage() {
      accessMessage.style.display = 'none';
    }

    // Make initVIPPayPal available globally so upgrade button can use it
    window.initVIPPayPal = initVIPPayPal;

    function initVIPPayPal() {
      if (typeof paypal === 'undefined') {
        showAccessMessage('PayPal not loaded. Please refresh the page.', true);
        return;
      }

      if (!gateUser) {
        showAccessMessage('Please login first before subscribing.', true);
        return;
      }

      const container = document.getElementById('vip-paypal-container');
      if (container) {
        // Only clear if no active PayPal buttons exist
        if (!container.hasChildNodes() || !container.querySelector('.paypal-buttons')) {
          container.innerHTML = '';
        }
      }

      paypal.Buttons({
        style: {
          shape: 'rect',
          color: 'gold',
          layout: 'vertical',
          label: 'subscribe',
          height: 45
        },

        createSubscription(data, actions) {
          hideAccessMessage();
          return actions.subscription.create({
            plan_id: 'P-20H197268N8973414NBIXE2I'
          });
        },

        onApprove: async (data) => {
          hideAccessMessage();
          const subscriptionID = data.subscriptionID;

          try {
            // Save to database
            if (window.supabaseClient && gateUser) {
              const { error } = await window.supabaseClient
                .from('users')
                .upsert({
                  id: gateUser.id,
                  is_vip: true,
                  vip_expires_at: null,
                  paypal_transaction_id: subscriptionID
                });

              if (error) {
                console.error('Failed to update database:', error);
              }
            }

            // Grant VIP access
            localStorage.setItem('vipAccess', 'true');
            localStorage.setItem('ageVerified', 'true');
            localStorage.setItem('vipSubscriptionId', subscriptionID);
            localStorage.setItem('vipActivatedAt', new Date().toISOString());

            showAccessMessage('🎉 VIP access activated! Welcome to BrownDogGames Premium!');

            setTimeout(() => {
              accessChoiceGate.classList.remove('show');
              if (window.renderVip) {
                window.renderVip();
              }
            }, 2000);

          } catch (error) {
            console.error('Error processing subscription:', error);
            showAccessMessage('Subscription successful, but there was an error. Please refresh the page.', true);
          }
        },

        onError: (err) => {
          console.error('PayPal error:', err);
          showAccessMessage('Payment error. Please try again or contact support.', true);
        },

        onCancel: (data) => {
          showAccessMessage('Payment cancelled. You can still choose free access instead.', true);
        }

      }).render('#vip-paypal-container');
    }

    // Check access every 30 seconds to prevent manipulation, only when page is not active
    setInterval(() => {
      if (document.hidden || !document.hasFocus()) {
        const hasVIPAccess = localStorage.getItem('vipAccess') === 'true';
        const hasFreeAccess = localStorage.getItem('freeAccess') === 'true';
        const isAgeVerified = localStorage.getItem('ageVerified') === 'true';

        // If no access or age verification, show gate
        if (!(hasVIPAccess || hasFreeAccess) || !isAgeVerified) {
          accessChoiceGate.classList.add('show');
        }
      }
    }, 30000);
  });

  // Age Gate
  document.addEventListener('DOMContentLoaded', () => {
    const ageGate = document.getElementById('age-gate');
    const yesBtn = document.getElementById('yes-btn');
    const noBtn = document.getElementById('no-btn');

    // Check if user has already verified their age
    const isVerified = localStorage.getItem('ageVerified') === 'true';

    // Only show age gate if not verified
    if (!isVerified) {
      ageGate.classList.add('show');
    }

    yesBtn.addEventListener('click', () => {
      localStorage.setItem('ageVerified', 'true');
      ageGate.classList.remove('show');
    });

    noBtn.addEventListener('click', () => {
      alert('Sorry, you must be 18 or older to enter.');
      window.location.href = 'https://google.com';
    });
  });

  // Message Notifications System
  function initMessageNotifications() {
    const messagesButton = document.getElementById('messages-button');
    const messagePreviewDropdown = document.getElementById('message-preview-dropdown');
    const messageBadge = document.getElementById('message-badge');
    
    if (!messagesButton) return;

    // Toggle dropdown
    messagesButton.addEventListener('click', (e) => {
      e.stopPropagation();
      const isVisible = messagePreviewDropdown.classList.contains('show');
      
      if (isVisible) {
        messagePreviewDropdown.classList.remove('show');
      } else {
        messagePreviewDropdown.classList.add('show');
        loadMessagePreviews();
      }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!messagePreviewDropdown.contains(e.target) && !messagesButton.contains(e.target)) {
        messagePreviewDropdown.classList.remove('show');
      }
    });
  }

  // Load message previews
  async function loadMessagePreviews() {
    const messagePreviewList = document.getElementById('message-preview-list');
    
    if (!window.supabaseClient || !window.currentUser || !window.currentUsername) {
      messagePreviewList.innerHTML = '<div class="no-messages">Please log in to see messages</div>';
      return;
    }

    try {
      // Get recent unread messages
      const { data: messages, error } = await window.supabaseClient
        .from('direct_messages')
        .select('*')
        .eq('recipient_username', window.currentUsername)
        .eq('is_read', false)
        .order('created_at', { ascending: false })
        .limit(5);

      if (error) {
        console.error('Error loading message previews:', error);
        messagePreviewList.innerHTML = '<div class="no-messages">Error loading messages</div>';
        return;
      }

      if (!messages || messages.length === 0) {
        messagePreviewList.innerHTML = '<div class="no-messages">No new messages</div>';
        return;
      }

      // Group by sender to show latest message from each
      const senderMap = new Map();
      for (const message of messages) {
        if (!senderMap.has(message.sender_username)) {
          senderMap.set(message.sender_username, message);
        }
      }

      const uniqueMessages = Array.from(senderMap.values());

      // Render message previews
      const previewsHtml = await Promise.all(uniqueMessages.map(async (message) => {
        const avatar = await getAvatarForUsername(message.sender_username);
        const time = new Date(message.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const preview = message.message_content.substring(0, 50) + (message.message_content.length > 50 ? '...' : '');
        
        return `
          <div class="message-preview-item unread" onclick="openUserProfile('${message.sender_username}')">
            ${avatar ? `<img src="${avatar}" alt="${message.sender_username}" class="message-preview-avatar">` : 
                      `<div class="message-preview-avatar" style="background: #ff4f9f; display: flex; align-items: center; justify-content: center; color: #1b1b2e; font-weight: bold; font-size: 0.8rem;">${message.sender_username.charAt(0).toUpperCase()}</div>`}
            <div class="message-preview-content">
              <div class="message-preview-sender">
                ${message.sender_username}
                <span class="message-preview-time">${time}</span>
              </div>
              <div class="message-preview-text">${preview}</div>
            </div>
          </div>
        `;
      }));

      messagePreviewList.innerHTML = previewsHtml.join('');

    } catch (error) {
      console.error('Error in loadMessagePreviews:', error);
      messagePreviewList.innerHTML = '<div class="no-messages">Error loading messages</div>';
    }
  }

  // Update message count and badge
  async function updateMessageNotifications() {
    if (!window.supabaseClient || !window.currentUser || !window.currentUsername) {
      return;
    }

    try {
      // Count unread messages
      const { count, error } = await window.supabaseClient
        .from('direct_messages')
        .select('*', { count: 'exact', head: true })
        .eq('recipient_username', window.currentUsername)
        .eq('is_read', false);

      if (error) {
        console.error('Error counting unread messages:', error);
        return;
      }

      const unreadCount = count || 0;
      const messagesButton = document.getElementById('messages-button');
      const messageBadge = document.getElementById('message-badge');
      const taskbarMessages = document.getElementById('taskbar-messages');

      if (unreadCount > 0) {
        // Show notifications
        taskbarMessages.style.display = 'flex';
        messagesButton.classList.add('has-unread');
        messageBadge.style.display = 'flex';
        messageBadge.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
      } else {
        // Hide badge but keep messages button visible for logged-in users
        messagesButton.classList.remove('has-unread');
        messageBadge.style.display = 'none';
        
        // Only show messages button if user is logged in
        if (window.currentUser) {
          taskbarMessages.style.display = 'flex';
        } else {
          taskbarMessages.style.display = 'none';
        }
      }

    } catch (error) {
      console.error('Error in updateMessageNotifications:', error);
    }
  }

  // Open user profile when clicking message preview
  window.openUserProfile = function(username) {
    const messagePreviewDropdown = document.getElementById('message-preview-dropdown');
    messagePreviewDropdown.classList.remove('show');
    
    // Mark messages from this user as read
    markMessagesAsRead(username);
    
    window.location.href = `user.html?user=${username}`;
  };

  // Mark messages as read when viewing
  async function markMessagesAsRead(senderUsername) {
    if (!window.supabaseClient || !window.currentUsername) return;
    
    try {
      const { error } = await window.supabaseClient
        .from('direct_messages')
        .update({ is_read: true })
        .eq('recipient_username', window.currentUsername)
        .eq('sender_username', senderUsername)
        .eq('is_read', false);
        
      if (error) {
        console.error('Error marking messages as read:', error);
      } else {
        // Update notification count immediately
        updateMessageNotifications();
      }
    } catch (error) {
      console.error('Error in markMessagesAsRead:', error);
    }
  }

  // Get avatar for username (helper function)
  async function getAvatarForUsername(username) {
    if (!window.supabaseClient) return null;
    
    try {
      // Try games first
      const { data: gameData } = await window.supabaseClient
        .from('game_submissions')
        .select('avatar_url')
        .eq('github_user', username)
        .limit(1);
      
      if (gameData && gameData.length > 0 && gameData[0].avatar_url) {
        return gameData[0].avatar_url;
      }

      // Try videos
      const { data: videoData } = await window.supabaseClient
        .from('game_videos')
        .select('avatar_url')
        .eq('github_username', username)
        .limit(1);
      
      if (videoData && videoData.length > 0 && videoData[0].avatar_url) {
        return videoData[0].avatar_url;
      }

      // Try art
      const { data: artData } = await window.supabaseClient
        .from('user_art')
        .select('avatar_url')
        .eq('github_username', username)
        .limit(1);
      
      if (artData && artData.length > 0 && artData[0].avatar_url) {
        return artData[0].avatar_url;
      }

      return null;
    } catch (error) {
      console.error('Error getting avatar:', error);
      return null;
    }
  }

  // Game Search
  const gamePages = [
    { title: 'Lapdance Dash', url: 'https://browndoggames.com/Lapdance-Dash.html' },
    { title: 'Naked Craft', url: 'https://browndoggames.com/naked-craft.html' },
    { title: 'Butt Blaster Arena', url: 'https://browndoggames.com/butt-blaster-arena.html' },
    { title: 'Streaker Run', url: 'https://browndoggames.com/streaker-run.html' },
    { title: 'Pet Penis Simulator', url: 'https://browndoggames.com/pet-penis-simulator.html' },
    { title: 'Naked Fang', url: 'https://browndoggames.com/naked-fang.html' },
    { title: 'Climax Clash', url: 'https://browndoggames.com/Climax-Clash.html' },
    { title: 'Shafted', url: 'https://browndoggames.com/Shafted.html' },
    { title: 'She Comes First', url: 'https://browndoggames.com/She-Comes-First.html' },
    { title: 'LustLab', url: 'https://browndoggames.com/LustLab.html' }
  ];

  const searchInput = document.getElementById('game-search-input');
  const suggestionsDropdown = document.getElementById('suggestions-dropdown');
  let highlightedIndex = -1;

  searchInput.addEventListener('input', () => {
    const query = searchInput.value.trim().toLowerCase();
    
    if (query) {
      const firstLetterMatches = gamePages.filter(game => 
        game.title.toLowerCase().startsWith(query[0])
      );

      const results = firstLetterMatches.concat(gamePages.filter(game => 
        game.title.toLowerCase().includes(query) && !game.title.toLowerCase().startsWith(query[0])
      ));

      if (results.length > 0) {
        suggestionsDropdown.style.display = 'flex';
        suggestionsDropdown.innerHTML = '';

        results.forEach((game, index) => {
          const suggestionItem = document.createElement('div');
          suggestionItem.innerHTML = game.title;
          suggestionItem.addEventListener('click', () => {
            window.location.href = game.url;
          });
          suggestionsDropdown.appendChild(suggestionItem);
        });
      } else {
        suggestionsDropdown.style.display = 'none';
      }
    } else {
      suggestionsDropdown.style.display = 'none';
    }
  });

  searchInput.addEventListener('keydown', (e) => {
    const suggestions = suggestionsDropdown.querySelectorAll('div');

    if (e.key === 'ArrowDown') {
      if (highlightedIndex < suggestions.length - 1) {
        highlightedIndex++;
        updateHighlightedItem(suggestions);
      }
    } else if (e.key === 'ArrowUp') {
      if (highlightedIndex > 0) {
        highlightedIndex--;
        updateHighlightedItem(suggestions);
      }
    } else if (e.key === 'Enter' && highlightedIndex >= 0) {
      suggestions[highlightedIndex].click();
    }
  });

  function updateHighlightedItem(suggestions) {
    suggestions.forEach((item, index) => {
      if (index === highlightedIndex) {
        item.style.backgroundColor = '#ff69b4';
        item.style.color = '#1e1b2e';
      } else {
        item.style.backgroundColor = 'transparent';
        item.style.color = '#fefefe';
      }
    });
  }

  document.getElementById('search-button').addEventListener('click', () => {
    const query = searchInput.value.trim().toLowerCase();
    const result = gamePages.find(game => game.title.toLowerCase() === query);

    if (result) {
      window.location.href = result.url;
    } else {
      alert('No game found for your search.');
    }
  });

  document.addEventListener('click', (event) => {
    if (!searchInput.contains(event.target) && !suggestionsDropdown.contains(event.target)) {
      suggestionsDropdown.style.display = 'none';
      highlightedIndex = -1;
    }
  });
</script>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

  const supabase = createClient(
    'https://fwslmbzfukriibnkpzou.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3c2xtYnpmdWtyaWlibmtwem91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4NTcxMDcsImV4cCI6MjA2NDQzMzEwN30.juWK3T16_-LGHPii7xLp92Tt5TAZKN3IcZVn6nR8cBA'
  );

  // Make supabase available globally
  window.supabaseClient = supabase;

  // Add error handling for Supabase initialization
  if (!supabase) {
    console.error('Failed to initialize Supabase client');
  }

  const taskbarNav = document.getElementById('taskbar-nav');
  const taskbarAuth = document.getElementById('taskbar-auth');
  const taskbarVip = document.getElementById('taskbar-vip');

  // Global state tracking
  let currentVIPStatus = false;
  let currentUser = null;
  let currentUsername = null;
  let isInitialized = false;
  let renderingInProgress = false;

  // State synchronization helper
  function syncAccessState() {
    const hasVIPAccess = localStorage.getItem('vipAccess') === 'true';
    const hasFreeAccess = localStorage.getItem('freeAccess') === 'true';
    const isAgeVerified = localStorage.getItem('ageVerified') === 'true';
    
    // Update UI to match localStorage state
    if (window.renderVip) {
      window.renderVip();
    }
    
    // Update access gate visibility
    const accessChoiceGate = document.getElementById('access-choice-gate');
    if (accessChoiceGate) {
      if ((hasVIPAccess || hasFreeAccess) && isAgeVerified) {
        accessChoiceGate.classList.remove('show');
      } else {
        accessChoiceGate.classList.add('show');
      }
    }
  }

  // Make global variables accessible
  window.currentUser = null;
  window.currentUsername = null;

  function toggleDropdown(dropdown) {
    dropdown.style.display = (dropdown.style.display === 'flex') ? 'none' : 'flex';
  }

  async function checkVIPStatus(userId) {
    // Check local VIP access first
    const localVIP = localStorage.getItem('vipAccess') === 'true';
    
    if (localVIP) return true;
    if (!userId) return false;

    try {
      const { data: user, error } = await supabase
        .from('users')
        .select('is_vip')
        .eq('id', userId)
        .single();

      if (error) {
        console.error('Error fetching VIP status:', error);
        return false;
      }

      // If user is VIP in database, grant local access too
      if (user?.is_vip) {
        localStorage.setItem('vipAccess', 'true');
        localStorage.setItem('ageVerified', 'true');
      }

      return user?.is_vip ?? false;
    } catch (error) {
      console.error('Exception in checkVIPStatus:', error);
      return false;
    }
  }

  function renderNav() {
    if (renderingInProgress) return;
    taskbarNav.innerHTML = '';

    // User Games (always available)
    const userGamesBtn = document.createElement('button');
    userGamesBtn.textContent = 'User Games';
    userGamesBtn.addEventListener('click', () => window.location.href = 'user-games.html');
    taskbarNav.appendChild(userGamesBtn);

    // User Video (always available)
    const userVideoBtn = document.createElement('button');
    userVideoBtn.textContent = 'User Video';
    userVideoBtn.addEventListener('click', () => window.location.href = 'user-videos.html');
    taskbarNav.appendChild(userVideoBtn);

    // User Art (always available)
    const userArtBtn = document.createElement('button');
    userArtBtn.textContent = 'User Art';
    userArtBtn.addEventListener('click', () => window.location.href = 'user-art.html');
    taskbarNav.appendChild(userArtBtn);

    // User Profiles (always available)
    const userProfilesBtn = document.createElement('button');
    userProfilesBtn.textContent = 'User Profiles';
    userProfilesBtn.addEventListener('click', () => window.location.href = 'user-profiles.html');
    taskbarNav.appendChild(userProfilesBtn);
  }

  async function renderVip() {
    if (renderingInProgress) return;
    
    taskbarVip.innerHTML = '';
    
    const hasVIPAccess = localStorage.getItem('vipAccess') === 'true';
    const hasFreeAccess = localStorage.getItem('freeAccess') === 'true';
    
    if (hasVIPAccess || currentVIPStatus) {
      const vipStatus = document.createElement('div');
      vipStatus.className = 'vip-status';
      vipStatus.innerHTML = '⭐ VIP Member';
      taskbarVip.appendChild(vipStatus);
    } else if (hasFreeAccess) {
      const freeStatus = document.createElement('div');
      freeStatus.className = 'free-status';
      freeStatus.innerHTML = '🆓 Free Member';
      taskbarVip.appendChild(freeStatus);

      // Add upgrade button for free users
      const upgradeBtn = document.createElement('button');
      upgradeBtn.textContent = 'Upgrade to VIP';
      upgradeBtn.style.background = 'linear-gradient(45deg, #2ecc71, #27ae60)';
      upgradeBtn.addEventListener('click', () => {
        // Show access gate with VIP process
        const accessGate = document.getElementById('access-choice-gate');
        if (accessGate) {
          // If user is already logged in, skip to payment step
          if (currentUser) {
            // Set the gate user
            gateUser = currentUser;
            
            // Hide options and show VIP process
            document.querySelector('.access-options').style.display = 'none';
            document.getElementById('vip-process').style.display = 'block';
            document.getElementById('back-to-options').style.display = 'inline-block';
            
            // Mark login as completed and show payment step
            const loginStep = document.getElementById('login-step');
            const paymentStep = document.getElementById('payment-step');
            const loginStatus = document.getElementById('login-status');
            
            loginStep.classList.add('completed');
            document.getElementById('github-login-btn').style.display = 'none';
            loginStatus.classList.add('show');
            paymentStep.style.display = 'block';
            
            // Initialize PayPal
            setTimeout(() => {
              initVIPPayPal();
            }, 500);
            
            accessGate.classList.add('show');
          } else {
            // User not logged in, show normal flow
            gateUser = null; // Ensure gateUser is reset
            document.querySelector('.access-options').style.display = 'grid';
            document.getElementById('vip-process').style.display = 'none';
            document.getElementById('back-to-options').style.display = 'none';
            accessGate.classList.add('show');
          }
        }
      });
      taskbarVip.appendChild(upgradeBtn);
    } else {
      const noAccessNote = document.createElement('div');
      noAccessNote.style.color = '#888';
      noAccessNote.style.fontSize = '0.8rem';
      noAccessNote.textContent = 'Choose Access Level';
      taskbarVip.appendChild(noAccessNote);
    }
  }

  async function renderAuth() {
    if (renderingInProgress) return;
    renderingInProgress = true;

    try {
      const { data: { session } } = await supabase.auth.getSession();
      
      taskbarAuth.innerHTML = '';
      
      const existingDropdown = document.getElementById('user-dropdown');
      if (existingDropdown) {
        existingDropdown.remove();
      }

      if (session?.user) {
        currentUser = session.user;
        window.currentUser = currentUser;
        
        // Get username from metadata
        currentUsername = session.user.user_metadata?.user_name || 
                         session.user.user_metadata?.preferred_username;
        
        if (!currentUsername) {
          // Fallback: Get from game submissions
          try {
            const { data: gameData } = await supabase
              .from('game_submissions')
              .select('github_user')
              .eq('user_id', currentUser.id)
              .limit(1);
            
            if (gameData && gameData.length > 0) {
              currentUsername = gameData[0].github_user;
            } else {
              // Final fallback to email
              currentUsername = currentUser.email;
            }
          } catch (error) {
            console.error('Error getting username:', error);
            currentUsername = currentUser.email;
          }
        }
        
        window.currentUsername = currentUsername;
        
        currentVIPStatus = await checkVIPStatus(session.user.id);
        
        // Notify VIP gate if it's showing and user isn't already set
        const accessGate = document.getElementById('access-choice-gate');
        if (accessGate && accessGate.classList.contains('show') && !gateUser) {
          window.dispatchEvent(new CustomEvent('vip-user-logged-in', { detail: session.user }));
        }
        
        const { user_metadata } = session.user;
        const name = user_metadata.full_name || 'GitHub User';
        const avatar = user_metadata.avatar_url || '';

        const userInfo = document.createElement('div');
        userInfo.id = 'user-info';

        if (avatar) {
          const img = document.createElement('img');
          img.src = avatar;
          img.alt = name;
          userInfo.appendChild(img);
        }

        const nameDiv = document.createElement('div');
        nameDiv.innerHTML = `
          <strong style="
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background-color: #ff69b4;
            color: #1e1b2e;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            box-shadow: 0 0 10px #ff8edb;
          " title="Click for options">
            ${name}
            <span style="font-size: 1.2rem; margin-left: 4px;">▾</span>
          </strong>
        `;
        userInfo.appendChild(nameDiv);
        taskbarAuth.appendChild(userInfo);

        const dropdown = document.createElement('div');
        dropdown.id = 'user-dropdown';

        const myPageBtn = document.createElement('button');
        myPageBtn.textContent = 'My Page'; // FIXED: Added missing text content
        myPageBtn.onclick = async () => {
          dropdown.style.display = 'none';
          try {
            const { data: { user }, error: userError } = await supabase.auth.getUser();
            if (userError || !user) {
              console.error('Unable to get user:', userError);
              return;
            }

            const { data, error } = await supabase
              .from('game_submissions')
              .select('id')
              .eq('user_id', user.id)
              .limit(1);

            if (error) {
              console.error('Error checking submission:', error);
              return;
            }

            if (data && data.length > 0 && currentUsername) {
              window.location.href = `user.html?user=${currentUsername}`;
            } else {
              window.location.href = 'dashboard.html';
            }
          } catch (error) {
            console.error('Error in myPageBtn click:', error);
          }
        };

        const dashboardBtn = document.createElement('button');
        dashboardBtn.textContent = 'Dashboard';
        dashboardBtn.onclick = () => {
          dropdown.style.display = 'none';
          window.location.href = 'dashboard.html';
        };

        const logoutBtn = document.createElement('button');
        logoutBtn.textContent = 'Logout';
        logoutBtn.onclick = async () => {
          try {
            // Clear message update interval
            if (messageUpdateInterval) {
              clearInterval(messageUpdateInterval);
              messageUpdateInterval = null;
            }
            
            await supabase.auth.signOut();
            
            // Clear all access data on logout
            localStorage.removeItem('vipAccess');
            localStorage.removeItem('freeAccess');
            localStorage.removeItem('ageVerified');
            localStorage.removeItem('vipSubscriptionId');
            localStorage.removeItem('vipActivatedAt');
            
            currentUser = null;
            currentUsername = null;
            window.currentUser = null;
            window.currentUsername = null;
            currentVIPStatus = false;
            
            // Hide message notifications
            const taskbarMessages = document.getElementById('taskbar-messages');
            if (taskbarMessages) {
              taskbarMessages.style.display = 'none';
            }
            
            // Show access gate again after logout
            const accessChoiceGate = document.getElementById('access-choice-gate');
            if (accessChoiceGate) {
              accessChoiceGate.classList.add('show');
            }
            
            window.location.reload();
          } catch (error) {
            console.error('Error during logout:', error);
          }
        };

        dropdown.appendChild(myPageBtn);
        dropdown.appendChild(dashboardBtn);
        dropdown.appendChild(logoutBtn);

        taskbarAuth.appendChild(dropdown);
        userInfo.addEventListener('click', () => toggleDropdown(dropdown));

        // Start message notifications for logged-in users
        updateMessageNotifications();
        
        // Set up periodic message checking
        if (messageUpdateInterval) {
          clearInterval(messageUpdateInterval);
          messageUpdateInterval = null;
        }
        messageUpdateInterval = setInterval(updateMessageNotifications, 30000); // Check every 30 seconds

      } else {
        currentUser = null;
        currentUsername = null;
        window.currentUser = null;
        window.currentUsername = null;
        currentVIPStatus = false;
        
        // Clear message update interval
        if (messageUpdateInterval) {
          clearInterval(messageUpdateInterval);
          messageUpdateInterval = null;
        }
        
        // Hide message notifications
        const taskbarMessages = document.getElementById('taskbar-messages');
        if (taskbarMessages) {
          taskbarMessages.style.display = 'none';
        }
        
        const loginBtn = document.createElement('button');
        loginBtn.textContent = 'Login with GitHub';
        loginBtn.addEventListener('click', () => {
          supabase.auth.signInWithOAuth({ provider: 'github' });
        });
        taskbarAuth.appendChild(loginBtn);
      }
    } catch (error) {
      console.error('Error in renderAuth:', error);
    } finally {
      renderingInProgress = false;
    }
  }

  // Global click handler for dropdowns
  let globalClickHandlerAdded = false;
  
  function addGlobalClickHandler() {
    if (!globalClickHandlerAdded) {
      document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('user-dropdown');
        const userInfo = document.getElementById('user-info');
        const messageDropdown = document.getElementById('message-preview-dropdown');
        const messagesButton = document.getElementById('messages-button');
        
        // Handle user dropdown
        if (dropdown && userInfo && !userInfo.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.style.display = 'none';
        }
        
        // Handle message dropdown (ensure consistency)
        if (messageDropdown && messagesButton && 
            !messageDropdown.contains(e.target) && !messagesButton.contains(e.target)) {
          messageDropdown.classList.remove('show');
        }
      });
      globalClickHandlerAdded = true;
    }
  }

  // Initialize everything
  async function initializeApp() {
    if (isInitialized) return;
    isInitialized = true;

    try {
      renderNav();
      await renderAuth();
      await renderVip();
      addGlobalClickHandler();
      initMessageNotifications();

      let authChangeTimeout;
      supabase.auth.onAuthStateChange(async (event, session) => {
        clearTimeout(authChangeTimeout);
        authChangeTimeout = setTimeout(async () => {
          if (!renderingInProgress) {
            await renderAuth();
            await renderVip();
            renderNav(); // Re-render nav to update VIP features
          }
        }, 100);
      });

    } catch (error) {
      console.error('Error initializing app:', error);
    }
  }

  // Make render functions globally accessible
  window.renderVip = renderVip;
  window.renderAuth = renderAuth;
  window.renderNav = renderNav;

  // Start the app when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApp);
  } else {
    initializeApp();
  }
</script>

</body>
</html>
  
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>User Content - BrownDogGames</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Rubik+Mono+One&display=swap');
    * { box-sizing: border-box; }
    body {
      font-family: 'Rubik Mono One', sans-serif;
      background-color: #1b1b2e;
      background-image: linear-gradient(135deg, #361c3e, #1a1328);
      color: #fefefe;
      margin: 0; padding: 20px;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
    }
    h1, h2 {
      color: #ff4f9f;
      text-shadow: 2px 2px 0 #ff4f9f;
      margin: 1rem 0;
      width: 100%;
      max-width: 800px;
    }
    .back-link {
      align-self: flex-start;
      background-color: #ff4f9f;
      color: #1b1b2e;
      text-decoration: none;
      font-size: 0.9rem;
      padding: 10px 16px;
      border-radius: 999px;
      font-weight: bold;
      transition: background-color 0.2s ease;
      margin-bottom: 1rem;
      max-width: 800px;
      display: inline-block;
    }
    .vip-badge {
      display: inline-block;
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      color: #1b1b2e;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: bold;
      margin-left: 15px;
      animation: glow 2s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from { box-shadow: 0 0 5px #ffd700; }
      to { box-shadow: 0 0 20px #ffd700, 0 0 30px #ffd700; }
    }

    .content-section {
      max-width: 800px;
      width: 100%;
      margin-bottom: 40px;
    }

    .content-container {
      display: grid;
      gap: 20px;
      justify-items: center;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      width: 100%;
    }

    .card {
      background: linear-gradient(145deg, #3a2147, #241834);
      border: 2px solid #ff4f9f;
      border-radius: 16px;
      padding: 20px;
      width: 100%;
      box-sizing: border-box;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 79, 159, 0.1), transparent);
      transition: left 0.6s ease;
    }

    .card:hover::before {
      left: 100%;
    }

    .card:hover {
      border-color: #ff82ba;
      box-shadow: 0 12px 40px rgba(255, 79, 159, 0.3), 0 0 20px rgba(255, 130, 186, 0.2);
      transform: translateY(-8px) scale(1.02);
    }

    .card.selected {
      border-color: #ff82ba;
      box-shadow: 0 0 30px #ff4f9f, inset 0 0 20px rgba(255, 79, 159, 0.1);
      transform: scale(1.05);
    }

    .title {
      margin-top: 0;
      margin-bottom: 0.8rem;
      text-align: center;
      font-size: 1.1rem;
      background: linear-gradient(135deg, #ff4f9f, #ff82ba);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: none;
      font-weight: bold;
      position: relative;
      z-index: 2;
    }

    .desc {
      color: #e0e0e0;
      margin: 0.5rem 0 1.2rem 0;
      min-height: 2rem;
      text-align: center;
      font-size: 0.9rem;
      line-height: 1.4;
      opacity: 0.9;
      position: relative;
      z-index: 2;
      display: block;
      width: 100%;
      font-style: italic;
    }

    .image-container {
      position: relative;
      width: 100%;
      margin-bottom: 10px;
    }

    .thumbnail {
      width: 100%;
      max-height: 160px;
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 15px;
      display: block;
      transition: transform 0.3s ease, filter 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
      position: relative;
      z-index: 2;
    }

    .card:hover .thumbnail {
      transform: scale(1.05);
      filter: brightness(1.1) contrast(1.1);
    }

    .fullscreen-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255, 79, 159, 0.9);
      color: #ffffff;
      border: none;
      border-radius: 6px;
      padding: 6px 8px;
      font-size: 0.7rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 3;
      font-family: 'Rubik Mono One', sans-serif;
      opacity: 0;
      transform: translateY(-10px);
    }

    .image-container:hover .fullscreen-btn {
      opacity: 1;
      transform: translateY(0);
    }

    .fullscreen-btn:hover {
      background: rgba(255, 130, 186, 1);
      transform: scale(1.1);
    }

    .video-player {
      width: 100%;
      border-radius: 12px;
      margin-bottom: 15px;
      background-color: black;
      min-height: 220px;
      max-width: 100%;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
      transition: transform 0.3s ease;
      position: relative;
      z-index: 2;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ff82ba;
      font-size: 1rem;
      text-align: center;
      cursor: pointer;
    }

    .video-player:hover {
      transform: scale(1.02);
      background-color: #1a1328;
    }

    .video-player.fullscreen-ready {
      background: linear-gradient(45deg, #3a2147, #241834);
      border: 2px dashed #ff4f9f;
    }

    .video-embed {
      width: 100%;
      border-radius: 12px;
      margin-bottom: 15px;
      background-color: black;
      min-height: 220px;
      max-width: 100%;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
      transition: transform 0.3s ease;
      position: relative;
      z-index: 2;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ff82ba;
      font-size: 1rem;
      text-align: center;
      cursor: pointer;
    }

    .video-embed:hover {
      transform: scale(1.02);
      background-color: #1a1328;
    }

    .video-embed.fullscreen-ready {
      background: linear-gradient(45deg, #3a2147, #241834);
      border: 2px dashed #ff4f9f;
    }

    .play-link {
      display: inline-block;
      background: linear-gradient(135deg, #ff4f9f, #ff1493);
      color: #ffffff;
      padding: 12px 20px;
      border-radius: 25px;
      text-decoration: none;
      font-weight: bold;
      font-size: 0.9rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      margin-top: auto;
      box-shadow: 0 4px 15px rgba(255, 79, 159, 0.3);
      position: relative;
      z-index: 2;
      overflow: hidden;
    }

    .play-link::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .play-link:hover::before {
      left: 100%;
    }

    .play-link:hover { 
      background: linear-gradient(135deg, #ff82ba, #ff69b4);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 79, 159, 0.4);
    }

    /* Main Like Section Styles */
    .main-content {
      max-width: 600px;
      width: 100%;
      background: linear-gradient(145deg, #3a2147, #241834);
      border: 2px solid #ff4f9f;
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
      margin-bottom: 40px;
    }

    .main-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 79, 159, 0.1), transparent);
      transition: left 0.6s ease;
    }

    .main-content:hover::before {
      left: 100%;
    }

    #like-status {
      margin: 20px 0 30px;
      font-size: 1.2rem;
      color: #e0e0e0;
      line-height: 1.4;
      position: relative;
      z-index: 2;
      opacity: 0.9;
      font-family: 'Rubik Mono One', sans-serif;
    }

    #main-like-btn {
      display: inline-block;
      padding: 12px 20px;
      background: linear-gradient(135deg, #ff4f9f, #ff1493);
      color: #ffffff;
      font-size: 1rem;
      font-weight: bold;
      font-family: 'Rubik Mono One', sans-serif;
      border-radius: 25px;
      text-decoration: none;
      border: none;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 15px rgba(255, 79, 159, 0.3);
      position: relative;
      z-index: 2;
      overflow: hidden;
      margin-top: auto;
    }

    #main-like-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    #main-like-btn:hover::before {
      left: 100%;
    }

    #main-like-btn:disabled {
      background: linear-gradient(135deg, #666, #444);
      cursor: not-allowed;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    #main-like-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #ff82ba, #ff69b4);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 79, 159, 0.4);
    }

    /* Video Like System Styles */
    .video-like-section {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255, 79, 159, 0.3);
      position: relative;
      z-index: 2;
    }

    .video-like-btn {
      background: linear-gradient(135deg, #ff4f9f, #ff1493);
      color: #ffffff;
      border: none;
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 0.8rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Rubik Mono One', sans-serif;
      display: flex;
      align-items: center;
      gap: 4px;
      box-shadow: 0 2px 8px rgba(255, 79, 159, 0.3);
    }

    .video-like-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #ff82ba, #ff69b4);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 79, 159, 0.4);
    }

    .video-like-btn:disabled {
      background: linear-gradient(135deg, #666, #444);
      cursor: not-allowed;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .video-like-btn.liked {
      background: linear-gradient(135deg, #ff69b4, #ff1493);
      animation: pulse 0.3s ease-in-out;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .video-like-count {
      color: #ff82ba;
      font-size: 0.8rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .video-login-prompt {
      font-size: 0.7rem;
      color: #ddd;
      text-align: center;
      margin-top: 8px;
      opacity: 0.8;
    }

    /* Fullscreen video placeholder */
    .fullscreen-placeholder {
      padding: 40px 20px;
      text-align: center;
      color: #ff82ba;
      font-size: 1rem;
      line-height: 1.5;
      border: 2px dashed #ff4f9f;
      border-radius: 12px;
      background: linear-gradient(45deg, rgba(255, 79, 159, 0.1), rgba(255, 130, 186, 0.1));
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      width: 100%;
      min-height: 220px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .fullscreen-placeholder:hover {
      background: linear-gradient(45deg, rgba(255, 79, 159, 0.2), rgba(255, 130, 186, 0.2));
      border-color: #ff82ba;
      transform: scale(1.02);
      box-shadow: 0 4px 15px rgba(255, 79, 159, 0.3);
    }

    .fullscreen-placeholder::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.6s ease;
    }

    .fullscreen-placeholder:hover::before {
      left: 100%;
    }

    .fullscreen-placeholder .play-icon {
      font-size: 2.5rem;
      margin-bottom: 12px;
      display: block;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }

    /* Platform-specific placeholder styling */
    .fullscreen-placeholder[data-platform="youtube"] {
      background: linear-gradient(45deg, rgba(255, 0, 0, 0.1), rgba(255, 79, 159, 0.1));
      border-color: #ff0000;
    }

    .fullscreen-placeholder[data-platform="youtube"]:hover {
      background: linear-gradient(45deg, rgba(255, 0, 0, 0.2), rgba(255, 79, 159, 0.2));
      border-color: #ff0000;
      box-shadow: 0 4px 15px rgba(255, 0, 0, 0.3);
    }

    .fullscreen-placeholder[data-platform="vimeo"] {
      background: linear-gradient(45deg, rgba(26, 183, 234, 0.1), rgba(255, 79, 159, 0.1));
      border-color: #1ab7ea;
    }

    .fullscreen-placeholder[data-platform="vimeo"]:hover {
      background: linear-gradient(45deg, rgba(26, 183, 234, 0.2), rgba(255, 79, 159, 0.2));
      border-color: #1ab7ea;
      box-shadow: 0 4px 15px rgba(26, 183, 234, 0.3);
    }

    .fullscreen-placeholder[data-platform="tiktok"] {
      background: linear-gradient(45deg, rgba(254, 44, 85, 0.1), rgba(255, 79, 159, 0.1));
      border-color: #fe2c55;
    }

    .fullscreen-placeholder[data-platform="tiktok"]:hover {
      background: linear-gradient(45deg, rgba(254, 44, 85, 0.2), rgba(255, 79, 159, 0.2));
      border-color: #fe2c55;
      box-shadow: 0 4px 15px rgba(254, 44, 85, 0.3);
    }

    .fullscreen-placeholder[data-platform="twitter"] {
      background: linear-gradient(45deg, rgba(29, 161, 242, 0.1), rgba(255, 79, 159, 0.1));
      border-color: #1da1f2;
    }

    .fullscreen-placeholder[data-platform="twitter"]:hover {
      background: linear-gradient(45deg, rgba(29, 161, 242, 0.2), rgba(255, 79, 159, 0.2));
      border-color: #1da1f2;
      box-shadow: 0 4px 15px rgba(29, 161, 242, 0.3);
    }

    #chat-container {
      max-width: 800px;
      width: 100%;
      border: 2px solid #ff4f9f;
      border-radius: 12px;
      background-color: #2f1a39;
      padding: 20px;
      box-sizing: border-box;
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      height: 450px;
      overflow: hidden;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 20px;
      padding-right: 10px;
    }
    #messages div { margin-bottom: 12px; }
    #messages strong { color: #ff82ba; }

    #chat-form {
      display: flex;
      gap: 10px;
    }
    #msg-input {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 2px solid #ff4f9f;
      background-color: #2f1a39;
      color: #fff;
    }
    button {
      background-color: #ff4f9f;
      color: #1b1b2e;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    button:hover { background-color: #ff82ba; }

    .no-content {
      font-size: 1.1rem;
      text-align: center;
      color: #ddd;
      margin-top: 2rem;
      font-style: italic;
      background-color: #2f1a39;
      padding: 1rem;
      border-radius: 10px;
    }

    .vip-extras-section {
      background: linear-gradient(135deg, #2f1a39, #3d2147);
      border: 2px solid #ffd700;
      border-radius: 12px;
      padding: 2rem;
      margin: 2rem 0;
      max-width: 800px;
      width: 100%;
    }

    .vip-extras-section h3 {
      color: #ffd700;
      margin-bottom: 1.5rem;
      text-shadow: 0 0 10px #ffd700;
    }

    .page-owner-info {
      background: rgba(255, 215, 0, 0.1);
      border: 1px solid #ffd700;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 2rem;
      text-align: center;
      color: #ff82ba;
    }

    .page-owner-info .owner-name {
      color: #ffd700;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .extras-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .vip-extras-container {
      background: linear-gradient(135deg, #2f1a39, #3d2147);
      border: 2px solid #ffd700;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .vip-extras-container h2 {
      color: #ffd700;
      text-shadow: 0 0 10px #ffd700;
      margin-bottom: 1rem;
    }

    .vip-extras-description {
      color: #ff82ba;
      margin-bottom: 2rem;
      font-size: 1.1rem;
    }

    .button-link {
      display: inline-block;
      background-color: #ff4f9f;
      color: #1b1b2e;
      font-weight: bold;
      text-decoration: none;
      border-radius: 8px;
      padding: 12px 24px;
      margin: 0.5rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
      font-family: inherit;
      border: none;
    }

    .button-link:hover {
      background-color: #ff82ba;
    }

    .vip-badges-section {
      background: linear-gradient(135deg, #2f1a39, #3d2147);
      border: 2px solid #ffd700;
      border-radius: 12px;
      padding: 2rem;
      margin: 2rem 0;
      max-width: 800px;
      width: 100%;
      display: none;
    }

    .vip-badges-section.show {
      display: block;
    }

    .vip-badges-section h3 {
      color: #ffd700;
      margin-bottom: 1.5rem;
      text-shadow: 0 0 10px #ffd700;
    }

    .badges-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .badge-item {
      background-color: #1b1b2e;
      border: 2px solid #ffd700;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .badge-item:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
    }

    .badge-item.selected {
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      color: #1b1b2e;
    }

    .badge-emoji {
      font-size: 2rem;
      display: block;
      margin-bottom: 0.5rem;
    }

    .badge-name {
      font-size: 0.8rem;
      font-weight: bold;
    }

    .extra-card {
      background-color: #1b1b2e;
      border: 2px solid #ffd700;
      border-radius: 12px;
      padding: 1rem;
      transition: all 0.3s ease;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .extra-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
      border-color: #ffed4e;
    }

    .extra-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 1rem;
    }

    .extra-type {
      background-color: #ff4f9f;
      color: #1b1b2e;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: bold;
    }

    .extra-title {
      color: #ffd700;
      margin: 0 0 0.5rem 0;
      font-size: 1.1rem;
      text-align: center;
    }

    .extra-description {
      color: #ff82ba;
      margin: 0 0 1rem 0;
      font-size: 0.9rem;
      text-align: center;
      flex-grow: 1;
    }

    .extra-footer {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: auto;
      padding-top: 1rem;
      border-top: 1px solid rgba(255, 79, 159, 0.3);
    }

    .extra-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      width: 100%;
    }

    .extra-creator {
      font-size: 0.8rem;
      color: #888;
      flex: 1;
      text-align: center;
    }

    .like-section {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
    }

    .like-btn {
      background: none;
      border: 2px solid #ff4f9f;
      color: #ff4f9f;
      border-radius: 20px;
      padding: 6px 12px;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.8rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.3rem;
      white-space: nowrap;
    }

    .like-btn:hover:not(:disabled) {
      background: #ff4f9f;
      color: #1b1b2e;
      transform: scale(1.05);
    }

    .like-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .like-btn.liked {
      background: #ff4f9f;
      color: #1b1b2e;
      border-color: #ff4f9f;
    }

    .like-count {
      color: #ffd700;
      font-weight: bold;
      font-size: 0.9rem;
      min-width: 20px;
      text-align: center;
    }

    .extra-link {
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      color: #1b1b2e;
      text-decoration: none;
      padding: 10px 16px;
      border-radius: 6px;
      font-weight: bold;
      font-size: 0.9rem;
      transition: all 0.2s ease;
      text-align: center;
      display: block;
      width: 100%;
      margin-top: 1rem;
    }

    .extra-link:hover {
      background: linear-gradient(45deg, #ffed4e, #ffd700);
      transform: translateY(-1px);
    }

    .add-extra-section {
      background-color: #1b1b2e;
      border: 2px solid #ffd700;
      border-radius: 8px;
      padding: 1.5rem;
      margin-top: 2rem;
      display: none;
    }

    .add-extra-section.show {
      display: block;
    }

    .add-extra-section h4 {
      color: #ffd700;
      margin: 0 0 1rem 0;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      color: #ff82ba;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 10px;
      border: 2px solid #ff4f9f;
      border-radius: 6px;
      background-color: #2f1a39;
      color: #fff;
      font-family: inherit;
      font-size: 0.9rem;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #ffd700;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    }

    .form-group textarea {
      resize: vertical;
      height: 80px;
    }

    .message {
      margin-bottom: 12px;
      font-size: 0.9rem;
      padding: 8px;
      border-radius: 4px;
    }

    .message.vip {
      background: linear-gradient(90deg, rgba(255, 215, 0, 0.1), rgba(255, 79, 159, 0.1));
      border-left: 3px solid #ffd700;
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.3rem;
    }

    .username {
      font-weight: bold;
      color: #ff82ba;
    }

    .username.vip {
      color: #ffd700;
      text-shadow: 0 0 5px #ffd700;
    }

    .user-badge {
      font-size: 1rem;
    }

    .message-content {
      color: #fefefe;
    }

    .message-time {
      font-size: 0.7rem;
      color: #888;
      margin-left: auto;
    }

    #msg-input.vip {
      border-color: #ffd700;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    }

    .vip-button {
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      color: #1b1b2e;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
    }

    .vip-button:hover {
      background: linear-gradient(45deg, #ffed4e, #ffd700);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
    }

    @media (max-width: 768px) {
      .main-content {
        padding: 25px;
      }
      
      #main-like-btn {
        padding: 10px 16px;
        font-size: 0.8rem;
      }

      .video-like-section {
        flex-direction: column;
        gap: 8px;
        align-items: center;
      }
      
      .video-like-btn {
        font-size: 0.7rem;
        padding: 4px 8px;
      }
      
      .badges-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
  </style>
</head>
<body>

  <a href="user-videos.html" class="back-link">⬅️ Back to All Users</a>
  <h1 id="pageTitle">User Content<span id="vipBadge" class="vip-badge" style="display: none;">👑 VIP</span></h1>

  <section class="content-section" id="like-section">
    <div class="main-content">
      <p id="like-status">Loading...</p>
      <button id="main-like-btn">Like</button>
    </div>
  </section>

  <section class="content-section" id="videos-section">
    <h2>Videos</h2>
    <div id="videos" class="content-container">Loading videos...</div>
  </section>

  <section class="vip-extras-section" id="vip-extras-section">
    <h3>👑 VIP Community Extras</h3>
    <div class="page-owner-info">
      <p>Exclusive content shared for <span class="owner-name" id="extras-username"></span></p>
    </div>
    
    <div id="extrasContainer" class="extras-grid">
      <div class="loading">Loading VIP extras...</div>
    </div>

    <div id="addExtraSection" class="add-extra-section">
      <h4>➕ Share New VIP Extra</h4>
      <form id="extraForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="extraTitle">Title *</label>
            <input type="text" id="extraTitle" required placeholder="e.g., Bonus Content Pack">
          </div>
          <div class="form-group">
            <label for="extraType">Type *</label>
            <select id="extraType" required>
              <option value="">Select type...</option>
              <option value="download">Download</option>
              <option value="link">External Link</option>
              <option value="code">Cheat Code</option>
              <option value="beta">Beta Access</option>
              <option value="mod">Mod/Asset</option>
              <option value="guide">Guide/Tutorial</option>
              <option value="video">Bonus Video</option>
              <option value="image">Image Pack</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="extraDescription">Description *</label>
          <textarea id="extraDescription" required placeholder="Describe what this extra contains..."></textarea>
        </div>
        <div class="form-group">
          <label for="extraUrl">URL/Link *</label>
          <input type="url" id="extraUrl" required placeholder="https://...">
        </div>
        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
          <button type="submit" class="button-link vip-button">Add Extra</button>
          <button type="button" class="button-link" onclick="toggleAddExtra()">Cancel</button>
        </div>
      </form>
    </div>

    <button id="addExtraBtn" class="button-link vip-button" style="display: none;" onclick="toggleAddExtra()">➕ Add VIP Extra</button>
  </section>

  <div id="vipBadgesSection" class="vip-badges-section">
    <h3>👑 VIP Badges</h3>
    <p style="color: #ff82ba; margin-bottom: 1.5rem;">Choose your VIP badge that appears in chat:</p>
    
    <div class="badges-grid">
      <div class="badge-item" data-badge="👑" data-name="Crown">
        <span class="badge-emoji">👑</span>
        <span class="badge-name">Crown</span>
      </div>
      <div class="badge-item" data-badge="💎" data-name="Diamond">
        <span class="badge-emoji">💎</span>
        <span class="badge-name">Diamond</span>
      </div>
      <div class="badge-item" data-badge="🍆" data-name="Eggplant">
        <span class="badge-emoji">🍆</span>
        <span class="badge-name">Eggplant</span>
      </div>
      <div class="badge-item" data-badge="🐾" data-name="Paws">
        <span class="badge-emoji">🐾</span>
        <span class="badge-name">Paws</span>
      </div>
      <div class="badge-item" data-badge="💦" data-name="Splash">
        <span class="badge-emoji">💦</span>
        <span class="badge-name">Splash</span>
      </div>
      <div class="badge-item" data-badge="🎮" data-name="Gaming">
        <span class="badge-emoji">🎮</span>
        <span class="badge-name">Gaming</span>
      </div>
    </div>
  </div>

  <section id="chat-container">
    <h2>Chat with <span id="chat-username">Loading...</span></h2>
    <div id="game-id-container" style="margin-bottom: 1.5rem;">
      <label id="game-id-label" for="game-id" style="font-size: 1.1rem; color: #ff4f9f; display: block; margin-bottom: 5px;">Game ID:</label>
      <input type="text" id="game-id" readonly style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ff4f9f; border-radius: 8px; background-color: #1b1b2e; color: #fff; font-family: inherit;" />
    </div>
    <div id="messages"><p>Loading messages...</p></div>
    <form id="chat-form">
      <input type="text" id="msg-input" placeholder="Type a message..." required autocomplete="off" />
      <button type="submit">Send</button>
    </form>
  </section>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(
    'https://fwslmbzfukriibnkpzou.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3c2xtYnpmdWtyaWlibmtwem91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4NTcxMDcsImV4cCI6MjA2NDQzMzEwN30.juWK3T16_-LGHPii7xLp92Tt5TAZKN3IcZVn6nR8cBA'
  );

  const pageTitle = document.getElementById('pageTitle');
  const videosContainer = document.getElementById('videos');
  const chatContainer = document.getElementById('chat-container');
  const messagesDiv = document.getElementById('messages');
  const form = document.getElementById('chat-form');
  const msgInput = document.getElementById('msg-input');
  const chatHeading = document.getElementById('chat-username');

  const urlParams = new URLSearchParams(window.location.search);
  const username = urlParams.get('user') || '';

  let currentUser = null;
  let totalLikes = 0;
  let userHasLiked = false;
  let videoLikes = {};
  let userLikedVideos = new Set();
  let isVipUser = false;
  let selectedBadge = '👑';
  let activeVideoElements = new Map(); // Track active video elements for cleanup

  // Get current user
  async function getCurrentUser() {
    const result = await supabase.auth.getUser();
    if (result.error || !result.data.user) return null;
    return result.data.user;
  }

  // Check if user is VIP
  async function checkVipStatus(user) {
    if (!user) return false;
    
    try {
      console.log('Checking VIP status for user:', user.id);
      
      const { data: userData, error } = await supabase
        .from('users')
        .select('is_vip')
        .eq('id', user.id)
        .single();

      if (error) {
        console.error('Error checking VIP status:', error);
        return false;
      }

      console.log('User data from database:', userData);
      const isVip = userData?.is_vip === true;
      console.log('Is VIP result:', isVip);
      
      return isVip;
    } catch (error) {
      console.error('Error in checkVipStatus:', error);
      return false;
    }
  }

  // Get likes for a specific extra
  async function getExtraLikes(extraId) {
    try {
      const { count, error } = await supabase
        .from('vip_page_views')
        .select('*', { count: 'exact', head: true })
        .eq('username', `extra_${extraId}`);

      if (error) {
        console.error('Error getting likes:', error);
        return 0;
      }
      return count || 0;
    } catch (error) {
      console.error('Error getting extra likes:', error);
      return 0;
    }
  }

  // Check if current user has liked an extra
  async function hasUserLikedExtra(extraId) {
    if (!currentUser) return false;

    try {
      const { data, error } = await supabase
        .from('vip_page_views')
        .select('user_id')
        .eq('username', `extra_${extraId}`)
        .eq('user_id', currentUser.id)
        .single();

      if (error && error.code !== 'PGRST116') {
        console.error('Error checking user like:', error);
      }
      return !error && data;
    } catch (error) {
      console.error('Error in hasUserLikedExtra:', error);
      return false;
    }
  }

  // Toggle like for an extra
  async function toggleExtraLike(extraId) {
    if (!currentUser) {
      alert('Please login to like extras');
      return null;
    }

    const userId = currentUser.id;
    const extraUsername = `extra_${extraId}`;

    try {
      // Check if already liked
      const { data: existingLike, error: checkError } = await supabase
        .from('vip_page_views')
        .select('user_id')
        .eq('username', extraUsername)
        .eq('user_id', userId)
        .single();

      if (existingLike) {
        // Remove like
        const { error: deleteError } = await supabase
          .from('vip_page_views')
          .delete()
          .eq('username', extraUsername)
          .eq('user_id', userId);

        if (deleteError) throw deleteError;
        return false; // unliked
      } else {
        // Add like
        const { error: insertError } = await supabase
          .from('vip_page_views')
          .insert([{
            username: extraUsername,
            user_id: userId,
            view_count: 1,
            first_viewed_at: new Date().toISOString(),
            last_viewed_at: new Date().toISOString()
          }]);

        if (insertError) throw insertError;
        return true; // liked
      }
    } catch (error) {
      console.error('Error toggling like:', error);
      alert('Failed to update like: ' + error.message);
      return null;
    }
  }

  // Handle like button clicks
  window.handleLikeClick = async function(extraId) {
    const likeBtn = document.querySelector(`button[onclick="handleLikeClick('${extraId}')"]`);
    const likeCountSpan = likeBtn.parentElement.querySelector('.like-count');
    
    // Disable button during request
    likeBtn.disabled = true;
    
    const isLiked = await toggleExtraLike(extraId);
    
    if (isLiked !== null) {
      // Update UI
      if (isLiked) {
        likeBtn.innerHTML = '❤️ Like';
        likeBtn.classList.add('liked');
      } else {
        likeBtn.innerHTML = '🤍 Like';
        likeBtn.classList.remove('liked');
      }
      
      // Update count
      const newCount = await getExtraLikes(extraId);
      likeCountSpan.textContent = newCount;
    }
    
    // Re-enable button
    likeBtn.disabled = false;
  };

  // Load VIP Extras for this user
  async function loadVipExtras() {
    const container = document.getElementById('extrasContainer');
    const vipExtrasSection = document.getElementById('vip-extras-section');
    const extrasUsername = document.getElementById('extras-username');
    
    if (extrasUsername) {
      extrasUsername.textContent = username;
    }
    
    console.log('Loading VIP extras for:', username);
    console.log('Current user:', currentUser);
    console.log('Is VIP user:', isVipUser);
    
    try {
      const { data: extras, error } = await supabase
        .from('vip_extras')
        .select('*')
        .eq('game_id', username) // Use the page owner's username as game_id
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Error loading extras:', error);
        container.innerHTML = `<div class="no-extras">Error loading extras: ${error.message}</div>`;
        return;
      }

      console.log('Found extras:', extras);

      if (!extras || extras.length === 0) {
        if (isVipUser) {
          container.innerHTML = `<div class="no-extras">No VIP extras yet for ${username}. Be the first to share something awesome!</div>`;
        } else {
          container.innerHTML = `<div class="no-extras">No VIP extras available for ${username}.</div>`;
        }
        return;
      }

      // Get likes for all extras
      const extrasWithLikes = await Promise.all(extras.map(async (extra) => {
        const [likeCount, userHasLiked] = await Promise.all([
          getExtraLikes(extra.id),
          hasUserLikedExtra(extra.id)
        ]);
        
        return {
          ...extra,
          likeCount,
          userHasLiked
        };
      }));

      container.innerHTML = extrasWithLikes.map(extra => {
        // Format the date properly
        let dateStr = 'Unknown date';
        if (extra.created_at) {
          try {
            const date = new Date(extra.created_at);
            dateStr = date.toLocaleDateString('en-US', { 
              month: 'short', 
              day: 'numeric',
              year: date.getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined
            });
          } catch (e) {
            console.error('Date parsing error:', e);
          }
        }

        return '<div class="extra-card">' +
          '<div class="extra-header">' +
            '<div class="extra-type">' + escapeHtml(extra.type || 'EXTRA').toUpperCase() + '</div>' +
          '</div>' +
          '<h4 class="extra-title">' + escapeHtml(extra.title || 'Untitled') + '</h4>' +
          '<p class="extra-description">' + escapeHtml(extra.description || 'No description') + '</p>' +
          '<div class="extra-footer">' +
            '<div class="extra-actions">' +
              '<span class="extra-creator">' +
                'Added by ' + escapeHtml(extra.creator_name || username) + '<br>' +
                '<small>' + dateStr + '</small>' +
              '</span>' +
              '<div class="like-section">' +
                '<button class="like-btn ' + (extra.userHasLiked ? 'liked' : '') + '" onclick="handleLikeClick(\'' + extra.id + '\')">' +
                  (extra.userHasLiked ? '❤️' : '🤍') + ' Like' +
                '</button>' +
                '<span class="like-count">' + extra.likeCount + '</span>' +
              '</div>' +
            '</div>' +
            '<a href="' + (extra.url || '#') + '" target="_blank" class="extra-link">' +
              (extra.type === 'download' ? '⬇ Download' : 
               extra.type === 'link' ? '🔗 Open Link' : 
               extra.type === 'code' ? '📋 Get Code' : 
               extra.type === 'video' ? '🎬 Watch Video' :
               extra.type === 'image' ? '🖼 View Images' :
               '🎯 Access') +
            '</a>' +
          '</div>' +
        '</div>';
      }).join('');

    } catch (err) {
      console.error('Failed to load VIP extras:', err);
      container.innerHTML = `<div class="no-extras">Failed to load VIP extras: ${err.message}</div>`;
    }
  }

  // Add VIP Extra for this user's page - UPDATED TO ALLOW ANY VIP USER
  async function addVipExtra(extraData) {
    if (!currentUser || !isVipUser) {
      alert('VIP access required to add extras');
      return false;
    }

    // REMOVED THE PAGE OWNER CHECK - Now any VIP user can add extras to any page
    console.log('Adding VIP extra as VIP user:', currentUser.user_metadata?.full_name || currentUser.id);

    try {
      const { error } = await supabase
        .from('vip_extras')
        .insert([{
          title: extraData.title,
          description: extraData.description,
          url: extraData.url,
          type: extraData.type,
          game_id: username, // Use page owner's username as game_id
          created_by: currentUser.id,
          creator_name: currentUser.user_metadata?.full_name || 'VIP User'
        }]);

      if (error) {
        console.error('Error adding extra:', error);
        alert('Failed to add extra: ' + error.message);
        return false;
      }

      // Reload extras
      await loadVipExtras();
      
      // Reset form and hide
      document.getElementById('extraForm').reset();
      document.getElementById('addExtraSection').classList.remove('show');
      
      alert('VIP extra added successfully!');
      return true;

    } catch (err) {
      console.error('Error adding VIP extra:', err);
      alert('Failed to add VIP extra: ' + err.message);
      return false;
    }
  }

  // Toggle add extra form
  window.toggleAddExtra = function() {
    const section = document.getElementById('addExtraSection');
    section.classList.toggle('show');
  };

  async function getTotalLikes() {
    if (!username) return 0;
    
    // Get main page likes
    const mainPageResult = await supabase
      .from('vip_page_views')
      .select('*', { count: 'exact', head: true })
      .eq('username', username);
    
    // Get all video likes (any username that starts with username_video_)
    const videoResult = await supabase
      .from('vip_page_views')
      .select('*', { count: 'exact', head: true })
      .like('username', username + '_video_%');
    
    const mainPageCount = mainPageResult.count || 0;
    const videoCount = videoResult.count || 0;
    
    return mainPageCount + videoCount;
  }

  // Check if current user has liked this user's page
  async function hasUserLiked(userId) {
    if (!userId || !username) return false;
    const result = await supabase
      .from('vip_page_views')
      .select('user_id')
      .eq('user_id', userId)
      .eq('username', username)
      .maybeSingle();
    return !!result.data;
  }

  // Get video likes using vip_page_views table
  async function getVideoLikes(videoIds) {
    if (videoIds.length === 0) return {};
    
    const videoUsernames = videoIds.map(id => username + '_video_' + id);
    
    const result = await supabase
      .from('vip_page_views')
      .select('username, view_count')
      .in('username', videoUsernames);

    if (result.error) {
      console.error('Error fetching video likes:', result.error);
      return {};
    }

    const likes = {};
    result.data.forEach(item => {
      const videoId = item.username.split('_video_')[1];
      likes[videoId] = item.view_count || 0;
    });
    
    return likes;
  }

  // Get user's liked videos using vip_page_views table
  async function getUserLikedVideos(userId, videoIds) {
    if (!userId || videoIds.length === 0) return new Set();
    
    const videoUsernames = videoIds.map(id => username + '_video_' + id);
    
    const result = await supabase
      .from('vip_page_views')
      .select('username')
      .eq('user_id', userId)
      .in('username', videoUsernames);

    if (result.error) {
      console.error('Error fetching user liked videos:', result.error);
      return new Set();
    }

    return new Set(result.data.map(item => item.username.split('_video_')[1]));
  }

  // Like the user's page (main page like)
  async function likeUserPage() {
    if (!currentUser) {
      alert('Please log in to like this page');
      return false;
    }

    if (userHasLiked) {
      return false; // Already liked
    }

    const now = new Date().toISOString();

    // Check if the user has already liked the page
    const existingResult = await supabase
      .from('vip_page_views')
      .select('view_count, first_viewed_at')
      .eq('user_id', currentUser.id)
      .eq('username', username)
      .single();

    if (existingResult.data) {
      // If the user already liked, update the view count and last viewed timestamp
      const updateResult = await supabase
        .from('vip_page_views')
        .update({
          view_count: existingResult.data.view_count + 1,
          last_viewed_at: now,
        })
        .eq('user_id', currentUser.id)
        .eq('username', username);

      if (updateResult.error) {
        console.error('Error updating like count:', updateResult.error);
        return false;
      }

      return true;
    }

    // If the user hasn't liked, insert a new row with the current timestamp
    const insertResult = await supabase
      .from('vip_page_views')
      .insert([{
        user_id: currentUser.id,
        username: username,
        view_count: 1,
        first_viewed_at: now,
        last_viewed_at: now,
      }]);

    if (insertResult.error) {
      console.error('Insert error:', insertResult.error);
      return false;
    }

    return true;
  }

  // Like/unlike video using vip_page_views table
  async function toggleVideoLike(videoId) {
    if (!currentUser) {
      alert('Please log in to like videos');
      return;
    }

    const videoUsername = username + '_video_' + videoId;
    const isLiked = userLikedVideos.has(videoId);
    const now = new Date().toISOString();

    if (isLiked) {
      // Unlike - delete the record
      const result = await supabase
        .from('vip_page_views')
        .delete()
        .eq('user_id', currentUser.id)
        .eq('username', videoUsername);

      if (result.error) {
        console.error('Error unliking video:', result.error);
        return;
      }

      userLikedVideos.delete(videoId);
      videoLikes[videoId] = Math.max(0, (videoLikes[videoId] || 1) - 1);
      
      // Update total likes count since we removed a like
      totalLikes = await getTotalLikes();
      updateLikeStatus();
    } else {
      // Like - insert new record
      const result = await supabase
        .from('vip_page_views')
        .insert({
          user_id: currentUser.id,
          username: videoUsername,
          view_count: 1,
          first_viewed_at: now,
          last_viewed_at: now
        });

      if (result.error) {
        console.error('Error liking video:', result.error);
        return;
      }

      userLikedVideos.add(videoId);
      videoLikes[videoId] = (videoLikes[videoId] || 0) + 1;
      
      // Update total likes count since we added a new like
      totalLikes = await getTotalLikes();
      updateLikeStatus();
    }

    // Update UI
    updateVideoLikeButton(videoId);
  }

  // Update video like button appearance
  function updateVideoLikeButton(videoId) {
    const likeBtn = document.querySelector('[data-video-id="' + videoId + '"] .video-like-btn');
    const likeCount = document.querySelector('[data-video-id="' + videoId + '"] .video-like-count');
    
    if (!likeBtn || !likeCount) return;

    const isLiked = userLikedVideos.has(videoId);
    const count = videoLikes[videoId] || 0;

    likeBtn.innerHTML = isLiked ? '❤️ Liked' : '🤍 Like';
    likeBtn.className = 'video-like-btn' + (isLiked ? ' liked' : '');
    likeCount.innerHTML = '❤️ ' + count;

    if (isLiked) {
      likeBtn.classList.add('liked');
    }
  }

  // Update like status display
  function updateLikeStatus() {
    const status = document.getElementById('like-status');
    const likeBtn = document.getElementById('main-like-btn');
    
    if (!status || !likeBtn) return;

    if (!currentUser) {
      status.textContent = '❌ Please log in to like this page.';
      likeBtn.style.display = 'none';
      return;
    }

    if (userHasLiked) {
      status.textContent = '❤️ You already liked ' + username + "'s page. Total likes: " + totalLikes;
      likeBtn.disabled = true;
    } else {
      status.textContent = '👍 Total likes for ' + username + ': ' + totalLikes;
      likeBtn.disabled = false;
    }

    likeBtn.style.display = 'inline-block';
  }

  async function incrementVipPageView() {
    if (!username) return;

    const userData = await supabase
      .from('users')
      .select('id')
      .eq('username', username)
      .single();

    if (userData.error || !userData.data) {
      console.error('User not found for VIP increment:', userData.error);
      return;
    }

    const now = new Date().toISOString();

    const result = await supabase.rpc('increment_vip_page_view', {
      in_user_id: userData.data.id,
      in_username: username,
      in_now: now
    });

    if (result.error) {
      console.error('Error incrementing VIP page views:', result.error);
    } else {
      console.log('Incremented VIP page views for ' + username);
    }
  }

  // Helper functions to extract video IDs
  function extractYouTubeId(url) {
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
  }

  function extractVimeoId(url) {
    const regExp = /(?:vimeo)\.com.*(?:videos|video|channels|)\/([\d]+)/i;
    const match = url.match(regExp);
    return match ? match[1] : null;
  }

  // Extract X (Twitter) video/post ID
  function extractXId(url) {
    // Matches twitter.com and x.com URLs
    const regExp = /(?:twitter\.com|x\.com)\/(?:#!\/)?(\w+)\/status(?:es)?\/(\d+)/;
    const match = url.match(regExp);
    return match ? match[2] : null;
  }

  // Extract TikTok video ID
  function extractTikTokId(url) {
    // Matches various TikTok URL formats
    const regExp = /(?:tiktok\.com\/)(?:@[\w.-]+\/video\/|.*\/video\/)(\d+)/;
    const match = url.match(regExp);
    return match ? match[1] : null;
  }

  // Video type detection
  function detectVideoType(url) {
    if (!url) return 'unknown';
    
    const urlLower = url.toLowerCase();
    
    // Platform detection
    if (urlLower.includes('youtube.com') || urlLower.includes('youtu.be')) return 'youtube';
    if (urlLower.includes('vimeo.com')) return 'vimeo';
    if (urlLower.includes('tiktok.com')) return 'tiktok';
    if (urlLower.includes('twitter.com') || urlLower.includes('x.com')) return 'twitter';
    if (urlLower.includes('drive.google.com')) return 'drive';
    
    // File type detection
    const extMatch = url.match(/\.(\w+)(?:\?.*)?$/);
    const ext = extMatch ? extMatch[1].toLowerCase() : '';
    
    const imageExts = ['gif', 'png', 'jpg', 'jpeg', 'webp', 'svg'];
    const videoExts = ['mp4', 'webm', 'ogg', 'mov', 'avi', 'mkv'];
    
    if (imageExts.includes(ext)) return 'image';
    if (videoExts.includes(ext)) return 'video';
    
    return 'unknown';
  }

  // Create fullscreen placeholder instead of immediate video embed
  function createVideoEmbed(video) {
    const videoType = detectVideoType(video.video_url);
    
    // Create placeholder that loads video only on fullscreen
    const placeholder = document.createElement('div');
    placeholder.className = 'fullscreen-placeholder';
    placeholder.setAttribute('data-platform', videoType);
    
    // Platform-specific icons and text
    let platformIcon = '📹';
    let platformText = 'Click to watch in fullscreen';
    let platformName = videoType.toUpperCase();
    
    switch (videoType) {
      case 'youtube':
        platformIcon = '📺';
        platformText = 'Watch on YouTube in fullscreen';
        platformName = 'YOUTUBE';
        break;
      case 'vimeo':
        platformIcon = '🎬';
        platformText = 'Watch on Vimeo in fullscreen';
        platformName = 'VIMEO';
        break;
      case 'tiktok':
        platformIcon = '🎵';
        platformText = 'Watch on TikTok in fullscreen';
        platformName = 'TIKTOK';
        break;
      case 'twitter':
        platformIcon = '🐦';
        platformText = 'View Twitter post in fullscreen';
        platformName = 'TWITTER/X';
        break;
      case 'drive':
        platformIcon = '💾';
        platformText = 'Play Google Drive video in fullscreen';
        platformName = 'GOOGLE DRIVE';
        break;
      case 'video':
        platformIcon = '🎥';
        platformText = 'Play video in fullscreen';
        platformName = 'VIDEO';
        break;
      case 'image':
        platformIcon = '🖼️';
        platformText = 'View image in fullscreen';
        platformName = 'IMAGE';
        break;
    }
    
    placeholder.innerHTML = `
      <span class="play-icon">${platformIcon}</span>
      <div>${platformText}</div>
      <small style="opacity: 0.7; font-size: 0.8rem;">${platformName}</small>
    `;
    
    // Add click handler to enter fullscreen and load video
    placeholder.addEventListener('click', () => {
      loadVideoInFullscreen(video.video_url, videoType, placeholder, video.title);
    });
    
    return {
      element: placeholder,
      controls: [
        { text: `${platformName} Fullscreen`, action: () => loadVideoInFullscreen(video.video_url, videoType, placeholder, video.title) }
      ]
    };
  }

  // Load video in fullscreen mode
  function loadVideoInFullscreen(url, videoType, placeholderElement, title) {
    // Show loading state
    const originalContent = placeholderElement.innerHTML;
    placeholderElement.innerHTML = `
      <span class="play-icon">⏳</span>
      <div>Loading ${videoType.toUpperCase()} video...</div>
      <small style="opacity: 0.7; font-size: 0.8rem;">Entering fullscreen mode</small>
    `;
    
    // For Twitter/X, show direct links instead of trying to embed (TikTok will be embedded normally)
    if (videoType === 'twitter') {
      setTimeout(() => {
        placeholderElement.innerHTML = `
          <span class="play-icon">🚫</span>
          <div style="margin-bottom: 15px;">TWITTER/X may block embedding</div>
          <button onclick="window.open('${url}', '_blank')" style="
            background: linear-gradient(45deg, #1da1f2, #ff4f9f);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(29, 161, 242, 0.3);
          " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
            🐦 Open on TWITTER/X
          </button>
          <div style="margin-top: 10px;">
            <small style="opacity: 0.7;">Click to watch in new tab</small>
          </div>
        `;
      }, 1000);
      return;
    }
    
    // For other platforms, try video embedding
    const videoElement = createVideoElement(url, videoType);
    
    // Add load event handlers
    videoElement.onload = function() {
      console.log(`Successfully loaded ${videoType} video:`, url);
    };
    
    videoElement.onerror = function() {
      console.error(`Failed to load ${videoType} video:`, url);
      // Restore placeholder on error
      placeholderElement.innerHTML = `
        <span class="play-icon">❌</span>
        <div style="margin-bottom: 15px;">Failed to load video</div>
        <button onclick="window.open('${url}', '_blank')" style="
          background: linear-gradient(45deg, #ff4f9f, #ff1493);
          color: white;
          border: none;
          padding: 12px 24px;
          border-radius: 25px;
          font-weight: bold;
          cursor: pointer;
          font-family: inherit;
          font-size: 0.9rem;
          transition: all 0.3s ease;
          box-shadow: 0 4px 15px rgba(255, 79, 159, 0.3);
        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
          🔗 Open Video Direct
        </button>
        <div style="margin-top: 10px;">
          <small style="opacity: 0.7;">Click to try again</small>
        </div>
      `;
      setTimeout(() => {
        placeholderElement.innerHTML = originalContent;
      }, 5000);
      return;
    };
    
    // Replace placeholder with video element
    placeholderElement.parentNode.replaceChild(videoElement, placeholderElement);
    
    // Enter fullscreen
    const enterFullscreen = () => {
      if (videoElement.requestFullscreen) {
        videoElement.requestFullscreen().catch(err => {
          console.log('Fullscreen failed, showing in normal view');
        });
      } else if (videoElement.mozRequestFullScreen) {
        videoElement.mozRequestFullScreen();
      } else if (videoElement.webkitRequestFullscreen) {
        videoElement.webkitRequestFullscreen();
      } else if (videoElement.msRequestFullscreen) {
        videoElement.msRequestFullscreen();
      } else {
        console.warn('Fullscreen not supported, showing video in current view');
      }
    };
    
    // Small delay to ensure video element is ready
    setTimeout(enterFullscreen, 100);
    
    // Store reference for cleanup
    const videoId = Date.now(); // Simple unique ID
    activeVideoElements.set(videoId, { videoElement, placeholder: placeholderElement });
    
    // Add fullscreen change listeners
    const handleFullscreenChange = () => {
      if (!document.fullscreenElement && !document.mozFullScreenElement && 
          !document.webkitFullscreenElement && !document.msFullscreenElement) {
        // Exited fullscreen - cleanup and restore placeholder
        cleanupVideo(videoId);
      }
    };
    
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('mozfullscreenchange', handleFullscreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
    document.addEventListener('msfullscreenchange', handleFullscreenChange);
    
    // Store cleanup function
    videoElement._fullscreenCleanup = handleFullscreenChange;
    videoElement._videoId = videoId;
    videoElement._originalContent = originalContent;
  }

  // Create actual video element
  function createVideoElement(url, videoType) {
    let mediaEl;

    switch (videoType) {
      case 'youtube':
        const videoIdYT = extractYouTubeId(url);
        if (videoIdYT) {
          mediaEl = document.createElement('iframe');
          mediaEl.src = 'https://www.youtube.com/embed/' + videoIdYT;
          mediaEl.width = '100%';
          mediaEl.height = '100%';
          mediaEl.frameBorder = '0';
          mediaEl.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
          mediaEl.allowFullscreen = true;
          mediaEl.className = 'video-embed';
        }
        break;
        
      case 'vimeo':
        const videoIdVM = extractVimeoId(url);
        if (videoIdVM) {
          mediaEl = document.createElement('iframe');
          mediaEl.src = 'https://player.vimeo.com/video/' + videoIdVM;
          mediaEl.width = '100%';
          mediaEl.height = '100%';
          mediaEl.frameBorder = '0';
          mediaEl.allow = 'autoplay; fullscreen; picture-in-picture';
          mediaEl.allowFullscreen = true;
          mediaEl.className = 'video-embed';
        }
        break;
        
      case 'tiktok':
        const tiktokId = extractTikTokId(url);
        if (tiktokId) {
          mediaEl = document.createElement('iframe');
          mediaEl.src = `https://www.tiktok.com/embed/v2/${tiktokId}`;
          mediaEl.width = '100%';
          mediaEl.height = '100%';
          mediaEl.frameBorder = '0';
          mediaEl.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
          mediaEl.allowFullscreen = true;
          mediaEl.className = 'video-embed';
          mediaEl.style.backgroundColor = '#000';
        }
        break;
        
      case 'twitter':
        const xId = extractXId(url);
        if (xId) {
          mediaEl = document.createElement('iframe');
          mediaEl.src = `https://platform.twitter.com/embed/Tweet.html?id=${xId}`;
          mediaEl.width = '100%';
          mediaEl.height = '100%';
          mediaEl.frameBorder = '0';
          mediaEl.scrolling = 'no';
          mediaEl.className = 'video-embed';
          mediaEl.style.backgroundColor = '#000';
        }
        break;
        
      case 'drive':
        const fileIdMatch = url.match(/\/d\/(.*?)(\/|$)/);
        const fileId = fileIdMatch ? fileIdMatch[1] : null;
        if (fileId) {
          mediaEl = document.createElement('iframe');
          mediaEl.src = 'https://drive.google.com/file/d/' + fileId + '/preview';
          mediaEl.width = '100%';
          mediaEl.height = '100%';
          mediaEl.allow = 'autoplay';
          mediaEl.frameBorder = '0';
          mediaEl.className = 'video-embed';
        }
        break;
        
      case 'video':
        mediaEl = document.createElement('video');
        mediaEl.controls = true;
        mediaEl.className = 'video-player';
        mediaEl.src = url;
        mediaEl.style.width = '100%';
        mediaEl.style.height = '100%';
        break;
        
      case 'image':
        mediaEl = document.createElement('img');
        mediaEl.src = url;
        mediaEl.alt = 'Image';
        mediaEl.className = 'thumbnail';
        mediaEl.style.width = '100%';
        mediaEl.style.height = '100%';
        mediaEl.style.objectFit = 'contain';
        break;
        
      default:
        // Create a placeholder for unsupported formats
        mediaEl = document.createElement('div');
        mediaEl.className = 'video-player';
        mediaEl.style.cssText = `
          display: flex;
          align-items: center;
          justify-content: center;
          background-color: #333;
          color: #fff;
          padding: 20px;
          text-align: center;
          width: 100%;
          height: 100%;
        `;
        
        const playLink = document.createElement('a');
        playLink.href = url;
        playLink.target = '_blank';
        playLink.className = 'play-link';
        playLink.textContent = 'View Content →';
        
        mediaEl.appendChild(playLink);
        break;
    }

    if (!mediaEl) {
      // Fallback for failed video creation
      mediaEl = document.createElement('div');
      mediaEl.className = 'video-player';
      mediaEl.style.cssText = `
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #333;
        color: #fff;
        padding: 20px;
        text-align: center;
        width: 100%;
        height: 100%;
      `;
      mediaEl.textContent = 'Video format not supported';
    }

    return mediaEl;
  }

  // Cleanup video when exiting fullscreen
  function cleanupVideo(videoId) {
    const videoData = activeVideoElements.get(videoId);
    if (!videoData) return;
    
    const { videoElement, placeholder } = videoData;
    
    // Remove fullscreen listeners
    if (videoElement._fullscreenCleanup) {
      document.removeEventListener('fullscreenchange', videoElement._fullscreenCleanup);
      document.removeEventListener('mozfullscreenchange', videoElement._fullscreenCleanup);
      document.removeEventListener('webkitfullscreenchange', videoElement._fullscreenCleanup);
      document.removeEventListener('msfullscreenchange', videoElement._fullscreenCleanup);
    }
    
    // Restore original placeholder content
    if (videoElement._originalContent) {
      placeholder.innerHTML = videoElement._originalContent;
    }
    
    // Replace video element with placeholder
    if (videoElement.parentNode) {
      videoElement.parentNode.replaceChild(placeholder, videoElement);
    }
    
    console.log('Video cleaned up and placeholder restored');
    
    // Clean up references
    activeVideoElements.delete(videoId);
  }

  function convertDriveLinkToThumbnail(url) {
    if (!url) return '';
    const fileIdMatch = url.match(/\/d\/(.*?)(\/|$)/);
    const fileId = fileIdMatch ? fileIdMatch[1] : null;
    if (fileId) {
      return 'https://drive.google.com/thumbnail?id=' + fileId;
    }
    return url;
  }

  function convertDriveLinkToDirectView(url) {
    if (!url) return '';
    const fileIdMatch = url.match(/\/d\/(.*?)(\/|$)/);
    const fileId = fileIdMatch ? fileIdMatch[1] : null;
    if (fileId) {
      return 'https://drive.google.com/uc?export=view&id=' + fileId;
    }
    return url;
  }

  async function loadVideos() {
    const result = await supabase
      .from('game_videos')
      .select('*')
      .eq('github_username', username)
      .order('created_at', { ascending: false });

    if (result.error) {
      videosContainer.innerHTML = '<div class="no-content">❌ Error loading videos: ' + result.error.message + '</div>';
      return;
    }

    if (!result.data.length) {
      videosContainer.innerHTML = '<p class="no-content">No videos submitted by ' + username + ' yet.</p>';
      return;
    }

    // Get current user and load like status
    currentUser = await getCurrentUser();
    console.log('🔍 Current user:', currentUser);
    
    if (currentUser) {
      isVipUser = await checkVipStatus(currentUser);
      userHasLiked = await hasUserLiked(currentUser.id);
      
      console.log('📊 Current user ID:', currentUser.id);
      console.log('👑 Is VIP:', isVipUser);
      console.log('📝 Page username:', username);
      
      // Show VIP badge and features if user is VIP
      if (isVipUser) {
        const vipBadge = document.getElementById('vipBadge');
        const vipBadgesSection = document.getElementById('vipBadgesSection');
        const msgInput = document.getElementById('msg-input');
        const addExtraBtn = document.getElementById('addExtraBtn');
        
        console.log('🎉 User is VIP! Enabling VIP features...');
        
        if (vipBadge) {
          vipBadge.style.display = 'inline-block';
          console.log('✅ VIP badge shown');
        }
        
        if (vipBadgesSection) {
          vipBadgesSection.classList.add('show');
          console.log('✅ VIP badges section shown');
        }
        
        if (msgInput) {
          msgInput.classList.add('vip');
          console.log('✅ VIP chat styling added');
        }
        
        // Show add extra button for ALL VIP users (no page owner restriction)
        if (addExtraBtn) {
          addExtraBtn.style.display = 'inline-block';
          addExtraBtn.textContent = '➕ Add VIP Extra';
          console.log('✅ Add extra button shown for VIP user');
        }
        
      } else {
        console.log('❌ User is not VIP');
      }
    } else {
      console.log('❌ No current user logged in');
    }
    
    totalLikes = await getTotalLikes();

    // Update the like status display
    updateLikeStatus();

    // Add event listener for main like button
    const mainLikeBtn = document.getElementById('main-like-btn');
    if (mainLikeBtn) {
      mainLikeBtn.addEventListener('click', async function() {
        const success = await likeUserPage();
        if (success) {
          userHasLiked = true;
          totalLikes = await getTotalLikes();
          updateLikeStatus();
        }
      });
    }

    // Get video likes data
    const videoIds = result.data.map(video => video.id || 'video-' + result.data.indexOf(video));
    videoLikes = await getVideoLikes(videoIds);
    if (currentUser) {
      userLikedVideos = await getUserLikedVideos(currentUser.id, videoIds);
    }

    videosContainer.innerHTML = '';
    result.data.forEach(function(video, index) {
      const videoId = video.id || 'video-' + index;
      const card = document.createElement('article');
      card.className = 'card';
      card.setAttribute('data-video-id', videoId);

      const title = document.createElement('h3');
      title.className = 'title';
      title.textContent = video.title || 'Untitled Video';
      card.appendChild(title);

      // Always add description element - show placeholder if empty
      const desc = document.createElement('p');
      desc.className = 'desc';
      desc.textContent = video.description || 'No description provided';
      card.appendChild(desc);
      
      // DEBUG: Log what was added
      console.log(`Added description for video ${index}:`, desc.textContent);

      if (video.video_url) {
        const videoEmbed = createVideoEmbed(video);
        card.appendChild(videoEmbed.element);

        if (videoEmbed.controls && videoEmbed.controls.length > 0) {
          const controlsDiv = document.createElement('div');
          controlsDiv.className = 'video-controls';

          videoEmbed.controls.forEach(control => {
            const btn = document.createElement('button');
            btn.className = 'control-btn';
            btn.textContent = control.text;
            btn.addEventListener('click', control.action);
            controlsDiv.appendChild(btn);
          });

          card.appendChild(controlsDiv);
        }
      }

      // Add video like section
      const videoLikeSection = document.createElement('div');
      videoLikeSection.className = 'video-like-section';

      const videoLikeBtn = document.createElement('button');
      videoLikeBtn.className = 'video-like-btn';
      const isLiked = userLikedVideos.has(videoId);
      videoLikeBtn.innerHTML = isLiked ? '❤️ Liked' : '🤍 Like';
      if (isLiked) videoLikeBtn.classList.add('liked');
      
      if (!currentUser) {
        videoLikeBtn.disabled = true;
        videoLikeBtn.innerHTML = '🤍 Like';
      }

      videoLikeBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        toggleVideoLike(videoId);
      });

      const videoLikeCount = document.createElement('div');
      videoLikeCount.className = 'video-like-count';
      videoLikeCount.innerHTML = '❤️ ' + (videoLikes[videoId] || 0);

      videoLikeSection.appendChild(videoLikeBtn);
      videoLikeSection.appendChild(videoLikeCount);
      card.appendChild(videoLikeSection);

      // Add login prompt if user not logged in
      if (!currentUser) {
        const loginPrompt = document.createElement('p');
        loginPrompt.className = 'video-login-prompt';
        loginPrompt.textContent = 'Log in to like videos';
        card.appendChild(loginPrompt);
      }

      videosContainer.appendChild(card);
    });

    // Load VIP extras after videos are loaded
    await loadVipExtras();
  }

  // Badge selection functionality
  function initializeBadgeSelection() {
    document.querySelectorAll('.badge-item').forEach(badge => {
      badge.addEventListener('click', () => {
        document.querySelectorAll('.badge-item').forEach(b => b.classList.remove('selected'));
        badge.classList.add('selected');
        selectedBadge = badge.dataset.badge;
        localStorage.setItem(`vip_badge_${username}`, selectedBadge);
      });
    });

    // Load saved badge
    const savedBadge = localStorage.getItem(`vip_badge_${username}`);
    if (savedBadge) {
      selectedBadge = savedBadge;
      const badgeElement = document.querySelector(`[data-badge="${savedBadge}"]`);
      if (badgeElement) {
        badgeElement.classList.add('selected');
      }
    } else {
      document.querySelector('[data-badge="👑"]')?.classList.add('selected');
    }
  }

  // Enhanced chat functionality with VIP features
  async function getUserGitHubUsername() {
    if (currentUser) {
      const { data: userData } = await supabase
        .from('users')
        .select('github_username')
        .eq('id', currentUser.id)
        .single();
      
      return userData?.github_username || currentUser.user_metadata?.full_name || 'GitHub User';
    }
    return 'Guest';
  }

  async function loadChatMessages() {
    const gameId = username; // Use the page owner's username as game_id
    if (!gameId) return;

    const result = await supabase
      .from('messages')
      .select('*')
      .eq('game_id', gameId)
      .order('created_at', { ascending: true });

    if (result.error) {
      messagesDiv.innerHTML = '<p style="color:red;">Error loading messages: ' + result.error.message + '</p>';
      console.error(result.error);
      return;
    }

    if (!result.data.length) {
      messagesDiv.innerHTML = '<p>No messages yet. Be the first to chat!</p>';
      return;
    }

    const currentUsername = await getUserGitHubUsername();

    messagesDiv.innerHTML = result.data.map(function(m) {
      const isCurrentUserVip = isVipUser && m.github_username === currentUsername;
      const messageClass = isCurrentUserVip ? 'message vip' : 'message';
      const usernameClass = isCurrentUserVip ? 'username vip' : 'username';
      const userBadge = isCurrentUserVip ? selectedBadge : '';
      const messageTime = new Date(m.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      
      return '<div class="' + messageClass + '">' +
        '<div class="message-header">' +
          '<span class="' + usernameClass + '">' + (m.github_username || 'Guest') + '</span>' +
          (userBadge ? '<span class="user-badge">' + userBadge + '</span>' : '') +
          '<span class="message-time">' + messageTime + '</span>' +
        '</div>' +
        '<div class="message-content">' + escapeHtml(m.content) + '</div>' +
      '</div>';
    }).join('');
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  form.addEventListener('submit', async function(e) {
    e.preventDefault();

    const message = msgInput.value.trim();
    if (!message) return;

    const githubUsername = await getUserGitHubUsername();
    const gameId = username; // Use the page owner's username as game_id

    const result = await supabase
      .from('messages')
      .insert([{ content: message, github_username: githubUsername, game_id: gameId }]);

    if (result.error) {
      alert('Failed to send message: ' + result.error.message);
      return;
    }

    msgInput.value = '';
    loadChatMessages();
  });

  // Handle form submission for VIP extras
  const extraForm = document.getElementById('extraForm');
  if (extraForm) {
    extraForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = {
        title: document.getElementById('extraTitle').value.trim(),
        description: document.getElementById('extraDescription').value.trim(),
        url: document.getElementById('extraUrl').value.trim(),
        type: document.getElementById('extraType').value
      };

      if (!formData.title || !formData.description || !formData.url || !formData.type) {
        alert('Please fill in all required fields');
        return;
      }

      await addVipExtra(formData);
    });
  }

  // Subscribe to real-time message updates
  supabase.channel('messages_' + username)
    .on('postgres_changes', { 
      event: 'INSERT', 
      schema: 'public', 
      table: 'messages',
      filter: `game_id=eq.${username}`
    }, () => {
      loadChatMessages();
    })
    .subscribe();

  // Subscribe to real-time VIP extras updates
  supabase.channel(`vip_extras_${username}`)
    .on('postgres_changes', { 
      event: 'INSERT', 
      schema: 'public', 
      table: 'vip_extras',
      filter: `game_id=eq.${username}`
    }, () => {
      loadVipExtras();
    })
    .subscribe();

  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, function(m) {
      switch(m) {
        case '&': return '&amp;';
        case '<': return '&lt;';
        case '>': return '&gt;';
        case '"': return '&quot;';
        case "'": return '&#39;';
        default: return m;
      }
    });
  }

  // Main execution block
  if (!username) {
    pageTitle.textContent = 'Error';
    chatHeading.textContent = 'Error';
    videosContainer.innerHTML = '<p class="no-content">❌ No username provided in URL.</p>';
    messagesDiv.innerHTML = '';
  } else {
    pageTitle.textContent = username + "'s Content";
    chatHeading.textContent = username;
    
    // Set the game ID to the username
    const gameIdInput = document.getElementById('game-id');
    if (gameIdInput) {
      gameIdInput.value = username;
    }

    incrementVipPageView();
    loadVideos();
    loadChatMessages();
    initializeBadgeSelection();
  }
</script>

<!-- Add this CSS to your existing page's <head> section -->
<style>
.bottom-embeds-section {
    background: linear-gradient(135deg, #2f1a39, #3d2147);
    border: 2px solid #ff4f9f;
    border-radius: 12px;
    padding: 1.5rem;
    margin: 2rem auto;
    text-align: center;
    max-width: 400px;
}
.bottom-embeds-section h3 {
    color: #ff4f9f;
    margin-bottom: 1.5rem;
    text-shadow: 0 0 10px #ff4f9f;
    font-family: 'Rubik Mono One', sans-serif;
}
.bottom-embeds-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
    margin-top: 2rem;
    justify-content: center;
    max-width: 300px;
    margin-left: auto;
    margin-right: auto;
}
.bottom-embed-container {
    border: 2px solid #ff4f9f;
    border-radius: 8px;
    overflow: hidden;
    background: linear-gradient(45deg, #ff4f9f, #ff82ba);
    height: 60px;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    animation: pulse 2s infinite;
}

.bottom-embed-container:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 25px rgba(255, 79, 159, 0.6);
    background: linear-gradient(45deg, #ff82ba, #ffb3d1);
}

@keyframes pulse {
    0%, 100% { box-shadow: 0 0 5px rgba(255, 79, 159, 0.5); }
    50% { box-shadow: 0 0 20px rgba(255, 79, 159, 0.8); }
}
.bottom-embed-iframe {
    width: 100%;
    height: 400px;
    border: none;
    display: block;
    transform: scale(0.8);
    transform-origin: top left;
    overflow: hidden;
}
.bottom-embed-header {
    background: linear-gradient(45deg, #ff4f9f, #ff82ba);
    color: #1b1b2e;
    padding: 10px;
    font-weight: bold;
    font-size: 0.9rem;
    font-family: 'Rubik Mono One', sans-serif;
}
@media (max-width: 768px) {
    .bottom-embeds-container {
        grid-template-columns: 1fr;
        max-width: 150px;
    }
    .bottom-embeds-section {
        padding: 1rem;
        margin: 1rem auto;
    }
    .bottom-embed-container {
        height: 50px;
    }
}
</style>

<!-- Add this HTML section to the bottom of your existing page -->
<div class="bottom-embeds-section">
    <h3>Featured Content</h3>
    <div class="bottom-embeds-container" id="bottomEmbedsContainer">
        <!-- Embeds will automatically load here -->
    </div>
</div>

<script>
function createBottomEmbed(url, title) {
    const embedContainer = document.createElement('div');
    embedContainer.className = 'bottom-embed-container';

    const embedHeader = document.createElement('div');
    embedHeader.className = 'bottom-embed-header';
    embedHeader.textContent = `Embedded: ${title}`;

    const iframe = document.createElement('iframe');
    iframe.className = 'bottom-embed-iframe';
    iframe.src = url;
    iframe.loading = 'lazy';
    iframe.setAttribute('allowfullscreen', 'true');
    
    // Add error handling
    iframe.onload = function() {
        console.log(`Successfully loaded: ${title}`);
    };
    
    iframe.onerror = function() {
        console.log(`Failed to load: ${title}`);
        iframe.style.background = '#ff4f9f';
        iframe.insertAdjacentHTML('afterbegin', `<div style="color: white; padding: 20px; text-align: center;">Unable to embed ${title}<br>Site may block iframe embedding</div>`);
    };

    embedContainer.appendChild(embedHeader);
    embedContainer.appendChild(iframe);
    
    return embedContainer;
}

function autoLoadBottomEmbeds() {
    const urls = [
        'https://otieu.com/4/9248260',
        'https://otieu.com/4/9249624',
        'https://otieu.com/4/9249458',
        'https://otieu.com/4/9661607'
    ];
    const embedsContainer = document.getElementById('bottomEmbedsContainer');
    
    if (embedsContainer) {
        // Instead of embedding, create clickable previews
        urls.forEach((url, index) => {
            const linkContainer = document.createElement('div');
            linkContainer.className = 'bottom-embed-container';
            linkContainer.style.cursor = 'pointer';
            linkContainer.style.display = 'flex';
            linkContainer.style.alignItems = 'center';
            linkContainer.style.justifyContent = 'center';
            linkContainer.style.textDecoration = 'none';
            
            linkContainer.innerHTML = `
                <div style="text-align: center; color: #1b1b2e; padding: 5px; font-weight: bold;">
                    <div style="font-size: 1rem; margin-bottom: 2px;">💎</div>
                    <div style="font-size: 0.7rem; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">CLICK ME ${index + 1}</div>
                </div>
            `;
            
            linkContainer.addEventListener('click', () => {
                window.open(url, '_blank');
            });
            
            embedsContainer.appendChild(linkContainer);
        });
    }
}

// Auto-load embeds when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', autoLoadBottomEmbeds);
} else {
    autoLoadBottomEmbeds();
}
</script>
  
</body>
</html>


