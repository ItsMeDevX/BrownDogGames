<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP Game Point Page</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rubik+Mono+One&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1b1b2e, #2c1b33);
            color: #fefefe;
            font-family: 'Rubik Mono One', sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: linear-gradient(135deg, #2f1a39, #3d2447);
            border: 3px solid #ff4f9f;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 8px 32px rgba(255, 79, 159, 0.3);
            /* Prevent layout shifts */
            min-height: 500px;
            position: relative;
        }

        h1 {
            color: #ff4f9f;
            font-size: 2.2em;
            margin-bottom: 30px;
            text-shadow: 0 0 20px rgba(255, 79, 159, 0.5);
        }

        .status-card {
            padding: 20px;
            border-radius: 12px;
            margin: 25px 0;
            border: 2px solid;
            font-weight: 700;
            /* Prevent flashing */
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vip-status {
            color: #2ecc71;
            background: rgba(46, 204, 113, 0.1);
            border-color: #2ecc71;
        }

        .not-vip {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            border-color: #e74c3c;
        }

        .loading {
            color: #3498db;
            background: rgba(52, 152, 219, 0.1);
            border-color: #3498db;
        }

        .points-display {
            background: rgba(42, 35, 58, 0.9);
            padding: 30px;
            border-radius: 16px;
            margin: 30px 0;
            border: 3px solid #ffd700;
            /* Fixed height to prevent jumping */
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #game-points {
            font-size: 3em;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            margin: 15px 0;
            /* Smooth transitions */
            transition: all 0.3s ease;
        }

        button {
            background: linear-gradient(135deg, #ff4f9f, #e33f8a);
            color: #1b1b2e;
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 700;
            font-family: 'Rubik Mono One', sans-serif;
            margin: 15px 5px;
            transition: all 0.3s ease;
            /* Fixed width to prevent button size changes */
            min-width: 200px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(227, 63, 138, 0.6);
        }

        button:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .message {
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid;
            /* Fixed positioning to prevent layout jumps */
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            z-index: 100;
            /* Smooth show/hide */
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .message.show {
            opacity: 1;
            visibility: visible;
        }

        .success-message {
            background: rgba(46, 204, 113, 0.1);
            color: #5dff5d;
            border-color: #2ecc71;
        }

        .error-message {
            background: rgba(231, 76, 60, 0.1);
            color: #ff6b6b;
            border-color: #e74c3c;
        }

        .closing-message {
            background: rgba(255, 215, 0, 0.1);
            color: #ffd700;
            border-color: #ffd700;
        }

        .user-info {
            background: rgba(42, 35, 58, 0.8);
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #ff4f9f;
            /* Fixed height to prevent jumps */
            min-height: 140px;
        }

        .user-info img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #ff4f9f;
            margin: 10px 0;
        }

        /* Section visibility management */
        .section {
            /* All sections start hidden */
            display: none;
            /* Smooth transitions */
            transition: opacity 0.3s ease;
        }

        .section.active {
            display: block;
            opacity: 1;
        }

        /* Loading spinner for smoother loading experience */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(52, 152, 219, 0.3);
            border-left: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 25px 20px;
                margin: 10px;
            }
            
            h1 {
                font-size: 1.6em;
            }
            
            #game-points {
                font-size: 2.5em;
            }
            
            button {
                width: 100%;
                max-width: 300px;
                min-width: auto;
            }

            .message {
                position: relative;
                top: auto;
                left: auto;
                right: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ VIP Game Point Page</h1>
        
        <!-- Loading State -->
        <div id="loading-section" class="section active">
            <div class="status-card loading">
                <div>
                    <p>Loading...</p>
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>

        <!-- Not Logged In -->
        <div id="not-logged-in-section" class="section">
            <div class="status-card not-vip">
                <div>
                    <p>üîê Please log in to access VIP features!</p>
                    <button id="login-btn">Login with GitHub</button>
                </div>
            </div>
        </div>

        <!-- Not VIP -->
        <div id="not-vip-section" class="section">
            <div class="status-card not-vip">
                <div>
                    <p>‚≠ê This page is for VIP members only!</p>
                    <p>Upgrade to VIP to earn game points.</p>
                    <button onclick="window.location.href='index.html'">Go to Main Page</button>
                </div>
            </div>
        </div>

        <!-- VIP Content -->
        <div id="vip-content-section" class="section">
            <div class="user-info" id="user-info">
                <!-- User info populated by JS -->
            </div>

            <div class="status-card vip-status">
                <p>‚≠ê VIP Member - Game Points Available!</p>
            </div>

            <div class="points-display">
                <p>Your Current Game Points:</p>
                <div id="game-points">0</div>
            </div>
            
            <p>üéØ Click to earn a game point - page will close after earning!</p>

            <button id="earn-point-btn">Earn Game Point</button>
        </div>

        <!-- Messages -->
        <div id="success-msg" class="message success-message">
            <p>üéâ Game point earned successfully!</p>
        </div>

        <div id="error-msg" class="message error-message">
            <p id="error-text">An error occurred</p>
        </div>

        <div id="closing-msg" class="message closing-message">
            <p>‚ú® Point earned! Closing page...</p>
        </div>
    </div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

  const supabase = createClient(
    'https://fwslmbzfukriibnkpzou.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3c2xtYnpmdWtyaWlibmtwem91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4NTcxMDcsImV4cCI6MjA2NDQzMzEwN30.juWK3T16_-LGHPii7xLp92Tt5TAZKN3IcZVn6nR8cBA'
  );

  // State
  let currentUser = null;
  let currentUsername = null;
  let currentPoints = 0;
  let isProcessing = false;

  // DOM elements - cached once
  const sections = {
    loading: document.getElementById('loading-section'),
    notLoggedIn: document.getElementById('not-logged-in-section'),
    notVip: document.getElementById('not-vip-section'),
    vipContent: document.getElementById('vip-content-section')
  };

  const elements = {
    userInfo: document.getElementById('user-info'),
    gamePointsDisplay: document.getElementById('game-points'),
    loginBtn: document.getElementById('login-btn'),
    earnPointBtn: document.getElementById('earn-point-btn'),
    successMsg: document.getElementById('success-msg'),
    errorMsg: document.getElementById('error-msg'),
    errorText: document.getElementById('error-text'),
    closingMsg: document.getElementById('closing-msg')
  };

  // Utility functions
  function showSection(activeSection) {
    // Batch DOM updates for smoother transitions
    requestAnimationFrame(() => {
      Object.values(sections).forEach(section => {
        if (section) section.classList.remove('active');
      });
      if (activeSection) activeSection.classList.add('active');
    });
  }

  function showMessage(messageEl, text = null, duration = 3000) {
    if (text && messageEl === elements.errorMsg) {
      elements.errorText.textContent = text;
    }
    
    // Use CSS classes for smooth animations
    messageEl.classList.add('show');
    
    setTimeout(() => {
      messageEl.classList.remove('show');
    }, duration);
  }

  function hideAllMessages() {
    [elements.successMsg, elements.errorMsg, elements.closingMsg].forEach(el => {
      if (el) el.classList.remove('show');
    });
  }

  // Debounced function to prevent rapid calls
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // Check VIP status with caching
  const vipStatusCache = new Map();
  
  async function checkVIPStatus(userId) {
    if (vipStatusCache.has(userId)) {
      return vipStatusCache.get(userId);
    }

    try {
      // First check localStorage
      const localVIP = localStorage.getItem('vipAccess') === 'true';
      
      if (localVIP) {
        vipStatusCache.set(userId, true);
        return true;
      }

      // Check database
      const { data, error } = await supabase
        .from('users')
        .select('is_vip')
        .eq('id', userId)
        .single();

      if (error) {
        console.log('Database error, using localStorage:', error);
        vipStatusCache.set(userId, localVIP);
        return localVIP;
      }

      const dbVIP = data?.is_vip === true;
      
      // Update localStorage and cache
      if (dbVIP) {
        localStorage.setItem('vipAccess', 'true');
      }

      const result = dbVIP || localVIP;
      vipStatusCache.set(userId, result);
      return result;
    } catch (err) {
      console.log('VIP check error:', err);
      const fallback = localStorage.getItem('vipAccess') === 'true';
      vipStatusCache.set(userId, fallback);
      return fallback;
    }
  }

  // Get current points with caching
  const pointsCache = new Map();
  
  async function getCurrentPoints(userId) {
    // Check cache first for immediate response
    if (pointsCache.has(userId)) {
      return pointsCache.get(userId);
    }

    try {
      const { data, error } = await supabase
        .from('vip_page_views')
        .select('game_points')
        .eq('user_id', userId)
        .single();

      if (error && error.code !== 'PGRST116') {
        console.log('Points fetch error:', error);
        return 0;
      }

      const points = data?.game_points || 0;
      pointsCache.set(userId, points);
      return points;
    } catch (err) {
      console.log('Points error:', err);
      return 0;
    }
  }

  // Update points and close page
  async function updatePointsAndClose(userId, username, newPoints) {
    try {
      console.log('=== UPDATING POINTS AND CLOSING ===');
      console.log('User ID:', userId);
      console.log('Username:', username);
      console.log('New Points:', newPoints);
      console.log('Current Points before update:', currentPoints);

      // Perform the upsert - FIXED: Set view_count to 0 for game points
      const { data, error } = await supabase
        .from('vip_page_views')
        .upsert({
          user_id: userId,
          username: username,
          game_points: newPoints,
          view_count: 0,  // Set to 0 for game points (policy requirement)
          last_viewed_at: new Date().toISOString()
        })
        .select();

      console.log('Upsert response:', { data, error });

      if (error) {
        console.error('Database error:', error);
        showMessage(elements.errorMsg, `Database error: ${error.message}`);
        return false;
      }

      // Update UI immediately
      currentPoints = newPoints;
      elements.gamePointsDisplay.textContent = currentPoints;
      pointsCache.set(userId, newPoints);

      // Show success message briefly
      showMessage(elements.successMsg, null, 1500);

      // Show closing message and close the page
      setTimeout(() => {
        showMessage(elements.closingMsg, null, 2000);
        
        // Close the page after a brief delay
        setTimeout(() => {
          // Try different methods to close the page
          if (window.opener) {
            // If opened by another window, close normally
            window.close();
          } else {
            // If opened directly, try to close or redirect
            try {
              window.close();
            } catch (e) {
              // If can't close, redirect to main page
              window.location.href = 'index.html';
            }
          }
        }, 1000);
      }, 1000);

      console.log('=== POINT EARNED, CLOSING PAGE ===');
      return true;
    } catch (err) {
      console.error('Exception in updatePointsAndClose:', err);
      showMessage(elements.errorMsg, 'Error updating points');
      return false;
    }
  }

  // Initialize page with better error handling and loading states
  async function init() {
    try {
      hideAllMessages();
      
      // Get session
      const { data: { session } } = await supabase.auth.getSession();
      
      if (!session?.user) {
        showSection(sections.notLoggedIn);
        return;
      }

      currentUser = session.user;
      currentUsername = session.user.user_metadata?.user_name || 
                       session.user.user_metadata?.preferred_username ||
                       session.user.email?.split('@')[0] || 'User';

      console.log('User:', currentUser.id, currentUsername);

      // Check VIP status
      const isVIP = await checkVIPStatus(currentUser.id);
      console.log('Is VIP:', isVIP);

      if (!isVIP) {
        showSection(sections.notVip);
        return;
      }

      // Show VIP content
      showSection(sections.vipContent);

      // Display user info (batch DOM updates)
      requestAnimationFrame(() => {
        const avatar = currentUser.user_metadata?.avatar_url || '';
        const fullName = currentUser.user_metadata?.full_name || currentUsername;
        
        elements.userInfo.innerHTML = `
          <h3>Welcome, ${fullName}!</h3>
          ${avatar ? `<img src="${avatar}" alt="${fullName}">` : ''}
          <p><strong>Username:</strong> ${currentUsername}</p>
          <p><strong>Status:</strong> ‚≠ê VIP Member</p>
        `;
      });

      // Get current points
      currentPoints = await getCurrentPoints(currentUser.id);
      elements.gamePointsDisplay.textContent = currentPoints;

      // Button is always enabled - page closes after each point earned
      elements.earnPointBtn.disabled = false;

    } catch (err) {
      console.log('Init error:', err);
      showMessage(elements.errorMsg, 'Failed to load page');
      showSection(sections.notLoggedIn);
    }
  }

  // Debounced earn point function to prevent rapid clicking
  const debouncedEarnPoint = debounce(async () => {
    if (!currentUser || isProcessing) return;

    try {
      isProcessing = true;
      elements.earnPointBtn.disabled = true;
      elements.earnPointBtn.textContent = 'Adding Point...';

      const newPoints = currentPoints + 1;
      await updatePointsAndClose(currentUser.id, currentUsername, newPoints);

    } catch (err) {
      console.log('Earn point error:', err);
      showMessage(elements.errorMsg, 'Error earning point');
      elements.earnPointBtn.disabled = false;
      elements.earnPointBtn.textContent = 'Earn Game Point';
      isProcessing = false;
    }
  }, 300); // 300ms debounce

  // Event listeners
  elements.loginBtn.addEventListener('click', () => {
    supabase.auth.signInWithOAuth({ 
      provider: 'github',
      options: { redirectTo: window.location.href }
    });
  });

  elements.earnPointBtn.addEventListener('click', debouncedEarnPoint);

  // Auth listener with debouncing
  const debouncedAuthChange = debounce((event) => {
    if (event === 'SIGNED_IN') {
      window.location.reload();
    } else if (event === 'SIGNED_OUT') {
      showSection(sections.notLoggedIn);
    }
  }, 100);

  supabase.auth.onAuthStateChange(debouncedAuthChange);

  // Start initialization
  init();
</script>

</body>
</html>
