<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP Game Point Page</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rubik+Mono+One&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1b1b2e, #2c1b33);
            color: #fefefe;
            font-family: 'Rubik Mono One', sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: linear-gradient(135deg, #2f1a39, #3d2447);
            border: 3px solid #ff4f9f;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 8px 32px rgba(255, 79, 159, 0.3);
            min-height: 400px;
            position: relative;
        }

        /* Smooth transitions for all sections */
        .section {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease-in-out;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) translateY(20px);
            width: calc(100% - 80px);
        }

        .section.active {
            opacity: 1;
            transform: translate(-50%, -50%) translateY(0);
        }

        .section.loading {
            position: static;
            transform: none;
            width: auto;
        }

        .section.loading.active {
            transform: none;
        }

        h1 {
            color: #ff4f9f;
            font-size: 2.2em;
            margin-bottom: 30px;
            text-shadow: 0 0 20px rgba(255, 79, 159, 0.5);
        }

        .status-card {
            padding: 20px;
            border-radius: 12px;
            margin: 25px 0;
            border: 2px solid;
            font-weight: 700;
        }

        .vip-status {
            color: #2ecc71;
            background: rgba(46, 204, 113, 0.1);
            border-color: #2ecc71;
        }

        .not-vip {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            border-color: #e74c3c;
        }

        .loading {
            color: #3498db;
            background: rgba(52, 152, 219, 0.1);
            border-color: #3498db;
        }

        .points-display {
            background: rgba(42, 35, 58, 0.9);
            padding: 30px;
            border-radius: 16px;
            margin: 30px 0;
            border: 3px solid #ffd700;
        }

        #game-points {
            font-size: 3em;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            margin: 15px 0;
            transition: transform 0.3s ease;
        }

        #game-points.updated {
            transform: scale(1.2);
        }

        button {
            background: linear-gradient(135deg, #ff4f9f, #e33f8a);
            color: #1b1b2e;
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 700;
            font-family: 'Rubik Mono One', sans-serif;
            margin: 15px 5px;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(227, 63, 138, 0.6);
        }

        button:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
            transform: none;
        }

        .message {
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .message.show {
            opacity: 1;
            transform: translateY(0);
        }

        .success-message {
            background: rgba(46, 204, 113, 0.1);
            color: #5dff5d;
            border-color: #2ecc71;
        }

        .error-message {
            background: rgba(231, 76, 60, 0.1);
            color: #ff6b6b;
            border-color: #e74c3c;
        }

        .user-info {
            background: rgba(42, 35, 58, 0.8);
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #ff4f9f;
        }

        .user-info img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #ff4f9f;
            margin: 10px 0;
        }

        /* Loading spinner */
        .spinner {
            border: 4px solid rgba(52, 152, 219, 0.3);
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 25px 20px;
            }
            
            h1 {
                font-size: 1.6em;
            }
            
            #game-points {
                font-size: 2.5em;
            }
            
            button {
                width: 100%;
                max-width: 300px;
            }

            .section {
                width: calc(100% - 40px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ VIP Game Point Page</h1>
        
        <!-- Loading State -->
        <div id="loading" class="section loading active">
            <div class="status-card loading">
                <div class="spinner"></div>
                <p>Loading...</p>
            </div>
        </div>

        <!-- Not Logged In -->
        <div id="not-logged-in" class="section">
            <div class="status-card not-vip">
                <p>üîê Please log in to access VIP features!</p>
                <button id="login-btn">Login with GitHub</button>
            </div>
        </div>

        <!-- Not VIP -->
        <div id="not-vip" class="section">
            <div class="status-card not-vip">
                <p>‚≠ê This page is for VIP members only!</p>
                <p>Upgrade to VIP to earn game points.</p>
                <button onclick="window.location.href='index.html'">Go to Main Page</button>
            </div>
        </div>

        <!-- VIP Content -->
        <div id="vip-content" class="section">
            <div class="user-info" id="user-info">
                <!-- User info populated by JS -->
            </div>

            <div class="status-card vip-status">
                <p>‚≠ê VIP Member - Game Points Available!</p>
            </div>

            <div class="points-display">
                <p>Your Current Game Points:</p>
                <div id="game-points">0</div>
            </div>
            
            <p>üéØ Reach 10 points and this page will close!</p>

            <button id="earn-point-btn">Earn Game Point</button>

            <!-- Messages -->
            <div id="success-msg" class="message success-message">
                <p>üéâ Game point earned successfully!</p>
            </div>

            <div id="error-msg" class="message error-message">
                <p id="error-text">An error occurred</p>
            </div>

            <div id="max-points-msg" class="message success-message">
                <p>üéä Maximum points reached! Page will close soon...</p>
            </div>
        </div>
    </div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

  const supabase = createClient(
    'https://fwslmbzfukriibnkpzou.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3c2xtYnpmdWtyaWlibmtwem91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4NTcxMDcsImV4cCI6MjA2NDQzMzEwN30.juWK3T16_-LGHPii7xLp92Tt5TAZKN3IcZVn6nR8cBA'
  );

  // State
  let currentUser = null;
  let currentUsername = null;
  let currentPoints = 0;

  // DOM elements
  const loading = document.getElementById('loading');
  const notLoggedIn = document.getElementById('not-logged-in');
  const notVip = document.getElementById('not-vip');
  const vipContent = document.getElementById('vip-content');
  const userInfo = document.getElementById('user-info');
  const gamePointsDisplay = document.getElementById('game-points');
  const loginBtn = document.getElementById('login-btn');
  const earnPointBtn = document.getElementById('earn-point-btn');
  const successMsg = document.getElementById('success-msg');
  const errorMsg = document.getElementById('error-msg');
  const errorText = document.getElementById('error-text');
  const maxPointsMsg = document.getElementById('max-points-msg');

  // Smooth transition function
  function showSection(targetSection) {
    const sections = [loading, notLoggedIn, notVip, vipContent];
    
    sections.forEach(section => {
      if (section === targetSection) {
        setTimeout(() => {
          section.classList.add('active');
        }, 50);
      } else {
        section.classList.remove('active');
      }
    });
  }

  function showMessage(messageEl, text = null, duration = 3000) {
    if (text && messageEl === errorMsg) {
      errorText.textContent = text;
    }
    
    messageEl.classList.add('show');
    setTimeout(() => {
      messageEl.classList.remove('show');
    }, duration);
  }

  function hideAllMessages() {
    [successMsg, errorMsg, maxPointsMsg].forEach(el => {
      el.classList.remove('show');
    });
  }

  function animatePointsUpdate() {
    gamePointsDisplay.classList.add('updated');
    setTimeout(() => {
      gamePointsDisplay.classList.remove('updated');
    }, 300);
  }

  // Check VIP status - SIMPLE VERSION
  async function checkVIPStatus(userId) {
    try {
      // First check localStorage
      const localVIP = localStorage.getItem('vipAccess') === 'true';
      console.log('LocalStorage VIP:', localVIP);

      // Check database
      const { data, error } = await supabase
        .from('users')
        .select('is_vip')
        .eq('id', userId)
        .single();

      if (error) {
        console.log('Database error, using localStorage:', error);
        return localVIP;
      }

      const dbVIP = data?.is_vip === true;
      console.log('Database VIP:', dbVIP);

      // Use database as truth, update localStorage
      if (dbVIP) {
        localStorage.setItem('vipAccess', 'true');
      }

      return dbVIP || localVIP;
    } catch (err) {
      console.log('VIP check error:', err);
      return localStorage.getItem('vipAccess') === 'true';
    }
  }

  // Get current points
  async function getCurrentPoints(userId) {
    try {
      const { data, error } = await supabase
        .from('vip_page_views')
        .select('game_points')
        .eq('user_id', userId)
        .single();

      if (error && error.code !== 'PGRST116') {
        console.log('Points fetch error:', error);
        return 0;
      }

      return data?.game_points || 0;
    } catch (err) {
      console.log('Points error:', err);
      return 0;
    }
  }

  // Update points
  async function updatePoints(userId, username, newPoints) {
    try {
      const { data, error } = await supabase
        .from('vip_page_views')
        .upsert({
          user_id: userId,
          username: username,
          game_points: newPoints,
          view_count: 1,
          last_viewed_at: new Date().toISOString()
        })
        .select();

      if (error) {
        console.log('Points update error:', error);
        return false;
      }

      return true;
    } catch (err) {
      console.log('Points update error:', err);
      return false;
    }
  }

  // Initialize page with smooth transitions
  async function init() {
    try {
      hideAllMessages();
      
      // Add a small delay to ensure smooth loading
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Get session
      const { data: { session } } = await supabase.auth.getSession();
      
      if (!session?.user) {
        showSection(notLoggedIn);
        return;
      }

      currentUser = session.user;
      currentUsername = session.user.user_metadata?.user_name || 
                       session.user.user_metadata?.preferred_username ||
                       session.user.email?.split('@')[0] || 'User';

      console.log('User:', currentUser.id, currentUsername);

      // Check VIP status
      const isVIP = await checkVIPStatus(currentUser.id);
      console.log('Is VIP:', isVIP);

      if (!isVIP) {
        showSection(notVip);
        return;
      }

      // Prepare VIP content before showing
      const avatar = currentUser.user_metadata?.avatar_url || '';
      const fullName = currentUser.user_metadata?.full_name || currentUsername;
      
      userInfo.innerHTML = `
        <h3>Welcome, ${fullName}!</h3>
        ${avatar ? `<img src="${avatar}" alt="${fullName}">` : ''}
        <p><strong>Username:</strong> ${currentUsername}</p>
        <p><strong>Status:</strong> ‚≠ê VIP Member</p>
      `;

      // Get current points
      currentPoints = await getCurrentPoints(currentUser.id);
      gamePointsDisplay.textContent = currentPoints;

      // Check if maxed out
      if (currentPoints >= 10) {
        earnPointBtn.disabled = true;
        earnPointBtn.textContent = 'Max Points Reached!';
      }

      // Show VIP content
      showSection(vipContent);

      // Show max points message if needed
      if (currentPoints >= 10) {
        setTimeout(() => {
          showMessage(maxPointsMsg, null, 5000);
          setTimeout(() => {
            alert('üéä Congratulations! Maximum points reached!');
            window.close();
          }, 3000);
        }, 500);
      }

    } catch (err) {
      console.log('Init error:', err);
      showMessage(errorMsg, 'Failed to load page');
      showSection(notLoggedIn);
    }
  }

  // Event listeners
  loginBtn.addEventListener('click', () => {
    supabase.auth.signInWithOAuth({ 
      provider: 'github',
      options: { redirectTo: window.location.href }
    });
  });

  earnPointBtn.addEventListener('click', async () => {
    if (!currentUser) return;

    try {
      earnPointBtn.disabled = true;
      earnPointBtn.textContent = 'Adding...';

      if (currentPoints >= 10) {
        showMessage(errorMsg, 'Maximum points already reached!');
        return;
      }

      const newPoints = currentPoints + 1;
      const success = await updatePoints(currentUser.id, currentUsername, newPoints);

      if (success) {
        currentPoints = newPoints;
        gamePointsDisplay.textContent = currentPoints;
        animatePointsUpdate();
        showMessage(successMsg);

        if (currentPoints >= 10) {
          earnPointBtn.textContent = 'Max Points Reached!';
          showMessage(maxPointsMsg, null, 5000);
          setTimeout(() => {
            alert('üéä Congratulations! Maximum points reached!');
            window.close();
          }, 2000);
        } else {
          earnPointBtn.disabled = false;
          earnPointBtn.textContent = 'Earn Game Point';
        }
      } else {
        showMessage(errorMsg, 'Failed to update points');
        earnPointBtn.disabled = false;
        earnPointBtn.textContent = 'Earn Game Point';
      }
    } catch (err) {
      console.log('Earn point error:', err);
      showMessage(errorMsg, 'Error earning point');
      earnPointBtn.disabled = false;
      earnPointBtn.textContent = 'Earn Game Point';
    }
  });

  // Auth listener
  supabase.auth.onAuthStateChange((event) => {
    if (event === 'SIGNED_IN') {
      window.location.reload();
    } else if (event === 'SIGNED_OUT') {
      showSection(notLoggedIn);
    }
  });

  // Start
  init();
</script>

</body>
</html>
