<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BrownDogGames</title>
  <link rel="icon" href="https://raw.githubusercontent.com/ItsMeDevX/BrownDogGames/main/LogoDog.ico" type="image/x-icon">
</head>
  
 <meta name="description" content="Discover and play free games, watch videos, and explore art. Join the BrownDogGames community and support creators.">
 <meta name="keywords" content="free games, indie games, game community, discover games, videos, art, game platform, creators">
 <meta name="author" content="BrownDogGames">
 <meta property="og:title" content="BrownDogGames - Discover Games, Videos & Art">

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1336090735244829"
crossorigin="anonymous"></script>
  
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BrownDogGames - Adult Cartoon Games</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Rubik+Mono+One&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@700&display=swap');

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Rubik Mono One', sans-serif;
      background-color: #1e1b2e;
      color: #fefefe;
      min-height: 100vh;
      padding: 20px;
      background-image: linear-gradient(135deg, #2c1b33, #191425);
      text-align: center;
    }

    /* Access Choice Gate */
    #access-choice-gate {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      justify-content: flex-start;
      align-items: center;
      flex-direction: column;
      z-index: 10000;
      color: #ff69b4;
      font-family: 'Rubik Mono One', sans-serif;
      text-align: center;
      padding: 20px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    #access-choice-gate.show {
      display: flex;
    }

    .choice-gate-content {
      background: #2a243b;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 0 30px rgba(255, 105, 180, 0.5);
      max-width: 800px;
      width: 90%;
      margin: 20px auto;
    }

    .access-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin: 30px 0;
    }

    .access-option {
      background: #3b3750;
      padding: 30px 20px;
      border-radius: 12px;
      border: 3px solid transparent;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .access-option:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }

    .access-option.vip {
      border-color: #2ecc71;
      background: linear-gradient(135deg, #2d4a3a, #3b4d42);
    }

    .access-option.vip:hover {
      border-color: #27ae60;
      box-shadow: 0 10px 25px rgba(46, 204, 113, 0.3);
    }

    .access-option.free {
      border-color: #3498db;
      background: linear-gradient(135deg, #2c3e50, #34495e);
    }

    .access-option.free:hover {
      border-color: #2980b9;
      box-shadow: 0 10px 25px rgba(52, 152, 219, 0.3);
    }

    .access-option h3 {
      font-size: 1.5rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .access-option.vip h3 {
      color: #2ecc71;
    }

    .access-option.free h3 {
      color: #3498db;
    }

    .access-option .price {
      font-size: 2rem;
      font-weight: bold;
      margin: 15px 0;
    }

    .access-option.vip .price {
      color: #2ecc71;
    }

    .access-option.free .price {
      color: #3498db;
    }

    .feature-list {
      list-style: none;
      text-align: left;
      margin: 20px 0;
    }

    .feature-list li {
      padding: 8px 0;
      color: #ffc0cb;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
    }

    .feature-list .icon {
      width: 20px;
      text-align: center;
    }

    .vip-only-features {
      background: #2d4a3a;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border-left: 4px solid #2ecc71;
    }

    .free-features {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border-left: 4px solid #3498db;
    }

    /* VIP Process Steps */
    .vip-process {
      display: none;
      margin-top: 30px;
    }

    .vip-step {
      background: #3b3750;
      padding: 20px;
      border-radius: 8px;
      margin: 15px 0;
      border: 2px solid #ff69b4;
    }

    .vip-step.completed {
      background: #2a4d3a;
      border-color: #2ecc71;
    }

    .vip-step h4 {
      color: #ff69b4;
      margin-bottom: 15px;
      font-size: 1.1rem;
    }

    .vip-step.completed h4 {
      color: #2ecc71;
    }

    #github-login-btn {
      background: #333;
      color: #fff;
      border: none;
      padding: 12px 24px;
      font-weight: bold;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      margin: 10px 0;
    }

    #github-login-btn:hover {
      background: #555;
    }

    #github-login-btn:disabled {
      background: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .login-status {
      color: #2ecc71;
      font-size: 0.9rem;
      margin-top: 10px;
      display: none;
    }

    .login-status.show {
      display: block;
    }

    #vip-paypal-container {
      margin: 20px 0;
    }

    .gate-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .gate-buttons button {
      background: #666;
      color: #fff;
      border: none;
      padding: 12px 24px;
      font-weight: bold;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      min-width: 150px;
    }

    .gate-buttons button:hover {
      background: #888;
    }

    .gate-buttons button.primary {
      background: #ff69b4;
      color: #1e1b2e;
    }

    .gate-buttons button.primary:hover {
      background: #ff8edb;
    }

    #access-message {
      margin: 15px 0;
      padding: 12px;
      border-radius: 8px;
      display: none;
      font-size: 0.9rem;
    }

    .success-message {
      background: #2ecc71;
      color: white;
    }

    .error-message {
      background: #e74c3c;
      color: white;
    }

    .access-note {
      background: #3b3750;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      border: 2px solid #ff69b4;
      color: #ffc0cb;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .access-note strong {
      color: #ff69b4;
    }

    /* Taskbar */
    #taskbar {
      max-width: 1200px;
      margin: 20px auto;
      background-color: #2a243b;
      border-radius: 12px;
      box-shadow: 0 0 12px #00000055;
      padding: 15px 20px;
      font-family: 'Rubik Mono One', sans-serif;
      color: #fefefe;
      position: relative;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 20px;
    }

    .taskbar-logo {
      display: flex;
      align-items: center;
    }

    .taskbar-logo img {
      height: 90px;
      width: auto;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .taskbar-logo img:hover {
      transform: scale(1.1);
    }

    .taskbar-nav {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .taskbar-nav button {
      background-color: #ff69b4;
      color: #1e1b2e;
      border: none;
      padding: 0.5rem 1rem;
      font-weight: bold;
      font-size: 0.9rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
      white-space: nowrap;
    }

    .taskbar-nav button:hover {
      background-color: #ff8edb;
    }

    .taskbar-nav button.vip-only {
      background-color: #666;
      color: #999;
      cursor: not-allowed;
      position: relative;
    }

    .taskbar-nav button.vip-only:hover::after {
      content: "VIP Only";
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      white-space: nowrap;
    }

    .taskbar-search {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }

    .taskbar-search input {
      width: 200px;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      background-color: #3b3750;
      color: #fefefe;
    }

    .taskbar-search button {
      background-color: #ff69b4;
      color: #1e1b2e;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s;
    }

    .taskbar-search button:hover {
      background-color: #ff8edb;
    }

    /* Message Notifications */
    .taskbar-messages {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }

    .messages-button {
      background-color: #ff69b4;
      color: #1e1b2e;
      border: none;
      padding: 8px 16px;
      font-weight: bold;
      font-size: 0.9rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .messages-button:hover {
      background-color: #ff8edb;
      transform: scale(1.05);
    }

    .messages-button.has-unread {
      background: linear-gradient(45deg, #ff69b4, #ff1493);
      animation: pulse-glow 2s infinite;
    }

    .message-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: linear-gradient(45deg, #ff4444, #ff6666);
      color: white;
      border-radius: 50%;
      min-width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
      border: 2px solid #2a243b;
      animation: bounce-badge 1s infinite;
    }

    @keyframes pulse-glow {
      0%, 100% {
        box-shadow: 0 0 5px rgba(255, 105, 180, 0.5);
      }
      50% {
        box-shadow: 0 0 20px rgba(255, 105, 180, 0.8);
      }
    }

    @keyframes bounce-badge {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
    }

    .message-preview-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background-color: #2a243b;
      border: 2px solid #ff69b4;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
      min-width: 320px;
      max-width: 400px;
      display: none;
      flex-direction: column;
      z-index: 1000;
      margin-top: 10px;
      max-height: 400px;
      overflow-y: auto;
    }

    .message-preview-dropdown.show {
      display: flex;
    }

    .message-preview-header {
      background: #3b3750;
      padding: 12px 16px;
      border-bottom: 1px solid #ff69b4;
      font-weight: bold;
      color: #ff69b4;
      text-align: center;
      border-radius: 10px 10px 0 0;
    }

    .message-preview-item {
      padding: 12px 16px;
      border-bottom: 1px solid #3b3750;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .message-preview-item:hover {
      background-color: #3b3750;
    }

    .message-preview-item.unread {
      background: linear-gradient(90deg, rgba(255, 105, 180, 0.1), transparent);
      border-left: 3px solid #ff69b4;
    }

    .message-preview-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      border: 2px solid #ff69b4;
      object-fit: cover;
      flex-shrink: 0;
    }

    .message-preview-content {
      flex: 1;
      min-width: 0;
    }

    .message-preview-sender {
      font-weight: bold;
      color: #ff69b4;
      font-size: 0.9rem;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .message-preview-text {
      color: #fefefe;
      font-size: 0.8rem;
      line-height: 1.3;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .message-preview-time {
      color: #999;
      font-size: 0.7rem;
      margin-top: 2px;
    }

    .message-preview-footer {
      padding: 10px 16px;
      text-align: center;
      border-top: 1px solid #3b3750;
      background: #3b3750;
      border-radius: 0 0 10px 10px;
    }

    .message-preview-footer button {
      background: linear-gradient(45deg, #ff69b4, #ff8edb);
      color: #1e1b2e;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.8rem;
    }

    .message-preview-footer button:hover {
      transform: scale(1.05);
    }

    .no-messages {
      text-align: center;
      color: #999;
      font-style: italic;
      padding: 20px;
      font-size: 0.9rem;
    }

    .taskbar-vip {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .taskbar-vip button {
      background-color: #ff69b4;
      color: #1e1b2e;
      border: none;
      padding: 8px 16px;
      font-weight: bold;
      font-size: 0.9rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .taskbar-vip button:hover {
      background-color: #ff8edb;
    }

    .vip-status {
      color: #2ecc71;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .free-status {
      color: #3498db;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .taskbar-auth {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }

    .taskbar-auth button {
      background-color: #ff69b4;
      color: #1e1b2e;
      border: none;
      padding: 8px 16px;
      font-weight: bold;
      font-size: 0.9rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .taskbar-auth button:hover {
      background-color: #ff8edb;
    }

    /* Dropdown styles */
    #suggestions-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background-color: #3b3750;
      border-radius: 8px;
      box-shadow: 0 4px 12px #00000077;
      display: none;
      flex-direction: column;
      z-index: 10;
      margin-top: 5px;
    }

    #suggestions-dropdown > div {
      padding: 8px 12px;
      cursor: pointer;
      transition: background-color 0.2s;
      color: #fefefe;
    }

    #suggestions-dropdown > div:hover {
      background-color: #ff69b4;
      color: #1e1b2e;
    }

    #user-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background-color: #3b3750;
      border: 2px solid #ff69b4;
      border-radius: 8px;
      box-shadow: 0 4px 12px #00000077;
      min-width: 150px;
      display: none;
      flex-direction: column;
      z-index: 1000;
      margin-top: 5px;
    }

    #user-dropdown button {
      background: none;
      border: none;
      color: #fefefe;
      padding: 12px 16px;
      text-align: left;
      font-weight: bold;
      font-family: 'Rubik Mono One', sans-serif;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
      width: 100%;
      border-radius: 0;
    }

    #user-dropdown button:hover {
      background-color: #ff69b4;
      color: #1e1b2e;
    }

    #user-dropdown button:first-child {
      border-radius: 6px 6px 0 0;
    }

    #user-dropdown button:last-child {
      border-radius: 0 0 6px 6px;
    }

    #user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }

    #user-info img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid #ff69b4;
      object-fit: cover;
    }

    @media (max-width: 900px) {
      #taskbar {
        max-width: 95%;
        flex-direction: column;
        gap: 15px;
        text-align: center;
        padding: 20px;
      }

      .taskbar-logo img {
        height: 75px;
      }

      .taskbar-nav {
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
      }

      .taskbar-search input {
        width: 200px;
      }

      .access-options {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .gate-buttons {
        flex-direction: column;
        align-items: center;
      }

      .choice-gate-content {
        padding: 20px 15px;
        margin: 10px;
        max-width: 95%;
      }

      .message-preview-dropdown {
        right: -50px;
        min-width: 280px;
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 10px;
      }

      .taskbar-logo img {
        height: 65px;
      }

      .choice-gate-content {
        padding: 15px 10px;
        margin: 5px;
      }

      .access-option {
        padding: 20px 15px;
      }

      .access-option h3 {
        font-size: 1.2rem;
      }

      .access-option .price {
        font-size: 1.5rem;
      }

      .message-preview-dropdown {
        right: -100px;
        min-width: 260px;
      }
    }
  </style>
</head>
<body>

<!-- Access Choice Gate -->
<div id="access-choice-gate">
  <div class="choice-gate-content">
    <h2>🎮 Welcome to BrownDogGames</h2>
    <p>Choose your access level - VIP membership or free browsing:</p>

    <div class="access-note">
      <strong>📌 Note:</strong> Anyone can post content, games, art, and videos to earn money! VIP membership unlocks exclusive community features and premium content sharing with other VIP members.
    </div>

    <div class="access-options">
      <!-- VIP Option -->
      <div class="access-option vip" id="vip-option">
        <h3>⭐ VIP Access</h3>
        <div class="price">£2/month</div>
        <ul class="feature-list">
          <li><span class="icon">👑</span> Exclusive VIP Members Dashboard</li>
          <li><span class="icon">💬</span> Direct messaging with VIP members</li>
          <li><span class="icon">🎁</span> Share exclusive content with VIPs</li>
          <li><span class="icon">📊</span> Advanced member statistics</li>
          <li><span class="icon">✨</span> VIP content creation & sharing</li>
          <li><span class="icon">🏆</span> Priority support & features</li>
        </ul>
        <div class="vip-only-features">
          <strong>Premium Features:</strong> VIP-only dashboard, exclusive content sharing, member-to-member messaging, and premium community access
        </div>
      </div>

      <!-- Free Option -->
      <div class="access-option free" id="free-option">
        <h3>🆓 Free Access</h3>
        <div class="price">Free</div>
        <ul class="feature-list">
          <li><span class="icon">🎮</span> Browse & play all public games</li>
          <li><span class="icon">👀</span> View all user profiles</li>
          <li><span class="icon">🖼️</span> See user art & videos</li>
          <li><span class="icon">📤</span> Post your own content & games</li>
          <li><span class="icon">💰</span> Earn money from your uploads</li>
          <li><span class="icon">🔍</span> Search & discover content</li>
        </ul>
        <div class="free-features">
          <strong>Free Features:</strong> Full access to browse content, post your own creations, and earn money - perfect for creators and casual users
        </div>
      </div>
    </div>

    <!-- VIP Process (hidden initially) -->
    <div class="vip-process" id="vip-process">
      <div class="vip-step" id="login-step">
        <h4>Step 1: Create Account</h4>
        <p>Login with GitHub to create your VIP account</p>
        <button id="github-login-btn">🔑 Login with GitHub</button>
        <div class="login-status" id="login-status">✅ Successfully logged in!</div>
      </div>

      <div class="vip-step" id="payment-step" style="display: none;">
        <h4>Step 2: Subscribe for VIP Access</h4>
        <p>Subscribe to VIP for just £2/month - unlocks exclusive member features and premium community access!</p>
        <div id="vip-paypal-container"></div>
      </div>
    </div>
      
    <div id="access-message"></div>
      
    <div class="gate-buttons">
      <button id="back-to-options" style="display: none;">← Back to Options</button>
    </div>
  </div>
</div>

<!-- Taskbar -->
<div id="taskbar">
  <div class="taskbar-logo">
    <img 
      src="https://raw.githubusercontent.com/ItsMeDevX/BrownDogGames/main/BrownDogGamesLogo.png" 
      alt="BrownDogGames Logo"
      onclick="window.location.href='index.html'"
    >
  </div>

  <div class="taskbar-nav" id="taskbar-nav">
    <!-- Navigation buttons injected by JS -->
  </div>
  
  <div class="taskbar-search">
    <input type="text" id="game-search-input" placeholder="Search games..." />
    <button id="search-button">Search</button>
    <div id="suggestions-dropdown"></div>
  </div>

  <!-- Message Notifications -->
  <div class="taskbar-messages" id="taskbar-messages" style="display: none;">
    <button class="messages-button" id="messages-button">
      💬 Messages
      <span class="message-badge" id="message-badge" style="display: none;">0</span>
    </button>
    <div class="message-preview-dropdown" id="message-preview-dropdown">
      <div class="message-preview-header">Recent Messages</div>
      <div id="message-preview-list">
        <div class="no-messages">No new messages</div>
      </div>
      <div class="message-preview-footer">
        <button onclick="window.location.href='user-profiles.html'">View All Messages</button>
      </div>
    </div>
  </div>

  <div class="taskbar-vip" id="taskbar-vip">
    <!-- VIP button/status injected by JS -->
  </div>
  
  <div class="taskbar-auth" id="taskbar-auth">
    <!-- Auth content injected by JS -->
  </div>
</div>

<!-- Scripts -->
<script src="https://www.paypal.com/sdk/js?client-id=AYgrpkjHd7Ycq_8vUWm9nb3qigcwALSTbyMZ5o6LjMqjC1YscFwQ_1kDEMr7tm2D1xysfHSEiyhZ1pZl&vault=true&intent=subscription"></script>

<script>
  // Global variables
  let gateUser = null;
  let supabaseClient = null;
  let authInitialized = false;
  let messageUpdateInterval = null;

  // Access Management
  document.addEventListener('DOMContentLoaded', () => {
    const accessChoiceGate = document.getElementById('access-choice-gate');
    const vipOption = document.getElementById('vip-option');
    const freeOption = document.getElementById('free-option');
    const vipProcess = document.getElementById('vip-process');
    const backToOptionsBtn = document.getElementById('back-to-options');
    const accessMessage = document.getElementById('access-message');
    const githubLoginBtn = document.getElementById('github-login-btn');
    const loginStep = document.getElementById('login-step');
    const paymentStep = document.getElementById('payment-step');
    const loginStatus = document.getElementById('login-status');

    // Check if user already has access
    function checkExistingAccess() {
      const hasVIPAccess = localStorage.getItem('vipAccess') === 'true';
      const hasFreeAccess = localStorage.getItem('freeAccess') === 'true';

      // If user has any access, don't show gate
      if (hasVIPAccess || hasFreeAccess) {
        return true;
      }
      return false;
    }

    // Show access gate if no existing access
    if (!checkExistingAccess()) {
      accessChoiceGate.classList.add('show');
    }

    // VIP Option Click
    vipOption.addEventListener('click', () => {
      vipProcess.style.display = 'block';
      backToOptionsBtn.style.display = 'inline-block';
      document.querySelector('.access-options').style.display = 'none';
    });

    // Free Option Click
    freeOption.addEventListener('click', () => {
      // Grant free access
      localStorage.setItem('freeAccess', 'true');
      
      showAccessMessage('🎉 Free access granted! Welcome to BrownDogGames!');
      
      setTimeout(() => {
        accessChoiceGate.classList.remove('show');
        // Re-render taskbar to show free status
        if (window.renderVip) {
          window.renderVip();
        }
      }, 2000);
    });

    // Back to Options
    backToOptionsBtn.addEventListener('click', () => {
      vipProcess.style.display = 'none';
      backToOptionsBtn.style.display = 'none';
      document.querySelector('.access-options').style.display = 'grid';
      hideAccessMessage();
    });

    // GitHub Login
    githubLoginBtn.addEventListener('click', () => {
      githubLoginBtn.disabled = true;
      githubLoginBtn.textContent = 'Connecting...';
      
      if (window.supabaseClient) {
        window.supabaseClient.auth.signInWithOAuth({ provider: 'github' });
      } else {
        showAccessMessage('Loading login system...', true);
        setTimeout(() => {
          if (window.supabaseClient) {
            window.supabaseClient.auth.signInWithOAuth({ provider: 'github' });
          } else {
            githubLoginBtn.disabled = false;
            githubLoginBtn.textContent = '🔑 Login with GitHub';
            showAccessMessage('Login system failed to load. Please refresh the page.', true);
          }
        }, 2000);
      }
    });

    // Listen for login success
    let loginHandlerAdded = false;
    
    function addLoginHandler() {
      if (!loginHandlerAdded) {
        window.addEventListener('vip-user-logged-in', (event) => {
          gateUser = event.detail;
          showLoginSuccess();
        });
        loginHandlerAdded = true;
      }
    }
    
    addLoginHandler();

    function showLoginSuccess() {
      loginStep.classList.add('completed');
      githubLoginBtn.style.display = 'none';
      loginStatus.classList.add('show');
      
      setTimeout(() => {
        showPaymentStep();
      }, 1500);
    }

    function showPaymentStep() {
      paymentStep.style.display = 'block';
      
      setTimeout(() => {
        initVIPPayPal();
      }, 500);
    }

    function showAccessMessage(text, isError = false) {
      accessMessage.textContent = text;
      accessMessage.className = isError ? 'error-message' : 'success-message';
      accessMessage.style.display = 'block';
    }

    function hideAccessMessage() {
      accessMessage.style.display = 'none';
    }

    // Make initVIPPayPal available globally so upgrade button can use it
    window.initVIPPayPal = initVIPPayPal;

    function initVIPPayPal() {
      if (typeof paypal === 'undefined') {
        showAccessMessage('PayPal not loaded. Please refresh the page.', true);
        return;
      }

      if (!gateUser) {
        showAccessMessage('Please login first before subscribing.', true);
        return;
      }

      const container = document.getElementById('vip-paypal-container');
      if (container) {
        // Only clear if no active PayPal buttons exist
        if (!container.hasChildNodes() || !container.querySelector('.paypal-buttons')) {
          container.innerHTML = '';
        }
      }

      paypal.Buttons({
        style: {
          shape: 'rect',
          color: 'gold',
          layout: 'vertical',
          label: 'subscribe',
          height: 45
        },

        createSubscription(data, actions) {
          hideAccessMessage();
          return actions.subscription.create({
            plan_id: 'P-20H197268N8973414NBIXE2I'
          });
        },

        onApprove: async (data) => {
          hideAccessMessage();
          const subscriptionID = data.subscriptionID;

          try {
            // Save to database
            if (window.supabaseClient && gateUser) {
              const { error } = await window.supabaseClient
                .from('users')
                .upsert({
                  id: gateUser.id,
                  is_vip: true,
                  vip_expires_at: null,
                  paypal_transaction_id: subscriptionID
                });

              if (error) {
                console.error('Failed to update database:', error);
              }
            }

            // Grant VIP access
            localStorage.setItem('vipAccess', 'true');
            localStorage.setItem('vipSubscriptionId', subscriptionID);
            localStorage.setItem('vipActivatedAt', new Date().toISOString());

            showAccessMessage('🎉 VIP access activated! Welcome to BrownDogGames Premium!');

            setTimeout(() => {
              accessChoiceGate.classList.remove('show');
              if (window.renderVip) {
                window.renderVip();
              }
            }, 2000);

          } catch (error) {
            console.error('Error processing subscription:', error);
            showAccessMessage('Subscription successful, but there was an error. Please refresh the page.', true);
          }
        },

        onError: (err) => {
          console.error('PayPal error:', err);
          showAccessMessage('Payment error. Please try again or contact support.', true);
        },

        onCancel: (data) => {
          showAccessMessage('Payment cancelled. You can still choose free access instead.', true);
        }

      }).render('#vip-paypal-container');
    }

    // Check access every 30 seconds to prevent manipulation, only when page is not active
    setInterval(() => {
      if (document.hidden || !document.hasFocus()) {
        const hasVIPAccess = localStorage.getItem('vipAccess') === 'true';
        const hasFreeAccess = localStorage.getItem('freeAccess') === 'true';

        // If no access, show gate
        if (!(hasVIPAccess || hasFreeAccess)) {
          accessChoiceGate.classList.add('show');
        }
      }
    }, 30000);
  });

  // Message Notifications System
  function initMessageNotifications() {
    const messagesButton = document.getElementById('messages-button');
    const messagePreviewDropdown = document.getElementById('message-preview-dropdown');
    const messageBadge = document.getElementById('message-badge');
    
    if (!messagesButton) return;

    // Toggle dropdown
    messagesButton.addEventListener('click', (e) => {
      e.stopPropagation();
      const isVisible = messagePreviewDropdown.classList.contains('show');
      
      if (isVisible) {
        messagePreviewDropdown.classList.remove('show');
      } else {
        messagePreviewDropdown.classList.add('show');
        loadMessagePreviews();
      }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!messagePreviewDropdown.contains(e.target) && !messagesButton.contains(e.target)) {
        messagePreviewDropdown.classList.remove('show');
      }
    });
  }

  // Load message previews
  async function loadMessagePreviews() {
    const messagePreviewList = document.getElementById('message-preview-list');
    
    if (!window.supabaseClient || !window.currentUser || !window.currentUsername) {
      messagePreviewList.innerHTML = '<div class="no-messages">Please log in to see messages</div>';
      return;
    }

    try {
      // Get recent unread messages
      const { data: messages, error } = await window.supabaseClient
        .from('direct_messages')
        .select('*')
        .eq('recipient_username', window.currentUsername)
        .eq('is_read', false)
        .order('created_at', { ascending: false })
        .limit(5);

      if (error) {
        console.error('Error loading message previews:', error);
        messagePreviewList.innerHTML = '<div class="no-messages">Error loading messages</div>';
        return;
      }

      if (!messages || messages.length === 0) {
        messagePreviewList.innerHTML = '<div class="no-messages">No new messages</div>';
        return;
      }

      // Group by sender to show latest message from each
      const senderMap = new Map();
      for (const message of messages) {
        if (!senderMap.has(message.sender_username)) {
          senderMap.set(message.sender_username, message);
        }
      }

      const uniqueMessages = Array.from(senderMap.values());

      // Render message previews
      const previewsHtml = await Promise.all(uniqueMessages.map(async (message) => {
        const avatar = await getAvatarForUsername(message.sender_username);
        const time = new Date(message.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const preview = message.message_content.substring(0, 50) + (message.message_content.length > 50 ? '...' : '');
        
        return `
          <div class="message-preview-item unread" onclick="openUserProfile('${message.sender_username}')">
            ${avatar ? `<img src="${avatar}" alt="${message.sender_username}" class="message-preview-avatar">` : 
                      `<div class="message-preview-avatar" style="background: #ff4f9f; display: flex; align-items: center; justify-content: center; color: #1b1b2e; font-weight: bold; font-size: 0.8rem;">${message.sender_username.charAt(0).toUpperCase()}</div>`}
            <div class="message-preview-content">
              <div class="message-preview-sender">
                ${message.sender_username}
                <span class="message-preview-time">${time}</span>
              </div>
              <div class="message-preview-text">${preview}</div>
            </div>
          </div>
        `;
      }));

      messagePreviewList.innerHTML = previewsHtml.join('');

    } catch (error) {
      console.error('Error in loadMessagePreviews:', error);
      messagePreviewList.innerHTML = '<div class="no-messages">Error loading messages</div>';
    }
  }

  // Update message count and badge
  async function updateMessageNotifications() {
    if (!window.supabaseClient || !window.currentUser || !window.currentUsername) {
      return;
    }

    try {
      // Count unread messages
      const { count, error } = await window.supabaseClient
        .from('direct_messages')
        .select('*', { count: 'exact', head: true })
        .eq('recipient_username', window.currentUsername)
        .eq('is_read', false);

      if (error) {
        console.error('Error counting unread messages:', error);
        return;
      }

      const unreadCount = count || 0;
      const messagesButton = document.getElementById('messages-button');
      const messageBadge = document.getElementById('message-badge');
      const taskbarMessages = document.getElementById('taskbar-messages');

      if (unreadCount > 0) {
        // Show notifications
        taskbarMessages.style.display = 'flex';
        messagesButton.classList.add('has-unread');
        messageBadge.style.display = 'flex';
        messageBadge.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
      } else {
        // Hide badge but keep messages button visible for logged-in users
        messagesButton.classList.remove('has-unread');
        messageBadge.style.display = 'none';
        
        // Only show messages button if user is logged in
        if (window.currentUser) {
          taskbarMessages.style.display = 'flex';
        } else {
          taskbarMessages.style.display = 'none';
        }
      }

    } catch (error) {
      console.error('Error in updateMessageNotifications:', error);
    }
  }

  // Open user profile when clicking message preview
  window.openUserProfile = function(username) {
    const messagePreviewDropdown = document.getElementById('message-preview-dropdown');
    messagePreviewDropdown.classList.remove('show');
    
    // Mark messages from this user as read
    markMessagesAsRead(username);
    
    window.location.href = `user.html?user=${username}`;
  };

  // Mark messages as read when viewing
  async function markMessagesAsRead(senderUsername) {
    if (!window.supabaseClient || !window.currentUsername) return;
    
    try {
      const { error } = await window.supabaseClient
        .from('direct_messages')
        .update({ is_read: true })
        .eq('recipient_username', window.currentUsername)
        .eq('sender_username', senderUsername)
        .eq('is_read', false);
        
      if (error) {
        console.error('Error marking messages as read:', error);
      } else {
        // Update notification count immediately
        updateMessageNotifications();
      }
    } catch (error) {
      console.error('Error in markMessagesAsRead:', error);
    }
  }

  // Get avatar for username (helper function)
  async function getAvatarForUsername(username) {
    if (!window.supabaseClient) return null;
    
    try {
      // Try games first
      const { data: gameData } = await window.supabaseClient
        .from('game_submissions')
        .select('avatar_url')
        .eq('github_user', username)
        .limit(1);
      
      if (gameData && gameData.length > 0 && gameData[0].avatar_url) {
        return gameData[0].avatar_url;
      }

      // Try videos
      const { data: videoData } = await window.supabaseClient
        .from('game_videos')
        .select('avatar_url')
        .eq('github_username', username)
        .limit(1);
      
      if (videoData && videoData.length > 0 && videoData[0].avatar_url) {
        return videoData[0].avatar_url;
      }

      // Try art
      const { data: artData } = await window.supabaseClient
        .from('user_art')
        .select('avatar_url')
        .eq('github_username', username)
        .limit(1);
      
      if (artData && artData.length > 0 && artData[0].avatar_url) {
        return artData[0].avatar_url;
      }

      return null;
    } catch (error) {
      console.error('Error getting avatar:', error);
      return null;
    }
  }

  // Game Search
  const gamePages = [
    { title: 'Lapdance Dash', url: 'https://browndoggames.com/Lapdance-Dash.html' },
    { title: 'Naked Craft', url: 'https://browndoggames.com/naked-craft.html' },
    { title: 'Butt Blaster Arena', url: 'https://browndoggames.com/butt-blaster-arena.html' },
    { title: 'Streaker Run', url: 'https://browndoggames.com/streaker-run.html' },
    { title: 'Pet Penis Simulator', url: 'https://browndoggames.com/pet-penis-simulator.html' },
    { title: 'Naked Fang', url: 'https://browndoggames.com/naked-fang.html' },
    { title: 'Climax Clash', url: 'https://browndoggames.com/Climax-Clash.html' },
    { title: 'Shafted', url: 'https://browndoggames.com/Shafted.html' },
    { title: 'She Comes First', url: 'https://browndoggames.com/She-Comes-First.html' },
    { title: 'LustLab', url: 'https://browndoggames.com/LustLab.html' }
  ];

  const searchInput = document.getElementById('game-search-input');
  const suggestionsDropdown = document.getElementById('suggestions-dropdown');
  let highlightedIndex = -1;

  searchInput.addEventListener('input', () => {
    const query = searchInput.value.trim().toLowerCase();
    
    if (query) {
      const firstLetterMatches = gamePages.filter(game => 
        game.title.toLowerCase().startsWith(query[0])
      );

      const results = firstLetterMatches.concat(gamePages.filter(game => 
        game.title.toLowerCase().includes(query) && !game.title.toLowerCase().startsWith(query[0])
      ));

      if (results.length > 0) {
        suggestionsDropdown.style.display = 'flex';
        suggestionsDropdown.innerHTML = '';

        results.forEach((game, index) => {
          const suggestionItem = document.createElement('div');
          suggestionItem.innerHTML = game.title;
          suggestionItem.addEventListener('click', () => {
            window.location.href = game.url;
          });
          suggestionsDropdown.appendChild(suggestionItem);
        });
      } else {
        suggestionsDropdown.style.display = 'none';
      }
    } else {
      suggestionsDropdown.style.display = 'none';
    }
  });

  searchInput.addEventListener('keydown', (e) => {
    const suggestions = suggestionsDropdown.querySelectorAll('div');

    if (e.key === 'ArrowDown') {
      if (highlightedIndex < suggestions.length - 1) {
        highlightedIndex++;
        updateHighlightedItem(suggestions);
      }
    } else if (e.key === 'ArrowUp') {
      if (highlightedIndex > 0) {
        highlightedIndex--;
        updateHighlightedItem(suggestions);
      }
    } else if (e.key === 'Enter' && highlightedIndex >= 0) {
      suggestions[highlightedIndex].click();
    }
  });

  function updateHighlightedItem(suggestions) {
    suggestions.forEach((item, index) => {
      if (index === highlightedIndex) {
        item.style.backgroundColor = '#ff69b4';
        item.style.color = '#1e1b2e';
      } else {
        item.style.backgroundColor = 'transparent';
        item.style.color = '#fefefe';
      }
    });
  }

  document.getElementById('search-button').addEventListener('click', () => {
    const query = searchInput.value.trim().toLowerCase();
    const result = gamePages.find(game => game.title.toLowerCase() === query);

    if (result) {
      window.location.href = result.url;
    } else {
      alert('No game found for your search.');
    }
  });

  document.addEventListener('click', (event) => {
    if (!searchInput.contains(event.target) && !suggestionsDropdown.contains(event.target)) {
      suggestionsDropdown.style.display = 'none';
      highlightedIndex = -1;
    }
  });
</script>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

  const supabase = createClient(
    'https://fwslmbzfukriibnkpzou.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3c2xtYnpmdWtyaWlibmtwem91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4NTcxMDcsImV4cCI6MjA2NDQzMzEwN30.juWK3T16_-LGHPii7xLp92Tt5TAZKN3IcZVn6nR8cBA'
  );

  // Make supabase available globally
  window.supabaseClient = supabase;

  // Add error handling for Supabase initialization
  if (!supabase) {
    console.error('Failed to initialize Supabase client');
  }

  const taskbarNav = document.getElementById('taskbar-nav');
  const taskbarAuth = document.getElementById('taskbar-auth');
  const taskbarVip = document.getElementById('taskbar-vip');

  // Global state tracking
  let currentVIPStatus = false;
  let currentUser = null;
  let currentUsername = null;
  let isInitialized = false;
  let renderingInProgress = false;

  // State synchronization helper
  function syncAccessState() {
    const hasVIPAccess = localStorage.getItem('vipAccess') === 'true';
    const hasFreeAccess = localStorage.getItem('freeAccess') === 'true';
    
    // Update UI to match localStorage state
    if (window.renderVip) {
      window.renderVip();
    }
    
    // Update access gate visibility
    const accessChoiceGate = document.getElementById('access-choice-gate');
    if (accessChoiceGate) {
      if (hasVIPAccess || hasFreeAccess) {
        accessChoiceGate.classList.remove('show');
      } else {
        accessChoiceGate.classList.add('show');
      }
    }
  }

  // Make global variables accessible
  window.currentUser = null;
  window.currentUsername = null;

  function toggleDropdown(dropdown) {
    dropdown.style.display = (dropdown.style.display === 'flex') ? 'none' : 'flex';
  }

  async function checkVIPStatus(userId) {
    // Check local VIP access first
    const localVIP = localStorage.getItem('vipAccess') === 'true';
    
    if (localVIP) return true;
    if (!userId) return false;

    try {
      const { data: user, error } = await supabase
        .from('users')
        .select('is_vip')
        .eq('id', userId)
        .single();

      if (error) {
        console.error('Error fetching VIP status:', error);
        return false;
      }

      // If user is VIP in database, grant local access too
      if (user?.is_vip) {
        localStorage.setItem('vipAccess', 'true');
      }

      return user?.is_vip ?? false;
    } catch (error) {
      console.error('Exception in checkVIPStatus:', error);
      return false;
    }
  }

  function renderNav() {
    if (renderingInProgress) return;
    taskbarNav.innerHTML = '';

    // User Games (always available)
    const userGamesBtn = document.createElement('button');
    userGamesBtn.textContent = 'User Games';
    userGamesBtn.addEventListener('click', () => window.location.href = 'user-games.html');
    taskbarNav.appendChild(userGamesBtn);

    // User Video (always available)
    const userVideoBtn = document.createElement('button');
    userVideoBtn.textContent = 'User Video';
    userVideoBtn.addEventListener('click', () => window.location.href = 'user-videos.html');
    taskbarNav.appendChild(userVideoBtn);

    // User Art (always available)
    const userArtBtn = document.createElement('button');
    userArtBtn.textContent = 'User Art';
    userArtBtn.addEventListener('click', () => window.location.href = 'user-art.html');
    taskbarNav.appendChild(userArtBtn);

    // User Profiles (always available)
    const userProfilesBtn = document.createElement('button');
    userProfilesBtn.textContent = 'User Profiles';
    userProfilesBtn.addEventListener('click', () => window.location.href = 'user-profiles.html');
    taskbarNav.appendChild(userProfilesBtn);
  }

  async function renderVip() {
    if (renderingInProgress) return;
    
    taskbarVip.innerHTML = '';
    
    const hasVIPAccess = localStorage.getItem('vipAccess') === 'true';
    const hasFreeAccess = localStorage.getItem('freeAccess') === 'true';
    
    if (hasVIPAccess || currentVIPStatus) {
      const vipStatus = document.createElement('div');
      vipStatus.className = 'vip-status';
      vipStatus.innerHTML = '⭐ VIP Member';
      taskbarVip.appendChild(vipStatus);
    } else if (hasFreeAccess) {
      const freeStatus = document.createElement('div');
      freeStatus.className = 'free-status';
      freeStatus.innerHTML = '🆓 Free Member';
      taskbarVip.appendChild(freeStatus);

      // Add upgrade button for free users
      const upgradeBtn = document.createElement('button');
      upgradeBtn.textContent = 'Upgrade to VIP';
      upgradeBtn.style.background = 'linear-gradient(45deg, #2ecc71, #27ae60)';
      upgradeBtn.addEventListener('click', () => {
        // Show access gate with VIP process
        const accessGate = document.getElementById('access-choice-gate');
        if (accessGate) {
          // If user is already logged in, skip to payment step
          if (currentUser) {
            // Set the gate user
            gateUser = currentUser;
            
            // Hide options and show VIP process
            document.querySelector('.access-options').style.display = 'none';
            document.getElementById('vip-process').style.display = 'block';
            document.getElementById('back-to-options').style.display = 'inline-block';
            
            // Mark login as completed and show payment step
            const loginStep = document.getElementById('login-step');
            const paymentStep = document.getElementById('payment-step');
            const loginStatus = document.getElementById('login-status');
            
            loginStep.classList.add('completed');
            document.getElementById('github-login-btn').style.display = 'none';
            loginStatus.classList.add('show');
            paymentStep.style.display = 'block';
            
            // Initialize PayPal
            setTimeout(() => {
              initVIPPayPal();
            }, 500);
            
            accessGate.classList.add('show');
          } else {
            // User not logged in, show normal flow
            gateUser = null; // Ensure gateUser is reset
            document.querySelector('.access-options').style.display = 'grid';
            document.getElementById('vip-process').style.display = 'none';
            document.getElementById('back-to-options').style.display = 'none';
            accessGate.classList.add('show');
          }
        }
      });
      taskbarVip.appendChild(upgradeBtn);
    } else {
      const noAccessNote = document.createElement('div');
      noAccessNote.style.color = '#888';
      noAccessNote.style.fontSize = '0.8rem';
      noAccessNote.textContent = 'Choose Access Level';
      taskbarVip.appendChild(noAccessNote);
    }
  }

  async function renderAuth() {
    if (renderingInProgress) return;
    renderingInProgress = true;

    try {
      const { data: { session } } = await supabase.auth.getSession();
      
      taskbarAuth.innerHTML = '';
      
      const existingDropdown = document.getElementById('user-dropdown');
      if (existingDropdown) {
        existingDropdown.remove();
      }

      if (session?.user) {
        currentUser = session.user;
        window.currentUser = currentUser;
        
        // Get username from metadata
        currentUsername = session.user.user_metadata?.user_name || 
                         session.user.user_metadata?.preferred_username;
        
        if (!currentUsername) {
          // Fallback: Get from game submissions
          try {
            const { data: gameData } = await supabase
              .from('game_submissions')
              .select('github_user')
              .eq('user_id', currentUser.id)
              .limit(1);
            
            if (gameData && gameData.length > 0) {
              currentUsername = gameData[0].github_user;
            } else {
              // Final fallback to email
              currentUsername = currentUser.email;
            }
          } catch (error) {
            console.error('Error getting username:', error);
            currentUsername = currentUser.email;
          }
        }
        
        window.currentUsername = currentUsername;
        
        currentVIPStatus = await checkVIPStatus(session.user.id);
        
        // Notify VIP gate if it's showing and user isn't already set
        const accessGate = document.getElementById('access-choice-gate');
        if (accessGate && accessGate.classList.contains('show') && !gateUser) {
          window.dispatchEvent(new CustomEvent('vip-user-logged-in', { detail: session.user }));
        }
        
        const { user_metadata } = session.user;
        const name = user_metadata.full_name || 'GitHub User';
        const avatar = user_metadata.avatar_url || '';

        const userInfo = document.createElement('div');
        userInfo.id = 'user-info';

        if (avatar) {
          const img = document.createElement('img');
          img.src = avatar;
          img.alt = name;
          userInfo.appendChild(img);
        }

        const nameDiv = document.createElement('div');
        nameDiv.innerHTML = `
          <strong style="
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background-color: #ff69b4;
            color: #1e1b2e;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            box-shadow: 0 0 10px #ff8edb;
          " title="Click for options">
            ${name}
            <span style="font-size: 1.2rem; margin-left: 4px;">▾</span>
          </strong>
        `;
        userInfo.appendChild(nameDiv);
        taskbarAuth.appendChild(userInfo);

        const dropdown = document.createElement('div');
        dropdown.id = 'user-dropdown';

        const myPageBtn = document.createElement('button');
        myPageBtn.textContent = 'My Page';
        myPageBtn.onclick = async () => {
          dropdown.style.display = 'none';
          try {
            const { data: { user }, error: userError } = await supabase.auth.getUser();
            if (userError || !user) {
              console.error('Unable to get user:', userError);
              return;
            }

            const { data, error } = await supabase
              .from('game_submissions')
              .select('id')
              .eq('user_id', user.id)
              .limit(1);

            if (error) {
              console.error('Error checking submission:', error);
              return;
            }

            if (data && data.length > 0 && currentUsername) {
              window.location.href = `user.html?user=${currentUsername}`;
            } else {
              window.location.href = 'dashboard.html';
            }
          } catch (error) {
            console.error('Error in myPageBtn click:', error);
          }
        };

        const dashboardBtn = document.createElement('button');
        dashboardBtn.textContent = 'Dashboard';
        dashboardBtn.onclick = () => {
          dropdown.style.display = 'none';
          window.location.href = 'dashboard.html';
        };

        const logoutBtn = document.createElement('button');
        logoutBtn.textContent = 'Logout';
        logoutBtn.onclick = async () => {
          try {
            // Clear message update interval
            if (messageUpdateInterval) {
              clearInterval(messageUpdateInterval);
              messageUpdateInterval = null;
            }
            
            await supabase.auth.signOut();
            
            // Clear all access data on logout
            localStorage.removeItem('vipAccess');
            localStorage.removeItem('freeAccess');
            localStorage.removeItem('vipSubscriptionId');
            localStorage.removeItem('vipActivatedAt');
            
            currentUser = null;
            currentUsername = null;
            window.currentUser = null;
            window.currentUsername = null;
            currentVIPStatus = false;
            
            // Hide message notifications
            const taskbarMessages = document.getElementById('taskbar-messages');
            if (taskbarMessages) {
              taskbarMessages.style.display = 'none';
            }
            
            // Show access gate again after logout
            const accessChoiceGate = document.getElementById('access-choice-gate');
            if (accessChoiceGate) {
              accessChoiceGate.classList.add('show');
            }
            
            window.location.reload();
          } catch (error) {
            console.error('Error during logout:', error);
          }
        };

        dropdown.appendChild(myPageBtn);
        dropdown.appendChild(dashboardBtn);
        dropdown.appendChild(logoutBtn);

        taskbarAuth.appendChild(dropdown);
        userInfo.addEventListener('click', () => toggleDropdown(dropdown));

        // Start message notifications for logged-in users
        updateMessageNotifications();
        
        // Set up periodic message checking
        if (messageUpdateInterval) {
          clearInterval(messageUpdateInterval);
          messageUpdateInterval = null;
        }
        messageUpdateInterval = setInterval(updateMessageNotifications, 30000); // Check every 30 seconds

      } else {
        currentUser = null;
        currentUsername = null;
        window.currentUser = null;
        window.currentUsername = null;
        currentVIPStatus = false;
        
        // Clear message update interval
        if (messageUpdateInterval) {
          clearInterval(messageUpdateInterval);
          messageUpdateInterval = null;
        }
        
        // Hide message notifications
        const taskbarMessages = document.getElementById('taskbar-messages');
        if (taskbarMessages) {
          taskbarMessages.style.display = 'none';
        }
        
        const loginBtn = document.createElement('button');
        loginBtn.textContent = 'Login with GitHub';
        loginBtn.addEventListener('click', () => {
          supabase.auth.signInWithOAuth({ provider: 'github' });
        });
        taskbarAuth.appendChild(loginBtn);
      }
    } catch (error) {
      console.error('Error in renderAuth:', error);
    } finally {
      renderingInProgress = false;
    }
  }

  // Global click handler for dropdowns
  let globalClickHandlerAdded = false;
  
  function addGlobalClickHandler() {
    if (!globalClickHandlerAdded) {
      document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('user-dropdown');
        const userInfo = document.getElementById('user-info');
        const messageDropdown = document.getElementById('message-preview-dropdown');
        const messagesButton = document.getElementById('messages-button');
        
        // Handle user dropdown
        if (dropdown && userInfo && !userInfo.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.style.display = 'none';
        }
        
        // Handle message dropdown (ensure consistency)
        if (messageDropdown && messagesButton && 
            !messageDropdown.contains(e.target) && !messagesButton.contains(e.target)) {
          messageDropdown.classList.remove('show');
        }
      });
      globalClickHandlerAdded = true;
    }
  }

  // Initialize everything
  async function initializeApp() {
    if (isInitialized) return;
    isInitialized = true;

    try {
      renderNav();
      await renderAuth();
      await renderVip();
      addGlobalClickHandler();
      initMessageNotifications();

      let authChangeTimeout;
      supabase.auth.onAuthStateChange(async (event, session) => {
        clearTimeout(authChangeTimeout);
        authChangeTimeout = setTimeout(async () => {
          if (!renderingInProgress) {
            await renderAuth();
            await renderVip();
            renderNav(); // Re-render nav to update VIP features
          }
        }, 100);
      });

    } catch (error) {
      console.error('Error initializing app:', error);
    }
  }

  // Make render functions globally accessible
  window.renderVip = renderVip;
  window.renderAuth = renderAuth;
  window.renderNav = renderNav;

  // Start the app when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApp);
  } else {
    initializeApp();
  }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Dashboard - BrownDogGames</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Rubik+Mono+One&display=swap');
    
    body {
      font-family: 'Rubik Mono One', sans-serif;
      background-color: #1e1b2e;
      color: #fefefe;
      min-height: 100vh;
      padding: 20px;
      background-image: linear-gradient(135deg, #2c1b33, #191425);
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      font-size: 2.8rem;
      color: #ff69b4;
      text-shadow: 2px 2px 0 #000;
      margin-bottom: 1rem;
      text-align: center;
    }

    /* Header */
    .header-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      gap: 1rem;
    }

    .earnings-section {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .likes-breakdown {
      background-color: #2d1a3a;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      border: 2px solid #ff69b4;
    }

    .likes-breakdown h3 {
      color: #ff69b4;
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
    }

    .likes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .likes-item {
      background-color: #3b2750;
      padding: 0.5rem;
      border-radius: 6px;
      text-align: center;
    }

    .likes-count {
      color: #8dffa1;
      font-weight: bold;
      font-size: 1.2rem;
    }

    .likes-label {
      color: #ffc0cb;
      font-size: 0.7rem;
      opacity: 0.8;
    }

    .total-likes {
      background-color: #3b2750;
      padding: 0.75rem;
      border-radius: 6px;
      text-align: center;
      border: 1px solid #8dffa1;
    }

    .total-likes-count {
      color: #8dffa1;
      font-weight: bold;
      font-size: 1.5rem;
    }

    .earnings-display {
      background-color: #2d1a3a;
      padding: 1rem;
      border-radius: 8px;
      border: 2px solid #8dffa1;
      text-align: center;
    }

    .earnings-amount {
      color: #8dffa1;
      font-weight: bold;
      font-size: 1.3rem;
      margin-bottom: 0.5rem;
    }

    .earnings-status {
      color: #ffc0cb;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .terms-link {
      background-color: #ff69b4;
      color: #1e1b2e;
      padding: 0.5rem 1rem;
      font-weight: bold;
      font-size: 0.9rem;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      text-align: center;
      transition: background-color 0.2s;
    }

    .terms-link:hover {
      background-color: #ff85c1;
    }

    /* Payout Section */
    .payout-section {
      margin-bottom: 2rem;
      text-align: center;
    }

    .payout-btn {
      background-color: #8dffa1;
      color: #1e1b2e;
      font-weight: bold;
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 0.5rem;
      font-size: 1rem;
      transition: background-color 0.2s;
    }

    .payout-btn:hover {
      background-color: #7de891;
    }

    .payout-btn:disabled {
      background-color: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .payout-status {
      margin: 0;
      font-size: 0.9rem;
      color: #ffc0cb;
    }

    /* Tab Navigation */
    .tab-nav {
      display: flex;
      background-color: #2d1a3a;
      border-radius: 12px;
      padding: 0.5rem;
      margin-bottom: 2rem;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .tab-button {
      flex: 1;
      background: transparent;
      color: #ffc0cb;
      border: none;
      padding: 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Rubik Mono One', sans-serif;
      font-size: 1rem;
      font-weight: bold;
      transition: all 0.3s ease;
      min-width: 100px;
    }

    .tab-button.active {
      background-color: #ff69b4;
      color: #1e1b2e;
    }

    .tab-button:hover:not(.active) {
      background-color: #3b2750;
    }

    /* Tab Content */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Profile Styles */
    .profile-section {
      background-color: #2d1a3a;
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 2rem;
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid #ff69b4;
      object-fit: cover;
    }

    .profile-basic-info {
      flex: 1;
      min-width: 200px;
    }

    .profile-name {
      color: #ff69b4;
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .profile-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-item {
      background-color: #3b2750;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      color: #8dffa1;
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 0.25rem;
    }

    .stat-label {
      color: #ffc0cb;
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .profile-form {
      background-color: #3b2750;
      padding: 1.5rem;
      border-radius: 8px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      color: #ffc0cb;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      font-weight: bold;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      padding: 0.7rem;
      border: none;
      border-radius: 6px;
      background-color: #2d1a3a;
      color: #fefefe;
      font-family: 'Rubik Mono One', sans-serif;
      font-size: 0.9rem;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .profile-save-btn {
      background-color: #ff69b4;
      color: #1e1b2e;
      font-weight: bold;
      padding: 1rem 2rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s;
      justify-self: center;
      grid-column: 1 / -1;
      max-width: 200px;
    }

    .profile-save-btn:hover {
      background-color: #ff8edb;
    }

    .profile-save-btn:disabled {
      background-color: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }

    /* Lists */
    .content-list {
      list-style: none;
      padding: 0;
      margin-bottom: 2rem;
    }

    .content-list li {
      background-color: #2d1a3a;
      margin-bottom: 12px;
      padding: 1rem;
      border-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .art-item, .music-item {
      flex-direction: column !important;
      align-items: flex-start !important;
    }

    .item-info {
      flex-grow: 1;
      overflow-wrap: anywhere;
    }

    .item-title {
      font-weight: bold;
      font-size: 1.2rem;
      margin-bottom: 6px;
      color: #ff69b4;
    }

    .item-desc {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 4px;
    }

    .item-urls a {
      color: #ffc0cb;
      font-size: 0.9rem;
      margin-right: 12px;
      text-decoration: underline;
    }

    .art-image {
      max-width: 100%;
      border-radius: 8px;
      box-shadow: 0 0 8px #ff69b488;
      margin: 10px 0;
    }

    /* Music Player Styles */
    .music-player {
      width: 100%;
      margin: 10px 0;
      border-radius: 8px;
      background-color: #3b2750;
    }

    .music-player::-webkit-media-controls-panel {
      background-color: #3b2750;
    }

    .remove-btn {
      background-color: #ff4c4c;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s;
      flex-shrink: 0;
      align-self: flex-end;
    }

    .remove-btn:hover {
      background-color: #ff1a1a;
    }

    /* Forms */
    .content-form {
      background-color: #2d1a3a;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 0 15px #ff69b4aa;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .content-form label {
      font-weight: bold;
      color: #ffc0cb;
    }

    .content-form input[type="text"],
    .content-form input[type="url"],
    .content-form textarea {
      width: 100%;
      padding: 0.7rem;
      border-radius: 8px;
      border: none;
      font-family: 'Rubik Mono One', sans-serif;
      font-size: 1rem;
      background-color: #3b2750;
      color: #fefefe;
      resize: vertical;
      box-sizing: border-box;
    }

    .content-form button {
      background: #ff69b4;
      color: #1e1b2e;
      font-weight: bold;
      padding: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1rem;
      transition: background 0.3s ease;
      width: 150px;
      align-self: center;
    }

    .content-form button:hover {
      background: #ff8edb;
    }

    .message {
      margin-top: 1rem;
      font-weight: bold;
      text-align: center;
      font-size: 1.2rem;
    }

    .error {
      color: #ff8d8d;
    }

    .success {
      color: #8dffa1;
    }

    /* Payments Tab Specific */
    .payment-overview {
      background-color: #2d1a3a;
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 2rem;
    }

    .payment-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .payment-stat-item {
      background-color: #3b2750;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
    }

    .payment-stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 0.25rem;
    }

    .payment-stat-label {
      color: #ffc0cb;
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .payouts-history {
      background-color: #2d1a3a;
      padding: 1.5rem;
      border-radius: 12px;
    }

    .payout-item {
      background-color: #3b2750;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 0.75rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-left: 4px solid transparent;
    }

    .payout-item.pending {
      border-left-color: #ffc0cb;
    }

    .payout-item.completed {
      border-left-color: #8dffa1;
    }

    .payout-item.failed {
      border-left-color: #ff8d8d;
    }

    .payout-info {
      flex: 1;
    }

    .payout-amount {
      font-size: 1.2rem;
      font-weight: bold;
      color: #8dffa1;
    }

    .payout-date {
      font-size: 0.8rem;
      opacity: 0.8;
      color: #ffc0cb;
    }

    .payout-status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: bold;
      text-transform: uppercase;
    }

    .payout-status-badge.pending {
      background-color: #ffc0cb;
      color: #1e1b2e;
    }

    .payout-status-badge.completed {
      background-color: #8dffa1;
      color: #1e1b2e;
    }

    .payout-status-badge.failed {
      background-color: #ff8d8d;
      color: #1e1b2e;
    }

    /* Bottom Embeds */
    .bottom-embeds-section {
        background: linear-gradient(135deg, #2f1a39, #3d2147);
        border: 2px solid #ff4f9f;
        border-radius: 12px;
        padding: 1.5rem;
        margin: 2rem auto;
        text-align: center;
        max-width: 400px;
    }
    .bottom-embeds-section h3 {
        color: #ff4f9f;
        margin-bottom: 1.5rem;
        text-shadow: 0 0 10px #ff4f9f;
        font-family: 'Rubik Mono One', sans-serif;
    }
    .bottom-embeds-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
        margin-top: 2rem;
        justify-content: center;
        max-width: 300px;
        margin-left: auto;
        margin-right: auto;
    }
    .bottom-embed-container {
        border: 2px solid #ff4f9f;
        border-radius: 8px;
        overflow: hidden;
        background: linear-gradient(45deg, #ff4f9f, #ff82ba);
        height: 60px;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        animation: pulse 2s infinite;
    }

    .bottom-embed-container:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 8px 25px rgba(255, 79, 159, 0.6);
        background: linear-gradient(45deg, #ff82ba, #ffb3d1);
    }

    @keyframes pulse {
        0%, 100% { box-shadow: 0 0 5px rgba(255, 79, 159, 0.5); }
        50% { box-shadow: 0 0 20px rgba(255, 79, 159, 0.8); }
    }
    .bottom-embed-iframe {
        width: 100%;
        height: 400px;
        border: none;
        display: block;
        transform: scale(0.8);
        transform-origin: top left;
        overflow: hidden;
    }
    .bottom-embed-header {
        background: linear-gradient(45deg, #ff4f9f, #ff82ba);
        color: #1b1b2e;
        padding: 10px;
        font-weight: bold;
        font-size: 0.9rem;
        font-family: 'Rubik Mono One', sans-serif;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .header-info {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
      }

      .tab-nav {
        flex-direction: column;
      }

      .content-list li {
        flex-direction: column;
        align-items: flex-start;
      }

      .remove-btn {
        align-self: flex-end;
        margin-top: 1rem;
      }

      .profile-header {
        flex-direction: column;
        text-align: center;
      }

      .profile-form {
        grid-template-columns: 1fr;
      }

      .profile-stats {
        grid-template-columns: repeat(2, 1fr);
      }

      .likes-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .payment-stats {
        grid-template-columns: 1fr;
      }

      .payout-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .bottom-embeds-container {
          grid-template-columns: 1fr;
          max-width: 150px;
      }
      .bottom-embeds-section {
          padding: 1rem;
          margin: 1rem auto;
      }
      .bottom-embed-container {
          height: 50px;
      }
    }
  </style>
</head>
<body>

<!-- Header with Earnings and Terms -->
<div class="header-info">
  <div class="earnings-section">
    <!-- Simple Earnings Display -->
    <div class="earnings-display">
      <div id="earningsAmount" class="earnings-amount">£0.00</div>
      <div id="earningsStatus" class="earnings-status">Loading earnings...</div>
    </div>
  </div>
  <a href="submission-terms.html" class="terms-link">
    Submission Terms
  </a>
</div>

<!-- Single Payout Section -->
<div class="payout-section">
  <button id="mainPayoutBtn" class="payout-btn" style="display: none;">
    💸 Request Payout
  </button>
  <p id="mainPayoutStatus" class="payout-status"></p>
</div>

<h1>Your Dashboard</h1>

<!-- Tab Navigation -->
<div class="tab-nav">
  <button class="tab-button active" onclick="showTab('profile')">Profile</button>
  <button class="tab-button" onclick="showTab('games')">Games</button>
  <button class="tab-button" onclick="showTab('videos')">Videos</button>
  <button class="tab-button" onclick="showTab('music')">Music</button>
  <button class="tab-button" onclick="showTab('art')">Art</button>
  <button class="tab-button" onclick="showTab('payments')">Payments</button>
</div>

<!-- Profile Tab -->
<div id="profile-tab" class="tab-content active">
  <div class="profile-section">
    <h2 style="color: #ff69b4; margin-top: 0; margin-bottom: 1.5rem; font-size: 1.8rem;">👤 Your Profile</h2>
    
    <!-- Profile Header -->
    <div class="profile-header">
      <img id="profileAvatar" src="" alt="Profile Avatar" class="profile-avatar" style="display: none;">
      <div class="profile-basic-info">
        <div id="profileName" class="profile-name">Loading...</div>
      </div>
    </div>

    <!-- Profile Stats -->
    <div class="profile-stats">
      <div class="stat-item">
        <div id="statGames" class="stat-value">0</div>
        <div class="stat-label">Games</div>
      </div>
      <div class="stat-item">
        <div id="statVideos" class="stat-value">0</div>
        <div class="stat-label">Videos</div>
      </div>
      <div class="stat-item">
        <div id="statMusic" class="stat-value">0</div>
        <div class="stat-label">Music</div>
      </div>
      <div class="stat-item">
        <div id="statArt" class="stat-value">0</div>
        <div class="stat-label">Art Pieces</div>
      </div>
      <div class="stat-item">
        <div id="statLikes" class="stat-value">0</div>
        <div class="stat-label">Total Likes</div>
      </div>
    </div>

    <!-- Profile Form -->
    <form id="profileForm" class="profile-form">
      <div class="form-group">
        <label for="location">Location</label>
        <input type="text" id="location" placeholder="City, Country" />
      </div>

      <div class="form-group">
        <label for="website">Website</label>
        <input type="url" id="website" placeholder="https://yoursite.com" />
      </div>

      <div class="form-group">
        <label for="twitter">Twitter/X Handle</label>
        <input type="text" id="twitter" placeholder="@yourusername" />
      </div>

      <div class="form-group">
        <label for="favGenre">Favorite Game Genre</label>
        <select id="favGenre">
          <option value="">Select a genre</option>
          <option value="action">Action</option>
          <option value="adventure">Adventure</option>
          <option value="puzzle">Puzzle</option>
          <option value="simulation">Simulation</option>
          <option value="strategy">Strategy</option>
          <option value="arcade">Arcade</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div class="form-group" style="grid-column: 1 / -1;">
        <label for="bio">Bio</label>
        <textarea id="bio" placeholder="Tell others about yourself and your games..." rows="4"></textarea>
      </div>

      <button type="submit" class="profile-save-btn" id="profileSaveBtn">💾 Save Profile</button>
    </form>

    <p class="message" id="profileMessage" aria-live="polite"></p>
  </div>
</div>

<!-- Games Tab -->
<div id="games-tab" class="tab-content">
  <ul id="games-list" class="content-list"></ul>

  <form id="addGameForm" class="content-form">
    <label for="gameTitle">Game Title:</label>
    <input type="text" id="gameTitle" placeholder="Enter your game title" required />

    <label for="gameDescription">Description:</label>
    <textarea id="gameDescription" rows="4" placeholder="Brief description of your game" required></textarea>

    <label for="embedUrl">Embed URL:</label>
    <input type="url" id="embedUrl" placeholder="URL to embed your game" required />

    <label for="screenshotUrl">Screenshot URL (optional):</label>
    <input type="url" id="screenshotUrl" placeholder="Link to a screenshot" />

    <label for="coverUrl">Cover URL (optional):</label>
    <input type="url" id="coverUrl" placeholder="Link to a cover image" />

    <button type="submit" id="gameSubmitBtn">Add New Game</button>
  </form>

  <p class="message" id="gameFormMessage" aria-live="polite"></p>
</div>

<!-- Videos Tab -->
<div id="videos-tab" class="tab-content">
  <ul id="videos-list" class="content-list"></ul>

  <form id="addVideoForm" class="content-form">
    <label for="videoTitle">Video Title:</label>
    <input type="text" id="videoTitle" placeholder="Enter video title" required />

    <label for="videoContent">Description / Content:</label>
    <textarea id="videoContent" rows="4" placeholder="Brief description of your video" required></textarea>

    <label for="videoUrl">Video URL:</label>
    <input type="url" id="videoUrl" placeholder="URL of the video" required />

    <button type="submit" id="videoSubmitBtn">Add New Video</button>
  </form>

  <p class="message" id="videoFormMessage" aria-live="polite"></p>
</div>

<!-- Music Tab -->
<div id="music-tab" class="tab-content">
  <ul id="music-list" class="content-list"></ul>

  <form id="addMusicForm" class="content-form">
    <label for="musicTitle">Music Title:</label>
    <input type="text" id="musicTitle" placeholder="Enter music title" required />

    <label for="musicDescription">Description:</label>
    <textarea id="musicDescription" rows="4" placeholder="Describe your music" required></textarea>

    <label for="musicUrl">Music URL:</label>
    <input type="url" id="musicUrl" placeholder="Link to your music file (MP3, WAV, OGG)" required />

    <button type="submit" id="musicSubmitBtn">Add New Music</button>
  </form>

  <p class="message" id="musicFormMessage" aria-live="polite"></p>
</div>

<!-- Art Tab -->
<div id="art-tab" class="tab-content">
  <ul id="art-list" class="content-list"></ul>

  <form id="addArtForm" class="content-form">
    <label for="artTitle">Art Title:</label>
    <input type="text" id="artTitle" placeholder="Enter art title" required />

    <label for="artDescription">Description:</label>
    <textarea id="artDescription" rows="4" placeholder="Describe your art" required></textarea>

    <label for="artImageUrl">Image URL:</label>
    <input type="url" id="artImageUrl" placeholder="Link to your artwork image" required />

    <button type="submit" id="artSubmitBtn">Add New Art</button>
  </form>

  <p class="message" id="artFormMessage" aria-live="polite"></p>
</div>

<!-- Payments Tab -->
<div id="payments-tab" class="tab-content">
  <!-- Payment Overview -->
  <div class="payment-overview">
    <h2 style="color: #ff69b4; margin-top: 0; margin-bottom: 1.5rem; font-size: 1.8rem;">💰 Payment Overview</h2>
    
    <div class="payment-stats">
      <div class="payment-stat-item">
        <div id="paymentTotalLikes" class="payment-stat-value" style="color: #ff69b4;">0</div>
        <div class="payment-stat-label">Total Likes</div>
      </div>
      <div class="payment-stat-item">
        <div id="paymentEarnings" class="payment-stat-value" style="color: #8dffa1;">£0.00</div>
        <div class="payment-stat-label">Current Earnings</div>
      </div>
      <div class="payment-stat-item">
        <div id="paymentStatus" class="payment-stat-value" style="color: #ffc0cb;">Ready</div>
        <div class="payment-stat-label">Status</div>
      </div>
    </div>
    
    <!-- Payout Request Section -->
    <div style="text-align: center; margin-top: 1.5rem;">
      <button id="paymentTabPayoutBtn" class="payout-btn" style="display: none;">
        💸 Request Payout
      </button>
      <p id="paymentTabStatus" class="payout-status"></p>
      <div style="margin-top: 0.5rem; font-size: 0.85rem; opacity: 0.8;">
        Minimum £5.00 required for payout. Earnings: £0.001 per point (5000 points = £5.00).
      </div>
    </div>
  </div>

  <!-- Payouts History -->
  <div class="payouts-history">
    <h3 style="color: #ff69b4; margin-top: 0; margin-bottom: 1rem;">📋 Payout History</h3>
    <div id="payoutsHistoryContainer">
      <div style="text-align: center; opacity: 0.7; padding: 2rem;">
        <p>No payout requests yet.</p>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

  const supabase = createClient(
    'https://fwslmbzfukriibnkpzou.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3c2xtYnpmdWtyaWlibmtwem91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4NTcxMDcsImV4cCI6MjA2NDQzMzEwN30.juWK3T16_-LGHPii7xLp92Tt5TAZKN3IcZVn6nR8cBA'
  );

  let currentUser;

  // Tab Management
  window.showTab = function(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
      tab.classList.remove('active');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // Add active class to clicked button
    event.target.classList.add('active');
  };

  // Utility Functions
  function showMessage(elementId, text, type = '') {
    const element = document.getElementById(elementId);
    element.textContent = text;
    element.className = `message ${type}`;
  }

  async function checkAuth() {
    const { data: { session }, error } = await supabase.auth.getSession();
    if (error || !session?.user) {
      window.location.href = 'login.html';
      return false;
    }
    currentUser = session.user;
    return true;
  }

  // FIXED: Username consolidation function - only consolidate specific cases, not generic names
  function normalizeUsername(username) {
    if (!username) return username;
    
    // FIXED: Only consolidate very specific cases where we know there's duplication
    // Remove the generic "ace" -> "Ace475" rule that was causing problems
    const specificConsolidationRules = {
      // Add specific consolidation rules here ONLY if you're certain about duplication
      // For example, if you know "user123_alt" should be "user123":
      // 'user123_alt': 'user123',
      
      // DO NOT add generic name mappings like 'ace': 'Ace475' 
      // unless you're absolutely certain about the specific case
    };
    
    const normalizedKey = username.toLowerCase();
    if (specificConsolidationRules[normalizedKey]) {
      console.log(`🔄 Dashboard consolidation: "${username}" → "${specificConsolidationRules[normalizedKey]}"`);
      return specificConsolidationRules[normalizedKey];
    }
    
    // Return username as-is for all other cases
    return username;
  }

  // Enhanced function to get ALL likes across all content types INCLUDING VIP EXTRAS AND GAME POINTS
  async function getAllLikesBreakdown() {
    if (!currentUser) return { page: 0, videos: 0, games: 0, art: 0, music: 0, extras: 0, gamePoints: 0, total: 0 };

    try {
      const username = currentUser.user_metadata?.user_name || currentUser.email || null;
      if (!username) return { page: 0, videos: 0, games: 0, art: 0, music: 0, extras: 0, gamePoints: 0, total: 0 };

      console.log(`🔍 Dashboard: Getting likes breakdown for ${username}`);

      // Step 1: Get ALL VIP extras to map extra IDs to creators
      const { data: vipExtras, error: extrasError } = await supabase
        .from('vip_extras')
        .select('id, creator_name, created_by');

      if (extrasError) {
        console.error('Error fetching extras:', extrasError);
      }

      // Create a map from extra ID to creator info
      const extraCreatorMap = {};
      if (vipExtras) {
        vipExtras.forEach(extra => {
          extraCreatorMap[extra.id] = {
            creatorName: extra.creator_name || 'Unknown Creator',
            createdBy: extra.created_by
          };
        });
      }

      console.log(`🗺️ Dashboard: Created creator map for ${Object.keys(extraCreatorMap).length} extras`);

      // Step 2: Get all view records INCLUDING GAME POINTS
      const { data: allViews, error: viewsError } = await supabase
        .from('vip_page_views')
        .select('username, view_count, game_points');

      if (viewsError) throw viewsError;

      // Step 3: Process using same logic as leaderboard + game points
      const usersLikesMap = {};

      if (allViews) {
        allViews.forEach(view => {
          const viewUsername = view.username;
          const viewCount = view.view_count || 0;
          const gamePoints = view.game_points || 0;
          
          if (!viewUsername) return;

          let baseUsername = viewUsername;
          let contentType = 'page';

          // Check if this is an extra like
          if (viewUsername.startsWith('extra_')) {
            const extraId = viewUsername.replace('extra_', '');
            console.log(`🔍 Dashboard: Processing extra like: ${extraId} (${viewCount} likes, ${gamePoints} game points)`);
            
            // Look up the creator of this extra
            const creatorInfo = extraCreatorMap[extraId];
            if (creatorInfo && creatorInfo.creatorName) {
              baseUsername = creatorInfo.creatorName;
              contentType = 'extras';
              console.log(`✅ Dashboard: Mapped extra ${extraId} to creator: ${baseUsername}`);
            } else {
              console.log(`⚠️ Dashboard: No creator found for extra ${extraId}, skipping`);
              return; // Skip this record if we can't find the creator
            }
          } else if (viewUsername.includes('_video_')) {
            baseUsername = viewUsername.split('_video_')[0];
            contentType = 'videos';
          } else if (viewUsername.includes('_game_')) {
            baseUsername = viewUsername.split('_game_')[0];
            contentType = 'games';
          } else if (viewUsername.includes('_artwork_')) {
            baseUsername = viewUsername.split('_artwork_')[0];
            contentType = 'art';
          } else if (viewUsername.includes('_music_')) {
            baseUsername = viewUsername.split('_music_')[0];
            contentType = 'music';
          }

          // FIXED: Apply consolidation (now much more conservative)
          baseUsername = normalizeUsername(baseUsername);

          // Initialize user if not exists
          if (!usersLikesMap[baseUsername]) {
            usersLikesMap[baseUsername] = {
              username: baseUsername,
              page: 0,
              videos: 0,
              games: 0,
              art: 0,
              music: 0,
              extras: 0,
              gamePoints: 0,
              total: 0
            };
          }

          // Add to appropriate category
          usersLikesMap[baseUsername][contentType] += viewCount;
          
          // Add game points (these apply to all content types)
          usersLikesMap[baseUsername].gamePoints += gamePoints;
          
          console.log(`📈 Dashboard: Added ${viewCount} ${contentType} likes + ${gamePoints} game points to ${baseUsername}`);
        });
      }

      // Step 4: Find the current user's data (after consolidation)
      const normalizedCurrentUsername = normalizeUsername(username);
      const userLikesData = usersLikesMap[normalizedCurrentUsername];

      if (userLikesData) {
        // Calculate total: likes + game points
        const likesTotal = userLikesData.page + userLikesData.videos + userLikesData.games + userLikesData.art + userLikesData.music + userLikesData.extras;
        userLikesData.total = likesTotal + userLikesData.gamePoints; // Include game points in total
        
        console.log(`📊 Dashboard: Final breakdown for ${normalizedCurrentUsername}:`, {
          ...userLikesData,
          likesOnly: likesTotal,
          totalWithGamePoints: userLikesData.total
        });
        
        return {
          page: userLikesData.page,
          videos: userLikesData.videos,
          games: userLikesData.games,
          art: userLikesData.art,
          music: userLikesData.music,
          extras: userLikesData.extras,
          gamePoints: userLikesData.gamePoints,
          total: userLikesData.total
        };
      } else {
        console.log(`📊 Dashboard: No data found for ${normalizedCurrentUsername}`);
        return { page: 0, videos: 0, games: 0, art: 0, music: 0, extras: 0, gamePoints: 0, total: 0 };
      }

    } catch (error) {
      console.error('Error getting likes breakdown:', error);
      return { page: 0, videos: 0, games: 0, art: 0, music: 0, extras: 0, gamePoints: 0, total: 0 };
    }
  }

  // Enhanced function to calculate available earnings (after completed payouts)
  async function getAvailableEarnings() {
    if (!currentUser) return { 
      availableLikes: 0, 
      availableEarnings: 0, 
      totalLikes: 0, 
      paidLikes: 0,
      completedPayouts: 0 
    };

    try {
      const username = currentUser.user_metadata?.user_name || currentUser.email || null;
      if (!username) return { 
        availableLikes: 0, 
        availableEarnings: 0, 
        totalLikes: 0, 
        paidLikes: 0,
        completedPayouts: 0 
      };

      // Get current total likes (using existing getAllLikesBreakdown function)
      const likesBreakdown = await getAllLikesBreakdown();
      const totalLikes = likesBreakdown.total;

      // Get all completed payouts for this user
      const { data: completedPayouts, error: payoutError } = await supabase
        .from('payout_requests')
        .select('likes_at_payout, amount, completed_at')
        .eq('user_id', currentUser.id)
        .eq('status', 'completed')
        .order('completed_at', { ascending: false });

      if (payoutError) {
        console.error('Error fetching completed payouts:', payoutError);
        // If we can't fetch payouts, show full earnings (safe fallback)
        return { 
          availableLikes: totalLikes, 
          availableEarnings: Math.floor(totalLikes / 10) * 0.01, 
          totalLikes, 
          paidLikes: 0,
          completedPayouts: 0 
        };
      }

      // Calculate total likes that have been paid out
      const paidLikes = completedPayouts?.reduce((sum, payout) => {
        return sum + (payout.likes_at_payout || 0);
      }, 0) || 0;

      // Calculate available (unpaid) likes and earnings
      const availableLikes = Math.max(0, totalLikes - paidLikes);
      const availableEarnings = availableLikes * 0.001; // £0.001 per point (5000 points = £5.00)

      console.log(`💰 Payment calculation for ${username}:`, {
        totalLikes,
        paidLikes,
        availableLikes,
        availableEarnings: `£${availableEarnings.toFixed(2)}`,
        completedPayoutsCount: completedPayouts?.length || 0
      });

      return {
        availableLikes,
        availableEarnings,
        totalLikes,
        paidLikes,
        completedPayouts: completedPayouts?.length || 0
      };

    } catch (error) {
      console.error('Error calculating available earnings:', error);
      return { 
        availableLikes: 0, 
        availableEarnings: 0, 
        totalLikes: 0, 
        paidLikes: 0,
        completedPayouts: 0 
      };
    }
  }

  // Updated main display function with proper payment reset logic
  async function updateAllDisplays() {
    if (!currentUser) return;

    try {
      const username = currentUser.user_metadata?.user_name || currentUser.email || null;
      
      if (!username) {
        // Update displays with zeros
        document.getElementById('earningsAmount').textContent = '£0.00';
        document.getElementById('earningsStatus').textContent = 'No username found';
        document.getElementById('paymentTotalLikes').textContent = '0';
        document.getElementById('paymentEarnings').textContent = '£0.00';
        document.getElementById('paymentStatus').textContent = 'No Username';
        return;
      }

      // Get available earnings (after accounting for completed payouts)
      const earningsData = await getAvailableEarnings();
      const { availableEarnings, availableLikes, totalLikes, paidLikes, completedPayouts } = earningsData;

      // Update main earnings display
      document.getElementById('earningsAmount').textContent = `£${availableEarnings.toFixed(2)}`;
      
      // Update payments tab with detailed breakdown
      document.getElementById('paymentTotalLikes').textContent = `${totalLikes}`;
      document.getElementById('paymentEarnings').textContent = `£${availableEarnings.toFixed(2)}`;

      // Show earnings breakdown in status if user has had payouts
      let earningsStatusText = '';
      if (completedPayouts > 0) {
        earningsStatusText = `${availableLikes} new points (${paidLikes} already paid from ${completedPayouts} payout${completedPayouts > 1 ? 's' : ''})`;
      } else {
        earningsStatusText = `${availableLikes} total points`;
      }

      // Check for existing pending requests
      const { data: existingRequests, error: reqError } = await supabase
        .from('payout_requests')
        .select('*')
        .eq('user_id', currentUser.id)
        .eq('status', 'pending');

      if (reqError) throw reqError;

      const mainPayoutBtn = document.getElementById('mainPayoutBtn');
      const paymentTabPayoutBtn = document.getElementById('paymentTabPayoutBtn');
      const mainPayoutStatus = document.getElementById('mainPayoutStatus');
      const paymentTabStatus = document.getElementById('paymentTabStatus');
      const earningsStatus = document.getElementById('earningsStatus');
      const paymentStatus = document.getElementById('paymentStatus');

      if (existingRequests.length > 0) {
        // Has pending request
        mainPayoutBtn.style.display = 'none';
        paymentTabPayoutBtn.style.display = 'none';
        mainPayoutStatus.textContent = 'You have a pending payout request.';
        paymentTabStatus.textContent = 'You have a pending payout request.';
        earningsStatus.textContent = 'Payout request pending';
        paymentStatus.textContent = 'Pending';
        paymentStatus.style.color = '#ffc0cb';
      } else if (availableEarnings >= 5.0) {
        // Ready for payout (5000+ points)
        mainPayoutBtn.style.display = 'inline-block';
        paymentTabPayoutBtn.style.display = 'inline-block';
        mainPayoutStatus.textContent = '';
        paymentTabStatus.textContent = '';
        earningsStatus.textContent = `Ready for payout! (${earningsStatusText})`;
        paymentStatus.textContent = 'Ready';
        paymentStatus.style.color = '#8dffa1';
      } else {
        // Below minimum (less than 5000 points)
        mainPayoutBtn.style.display = 'none';
        paymentTabPayoutBtn.style.display = 'none';
        const amountNeeded = 5.0 - availableEarnings;
        const pointsNeeded = Math.ceil(amountNeeded / 0.001); // Points needed at £0.001 per point
        
        mainPayoutStatus.textContent = `Need ${pointsNeeded} more points to reach £5.00 minimum (need £${amountNeeded.toFixed(2)} more).`;
        paymentTabStatus.textContent = `Need ${pointsNeeded} more points to reach £5.00 minimum (need £${amountNeeded.toFixed(2)} more).`;
        
        if (availableEarnings === 0 && completedPayouts > 0) {
          earningsStatus.textContent = `All earnings paid out - need ${pointsNeeded} more points`;
        } else {
          earningsStatus.textContent = `Need ${pointsNeeded} more points for payout (${earningsStatusText})`;
        }
        
        paymentStatus.textContent = 'Below Min';
        paymentStatus.style.color = '#ff8d8d';
      }

      console.log('🔄 Display updated:', {
        availableEarnings: `£${availableEarnings.toFixed(2)}`,
        status: availableEarnings >= 5 ? 'Ready' : availableEarnings === 0 && completedPayouts > 0 ? 'Reset' : 'Below Min'
      });

    } catch (error) {
      console.error('Error updating displays:', error);
      document.getElementById('earningsStatus').textContent = 'Error loading data';
    }
  }

  // Profile Functions
  async function loadProfile() {
    if (!currentUser) return;

    try {
      // Load basic user info
      const profileName = document.getElementById('profileName');
      const profileAvatar = document.getElementById('profileAvatar');

      const githubName = currentUser.user_metadata?.full_name || 'GitHub User';
      const avatarUrl = currentUser.user_metadata?.avatar_url;

      if (profileName) {
        profileName.textContent = githubName;
      }

      if (avatarUrl && profileAvatar) {
        profileAvatar.src = avatarUrl;
        profileAvatar.style.display = 'block';
      }

      // Load profile data from database
      const { data: profileData, error: profileError } = await supabase
        .from('user_profiles')
        .select('*')
        .eq('user_id', currentUser.id)
        .single();

      if (profileError && profileError.code !== 'PGRST116') {
        console.error('Profile fetch error:', profileError);
      } else if (profileData) {
        // Populate form with existing data
        const locationInput = document.getElementById('location');
        const websiteInput = document.getElementById('website');
        const twitterInput = document.getElementById('twitter');
        const favGenreSelect = document.getElementById('favGenre');
        const bioTextarea = document.getElementById('bio');

        if (locationInput) locationInput.value = profileData.location || '';
        if (websiteInput) websiteInput.value = profileData.website || '';
        if (twitterInput) twitterInput.value = profileData.twitter || '';
        if (favGenreSelect) favGenreSelect.value = profileData.favorite_genre || '';
        if (bioTextarea) bioTextarea.value = profileData.bio || '';
      }

      // Load and display stats
      await loadProfileStats();

    } catch (error) {
      console.error('Profile load error:', error);
      showMessage('profileMessage', 'Error loading profile: ' + error.message, 'error');
    }
  }

  async function loadProfileStats() {
    if (!currentUser) return;

    try {
      const username = currentUser.user_metadata?.user_name || currentUser.email;

      // Get games count
      const { count: gamesCount } = await supabase
        .from('game_submissions')
        .select('*', { count: 'exact', head: true })
        .eq('user_id', currentUser.id);

      // Get videos count  
      const { count: videosCount } = await supabase
        .from('game_videos')
        .select('*', { count: 'exact', head: true })
        .eq('github_username', username);

      // Get music count
      const { count: musicCount } = await supabase
        .from('user_music')
        .select('*', { count: 'exact', head: true })
        .eq('github_username', username);

      // Get art count
      const { count: artCount } = await supabase
        .from('user_art')
        .select('*', { count: 'exact', head: true })
        .eq('github_username', username);

      // Get all likes breakdown (including VIP extras AND game points)
      const likesBreakdown = await getAllLikesBreakdown();

      // Update stats display
      const statGames = document.getElementById('statGames');
      const statVideos = document.getElementById('statVideos');
      const statMusic = document.getElementById('statMusic');
      const statArt = document.getElementById('statArt');
      const statLikes = document.getElementById('statLikes');

      if (statGames) statGames.textContent = gamesCount || 0;
      if (statVideos) statVideos.textContent = videosCount || 0;
      if (statMusic) statMusic.textContent = musicCount || 0;
      if (statArt) statArt.textContent = artCount || 0;
      
      // Show total with breakdown in title/tooltip
      if (statLikes) {
        statLikes.textContent = likesBreakdown.total;
        const likesOnly = likesBreakdown.total - likesBreakdown.gamePoints;
        statLikes.title = `Likes: ${likesOnly} | Game Points: ${likesBreakdown.gamePoints} | Total: ${likesBreakdown.total}`;
      }

    } catch (error) {
      console.error('Stats load error:', error);
    }
  }

  async function saveProfile() {
    if (!currentUser) {
      showMessage('profileMessage', 'Error: Not logged in', 'error');
      return;
    }

    // Disable save button
    const saveBtn = document.getElementById('profileSaveBtn');
    if (saveBtn) {
      saveBtn.disabled = true;
      saveBtn.textContent = '⏳ Saving...';
    }

    try {
      // Get form values
      const locationInput = document.getElementById('location');
      const websiteInput = document.getElementById('website');
      const twitterInput = document.getElementById('twitter');
      const favGenreSelect = document.getElementById('favGenre');
      const bioTextarea = document.getElementById('bio');

      const profileData = {
        user_id: currentUser.id,
        location: locationInput ? locationInput.value.trim() : '',
        website: websiteInput ? websiteInput.value.trim() : '',
        twitter: twitterInput ? twitterInput.value.trim() : '',
        favorite_genre: favGenreSelect ? favGenreSelect.value : '',
        bio: bioTextarea ? bioTextarea.value.trim() : '',
        updated_at: new Date().toISOString()
      };

      // First check if profile exists
      const { data: existingProfile, error: checkError } = await supabase
        .from('user_profiles')
        .select('id')
        .eq('user_id', currentUser.id)
        .single();

      if (checkError && checkError.code !== 'PGRST116') {
        throw checkError;
      }

      if (existingProfile) {
        // Profile exists, update it
        const { data: updateData, error: updateError } = await supabase
          .from('user_profiles')
          .update(profileData)
          .eq('user_id', currentUser.id)
          .select();

        if (updateError) throw updateError;
      } else {
        // Profile doesn't exist, create it
        profileData.created_at = new Date().toISOString();
        
        const { data: insertData, error: insertError } = await supabase
          .from('user_profiles')
          .insert([profileData])
          .select();

        if (insertError) throw insertError;
      }

      showMessage('profileMessage', 'Profile saved successfully!', 'success');

    } catch (error) {
      console.error('Profile save error:', error);
      showMessage('profileMessage', `Error saving profile: ${error.message}`, 'error');
    } finally {
      // Re-enable save button
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = '💾 Save Profile';
      }
    }
  }

  // Games Functions
  async function fetchGames() {
    const { data, error } = await supabase
      .from('game_submissions')
      .select('*')
      .eq('user_id', currentUser.id)
      .order('created_at', { ascending: false });

    if (error) {
      showMessage('gameFormMessage', 'Failed to load games: ' + error.message, 'error');
      return [];
    }
    return data;
  }

  async function loadGames() {
    const games = await fetchGames();
    const gamesList = document.getElementById('games-list');
    gamesList.innerHTML = '';
    
    if (!games || games.length === 0) {
      gamesList.innerHTML = '<li>No games submitted yet.</li>';
      return;
    }

    games.forEach(game => {
      const li = document.createElement('li');
      const infoDiv = document.createElement('div');
      infoDiv.className = 'item-info';

      infoDiv.innerHTML = `
        <div class="item-title">${game.title}</div>
        <div class="item-desc">${game.description}</div>
        <div class="item-urls">
          <a href="${game.embed_url}" target="_blank">Play</a>
          ${game.screenshot_url ? `<a href="${game.screenshot_url}" target="_blank">Screenshot</a>` : ''}
          ${game.cover_url ? `<a href="${game.cover_url}" target="_blank">Cover</a>` : ''}
        </div>
      `;

      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-btn';
      removeBtn.textContent = 'Remove';
      removeBtn.onclick = async () => {
        if (!confirm(`Remove "${game.title}"?`)) return;
        const { error } = await supabase
          .from('game_submissions')
          .delete()
          .eq('id', game.id)
          .eq('user_id', currentUser.id);

        if (error) {
          showMessage('gameFormMessage', 'Error removing game: ' + error.message, 'error');
        } else {
          showMessage('gameFormMessage', 'Game removed.', 'success');
          loadGames();
          loadProfileStats();
          updateAllDisplays();
        }
      };

      li.appendChild(infoDiv);
      li.appendChild(removeBtn);
      gamesList.appendChild(li);
    });
  }

  // Videos Functions
  async function fetchVideos() {
    const username = currentUser.user_metadata?.user_name || currentUser.email;
    const { data, error } = await supabase
      .from('game_videos')
      .select('*')
      .eq('github_username', username)
      .order('created_at', { ascending: false });

    if (error) {
      showMessage('videoFormMessage', 'Failed to load videos: ' + error.message, 'error');
      return [];
    }
    return data;
  }

  async function loadVideos() {
    const videos = await fetchVideos();
    const videosList = document.getElementById('videos-list');
    videosList.innerHTML = '';
    
    if (videos.length === 0) {
      videosList.innerHTML = '<li>No videos submitted yet.</li>';
      return;
    }

    videos.forEach(video => {
      const li = document.createElement('li');
      const infoDiv = document.createElement('div');
      infoDiv.className = 'item-info';

      infoDiv.innerHTML = `
        <div class="item-title">${video.title || '(No Title)'}</div>
        <div class="item-desc">${video.content || ''}</div>
        <div class="item-urls">
          <a href="${video.video_url}" target="_blank">Watch Video</a>
        </div>
      `;

      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-btn';
      removeBtn.textContent = 'Remove';
      removeBtn.onclick = async () => {
        if (!confirm(`Remove "${video.title}"?`)) return;
        const { error } = await supabase
          .from('game_videos')
          .delete()
          .eq('id', video.id);

        if (error) {
          showMessage('videoFormMessage', 'Error removing video: ' + error.message, 'error');
        } else {
          showMessage('videoFormMessage', 'Video removed.', 'success');
          loadVideos();
          loadProfileStats();
          updateAllDisplays();
        }
      };

      li.appendChild(infoDiv);
      li.appendChild(removeBtn);
      videosList.appendChild(li);
    });
  }

  // Music Functions
  async function fetchMusic() {
    const { data, error } = await supabase
      .from('user_music')
      .select('*')
      .eq('github_username', currentUser.user_metadata?.user_name || currentUser.email)
      .order('created_at', { ascending: false });

    if (error) {
      showMessage('musicFormMessage', 'Failed to load music: ' + error.message, 'error');
      return [];
    }
    return data;
  }

  async function loadMusic() {
    const musicPieces = await fetchMusic();
    const musicList = document.getElementById('music-list');
    musicList.innerHTML = '';

    if (musicPieces.length === 0) {
      musicList.innerHTML = '<li>No music submitted yet.</li>';
      return;
    }

    musicPieces.forEach(music => {
      const li = document.createElement('li');
      li.className = 'music-item';

      li.innerHTML = `
        <div class="item-title">${music.title}</div>
        <div class="item-desc">${music.description}</div>
        <audio controls class="music-player" style="width: 100%; margin: 10px 0;">
          <source src="${music.music_url}" type="audio/mpeg">
          <source src="${music.music_url}" type="audio/wav">
          <source src="${music.music_url}" type="audio/ogg">
          Your browser does not support the audio element.
        </audio>
      `;

      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-btn';
      removeBtn.textContent = 'Remove';
      removeBtn.onclick = async () => {
        if (!confirm(`Remove "${music.title}"?`)) return;
        const { error } = await supabase
          .from('user_music')
          .delete()
          .eq('id', music.id);

        if (error) {
          showMessage('musicFormMessage', 'Error removing music: ' + error.message, 'error');
        } else {
          showMessage('musicFormMessage', 'Music removed.', 'success');
          loadMusic();
          loadProfileStats();
          updateAllDisplays();
        }
      };

      li.appendChild(removeBtn);
      musicList.appendChild(li);
    });
  }

  // Art Functions
  async function fetchArt() {
    const { data, error } = await supabase
      .from('user_art')
      .select('*')
      .eq('github_username', currentUser.user_metadata?.user_name || currentUser.email)
      .order('created_at', { ascending: false });

    if (error) {
      showMessage('artFormMessage', 'Failed to load art: ' + error.message, 'error');
      return [];
    }
    return data;
  }

  async function loadArt() {
    const artPieces = await fetchArt();
    const artList = document.getElementById('art-list');
    artList.innerHTML = '';

    if (artPieces.length === 0) {
      artList.innerHTML = '<li>No art submitted yet.</li>';
      return;
    }

    artPieces.forEach(art => {
      const li = document.createElement('li');
      li.className = 'art-item';

      li.innerHTML = `
        <div class="item-title">${art.title}</div>
        <div class="item-desc">${art.description}</div>
        <img src="${art.image_url}" alt="${art.title}" class="art-image" />
      `;

      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-btn';
      removeBtn.textContent = 'Remove';
      removeBtn.onclick = async () => {
        if (!confirm(`Remove "${art.title}"?`)) return;
        const { error } = await supabase
          .from('user_art')
          .delete()
          .eq('id', art.id);

        if (error) {
          showMessage('artFormMessage', 'Error removing art: ' + error.message, 'error');
        } else {
          showMessage('artFormMessage', 'Art removed.', 'success');
          loadArt();
          loadProfileStats();
          updateAllDisplays();
        }
      };

      li.appendChild(removeBtn);
      artList.appendChild(li);
    });
  }

  // Enhanced payout history with reset information
  async function loadPayoutsHistory() {
    try {
      const { data, error } = await supabase
        .from('payout_requests')
        .select('*')
        .eq('user_id', currentUser.id)
        .order('requested_at', { ascending: false });

      if (error) throw error;

      const container = document.getElementById('payoutsHistoryContainer');
      
      if (!data || data.length === 0) {
        container.innerHTML = '<div style="text-align: center; opacity: 0.7; padding: 2rem;"><p>No payout requests yet.</p></div>';
        return;
      }

      let html = '';
      data.forEach(payout => {
        const statusClass = payout.status.toLowerCase();
        const likesInfo = payout.likes_at_payout ? ` (${payout.likes_at_payout} total likes)` : '';
        
        html += `
          <div class="payout-item ${statusClass}">
            <div class="payout-info">
              <div class="payout-amount">£${parseFloat(payout.amount).toFixed(2)}${likesInfo}</div>
              <div class="payout-date">Requested: ${new Date(payout.requested_at).toLocaleDateString()}</div>
              ${payout.completed_at ? `<div class="payout-date">Completed: ${new Date(payout.completed_at).toLocaleDateString()}</div>` : ''}
            </div>
            <div class="payout-status-badge ${statusClass}">${payout.status}</div>
          </div>
        `;
      });

      container.innerHTML = html;

    } catch (error) {
      console.error('Error loading payouts history:', error);
    }
  }

  // Updated payout request function
  async function requestPayout() {
    const mainBtn = document.getElementById('mainPayoutBtn');
    const paymentBtn = document.getElementById('paymentTabPayoutBtn');
    
    mainBtn.disabled = true;
    paymentBtn.disabled = true;

    try {
      const username = currentUser.user_metadata?.user_name || currentUser.email || null;
      if (!username) throw new Error('Username not found.');

      // Get current available earnings
      const earningsData = await getAvailableEarnings();
      const { availableEarnings, availableLikes, totalLikes } = earningsData;

      if (availableEarnings < 5) {
        const amountNeeded = 5.0 - availableEarnings;
        const pointsNeeded = Math.ceil(amountNeeded / 0.001); // Points needed at £0.001 per point
        const message = `Minimum £5 earnings required. You have £${availableEarnings.toFixed(2)} from ${availableLikes} available points. Need ${pointsNeeded} more points (£${amountNeeded.toFixed(2)} more).`;
        document.getElementById('mainPayoutStatus').textContent = message;
        document.getElementById('paymentTabStatus').textContent = message;
        return;
      }

      // Check if already pending
      const { data: existingRequests } = await supabase
        .from('payout_requests')
        .select('*')
        .eq('user_id', currentUser.id)
        .eq('status', 'pending');

      if (existingRequests.length > 0) {
        const message = 'You already have a pending payout request.';
        document.getElementById('mainPayoutStatus').textContent = message;
        document.getElementById('paymentTabStatus').textContent = message;
        return;
      }

      // Insert payout request with current total likes count
      // This is crucial: we store the TOTAL likes at time of request
      // When admin marks as completed, this number is used to calculate what's been paid
      const { error } = await supabase.from('payout_requests').insert([{
        user_id: currentUser.id,
        amount: availableEarnings,
        likes_at_payout: totalLikes, // Store TOTAL likes, not just available likes
        status: 'pending',
        requested_at: new Date().toISOString()
      }]);

      if (error) throw error;

      const successMessage = `Payout request submitted! £${availableEarnings.toFixed(2)} from ${availableLikes} available points (${totalLikes} total points).`;
      document.getElementById('mainPayoutStatus').textContent = successMessage;
      document.getElementById('paymentTabStatus').textContent = successMessage;
      
      console.log('💸 Payout requested:', {
        amount: `£${availableEarnings.toFixed(2)}`,
        availableLikes,
        totalLikesAtRequest: totalLikes
      });
      
      // Refresh all displays
      await updateAllDisplays();
      await loadPayoutsHistory();
      
    } catch (err) {
      const errorMessage = 'Error submitting payout request: ' + err.message;
      document.getElementById('mainPayoutStatus').textContent = errorMessage;
      document.getElementById('paymentTabStatus').textContent = errorMessage;
      console.error('💸 Payout request failed:', err);
    } finally {
      mainBtn.disabled = false;
      paymentBtn.disabled = false;
    }
  }

  // Form Event Listeners
  document.getElementById('profileForm').onsubmit = async (e) => {
    e.preventDefault();
    await saveProfile();
  };

  document.getElementById('addGameForm').onsubmit = async (e) => {
    e.preventDefault();
    const submitBtn = document.getElementById('gameSubmitBtn');
    submitBtn.disabled = true;
    showMessage('gameFormMessage', '');

    const data = {
      user_id: currentUser.id,
      github_user: currentUser.user_metadata?.user_name || currentUser.email || 'unknown',
      avatar_url: currentUser.user_metadata?.avatar_url || null,
      title: document.getElementById('gameTitle').value.trim(),
      description: document.getElementById('gameDescription').value.trim(),
      embed_url: document.getElementById('embedUrl').value.trim(),
      screenshot_url: document.getElementById('screenshotUrl').value.trim() || null,
      cover_url: document.getElementById('coverUrl').value.trim() || null,
      created_at: new Date().toISOString()
    };

    const { error } = await supabase.from('game_submissions').insert([data]);
    if (error) {
      showMessage('gameFormMessage', 'Adding game failed: ' + error.message, 'error');
    } else {
      showMessage('gameFormMessage', 'Game added successfully!', 'success');
      document.getElementById('addGameForm').reset();
      loadGames();
      loadProfileStats();
      updateAllDisplays();
    }
    submitBtn.disabled = false;
  };

  document.getElementById('addVideoForm').onsubmit = async (e) => {
    e.preventDefault();
    const submitBtn = document.getElementById('videoSubmitBtn');
    submitBtn.disabled = true;
    showMessage('videoFormMessage', '');

    const data = {
      github_username: currentUser.user_metadata?.user_name || currentUser.email || 'unknown',
      avatar_url: currentUser.user_metadata?.avatar_url || null,
      title: document.getElementById('videoTitle').value.trim(),
      content: document.getElementById('videoContent').value.trim(),
      video_url: document.getElementById('videoUrl').value.trim(),
      created_at: new Date().toISOString()
    };

    const { error } = await supabase.from('game_videos').insert([data]);
    if (error) {
      showMessage('videoFormMessage', 'Adding video failed: ' + error.message, 'error');
    } else {
      showMessage('videoFormMessage', 'Video added successfully!', 'success');
      document.getElementById('addVideoForm').reset();
      loadVideos();
      loadProfileStats();
      updateAllDisplays();
    }
    submitBtn.disabled = false;
  };

  document.getElementById('addMusicForm').onsubmit = async (e) => {
    e.preventDefault();
    const submitBtn = document.getElementById('musicSubmitBtn');
    submitBtn.disabled = true;
    showMessage('musicFormMessage', '');

    const data = {
      github_username: currentUser.user_metadata?.user_name || currentUser.email,
      avatar_url: currentUser.user_metadata?.avatar_url || '',
      title: document.getElementById('musicTitle').value.trim(),
      description: document.getElementById('musicDescription').value.trim(),
      music_url: document.getElementById('musicUrl').value.trim(),
      created_at: new Date().toISOString()
    };

    const { error } = await supabase.from('user_music').insert([data]);
    if (error) {
      showMessage('musicFormMessage', 'Adding music failed: ' + error.message, 'error');
    } else {
      showMessage('musicFormMessage', 'Music added successfully!', 'success');
      document.getElementById('addMusicForm').reset();
      loadMusic();
      loadProfileStats();
      updateAllDisplays();
    }
    submitBtn.disabled = false;
  };

  document.getElementById('addArtForm').onsubmit = async (e) => {
    e.preventDefault();
    const submitBtn = document.getElementById('artSubmitBtn');
    submitBtn.disabled = true;
    showMessage('artFormMessage', '');

    const data = {
      github_username: currentUser.user_metadata?.user_name || currentUser.email,
      avatar_url: currentUser.user_metadata?.avatar_url || '',
      title: document.getElementById('artTitle').value.trim(),
      description: document.getElementById('artDescription').value.trim(),
      image_url: document.getElementById('artImageUrl').value.trim(),
      created_at: new Date().toISOString()
    };

    const { error } = await supabase.from('user_art').insert([data]);
    if (error) {
      showMessage('artFormMessage', 'Adding art failed: ' + error.message, 'error');
    } else {
      showMessage('artFormMessage', 'Art added successfully!', 'success');
      document.getElementById('addArtForm').reset();
      loadArt();
      loadProfileStats();
      updateAllDisplays();
    }
    submitBtn.disabled = false;
  };

  // Event Listeners for Payout Buttons
  document.getElementById('mainPayoutBtn').addEventListener('click', requestPayout);
  document.getElementById('paymentTabPayoutBtn').addEventListener('click', requestPayout);

  // Initialize
  (async () => {
    if (!(await checkAuth())) return;

    await updateAllDisplays();
    await loadProfile();
    await loadGames();
    await loadVideos();
    await loadMusic();
    await loadArt();
    await loadPayoutsHistory();
  })();

</script>
  
</body>
</html>






