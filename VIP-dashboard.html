<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BrownDogGames</title>
  <link rel="icon" href="https://raw.githubusercontent.com/ItsMeDevX/BrownDogGames/main/LogoDog.ico" type="image/x-icon">
</head>
 
<script>(function(s){s.dataset.zone='9368472',s.src='https://gizokraijaw.net/vignette.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>
 
 <meta name="description" content="Discover and play free games, watch videos, and explore art. Join the BrownDogGames community and support creators.">
 <meta name="keywords" content="free games, indie games, game community, discover games, videos, art, game platform, creators">
 <meta name="author" content="BrownDogGames">
 <meta property="og:title" content="BrownDogGames - Discover Games, Videos & Art">

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1336090735244829"
crossorigin="anonymous"></script>
  
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BrownDogGames - Adult Cartoon Games</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Rubik+Mono+One&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@700&display=swap');

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Rubik Mono One', sans-serif;
      background-color: #1e1b2e;
      color: #fefefe;
      min-height: 100vh;
      padding: 20px;
      background-image: linear-gradient(135deg, #2c1b33, #191425);
      text-align: center;
    }

    /* Access Choice Gate */
    #access-choice-gate {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      justify-content: flex-start;
      align-items: center;
      flex-direction: column;
      z-index: 10000;
      color: #ff69b4;
      font-family: 'Rubik Mono One', sans-serif;
      text-align: center;
      padding: 20px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    #access-choice-gate.show {
      display: flex;
    }

    .choice-gate-content {
      background: #2a243b;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 0 30px rgba(255, 105, 180, 0.5);
      max-width: 800px;
      width: 90%;
      margin: 20px auto;
    }

    .access-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin: 30px 0;
    }

    .access-option {
      background: #3b3750;
      padding: 30px 20px;
      border-radius: 12px;
      border: 3px solid transparent;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .access-option:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }

    .access-option.vip {
      border-color: #2ecc71;
      background: linear-gradient(135deg, #2d4a3a, #3b4d42);
    }

    .access-option.vip:hover {
      border-color: #27ae60;
      box-shadow: 0 10px 25px rgba(46, 204, 113, 0.3);
    }

    .access-option.free {
      border-color: #3498db;
      background: linear-gradient(135deg, #2c3e50, #34495e);
    }

    .access-option.free:hover {
      border-color: #2980b9;
      box-shadow: 0 10px 25px rgba(52, 152, 219, 0.3);
    }

    .access-option h3 {
      font-size: 1.5rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .access-option.vip h3 {
      color: #2ecc71;
    }

    .access-option.free h3 {
      color: #3498db;
    }

    .access-option .price {
      font-size: 2rem;
      font-weight: bold;
      margin: 15px 0;
    }

    .access-option.vip .price {
      color: #2ecc71;
    }

    .access-option.free .price {
      color: #3498db;
    }

    .feature-list {
      list-style: none;
      text-align: left;
      margin: 20px 0;
    }

    .feature-list li {
      padding: 8px 0;
      color: #ffc0cb;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
    }

    .feature-list .icon {
      width: 20px;
      text-align: center;
    }

    .vip-only-features {
      background: #2d4a3a;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border-left: 4px solid #2ecc71;
    }

    .free-features {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border-left: 4px solid #3498db;
    }

    /* VIP Process Steps */
    .vip-process {
      display: none;
      margin-top: 30px;
    }

    .vip-step {
      background: #3b3750;
      padding: 20px;
      border-radius: 8px;
      margin: 15px 0;
      border: 2px solid #ff69b4;
    }

    .vip-step.completed {
      background: #2a4d3a;
      border-color: #2ecc71;
    }

    .vip-step h4 {
      color: #ff69b4;
      margin-bottom: 15px;
      font-size: 1.1rem;
    }

    .vip-step.completed h4 {
      color: #2ecc71;
    }

    #github-login-btn {
      background: #333;
      color: #fff;
      border: none;
      padding: 12px 24px;
      font-weight: bold;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      margin: 10px 0;
    }

    #github-login-btn:hover {
      background: #555;
    }

    #github-login-btn:disabled {
      background: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .login-status {
      color: #2ecc71;
      font-size: 0.9rem;
      margin-top: 10px;
      display: none;
    }

    .login-status.show {
      display: block;
    }

    #vip-paypal-container {
      margin: 20px 0;
    }

    .gate-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .gate-buttons button {
      background: #666;
      color: #fff;
      border: none;
      padding: 12px 24px;
      font-weight: bold;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      min-width: 150px;
    }

    .gate-buttons button:hover {
      background: #888;
    }

    .gate-buttons button.primary {
      background: #ff69b4;
      color: #1e1b2e;
    }

    .gate-buttons button.primary:hover {
      background: #ff8edb;
    }

    #access-message {
      margin: 15px 0;
      padding: 12px;
      border-radius: 8px;
      display: none;
      font-size: 0.9rem;
    }

    .success-message {
      background: #2ecc71;
      color: white;
    }

    .error-message {
      background: #e74c3c;
      color: white;
    }

    .access-note {
      background: #3b3750;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      border: 2px solid #ff69b4;
      color: #ffc0cb;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .access-note strong {
      color: #ff69b4;
    }

    /* Taskbar */
    #taskbar {
      max-width: 1200px;
      margin: 20px auto;
      background-color: #2a243b;
      border-radius: 12px;
      box-shadow: 0 0 12px #00000055;
      padding: 15px 20px;
      font-family: 'Rubik Mono One', sans-serif;
      color: #fefefe;
      position: relative;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 20px;
    }

    .taskbar-logo {
      display: flex;
      align-items: center;
    }

    .taskbar-logo img {
      height: 90px;
      width: auto;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .taskbar-logo img:hover {
      transform: scale(1.1);
    }

    .taskbar-nav {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .taskbar-nav button {
      background-color: #ff69b4;
      color: #1e1b2e;
      border: none;
      padding: 0.5rem 1rem;
      font-weight: bold;
      font-size: 0.9rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
      white-space: nowrap;
    }

    .taskbar-nav button:hover {
      background-color: #ff8edb;
    }

    .taskbar-nav button.vip-only {
      background-color: #666;
      color: #999;
      cursor: not-allowed;
      position: relative;
    }

    .taskbar-nav button.vip-only:hover::after {
      content: "VIP Only";
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      white-space: nowrap;
    }

    .taskbar-search {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }

    .taskbar-search input {
      width: 200px;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      background-color: #3b3750;
      color: #fefefe;
    }

    .taskbar-search button {
      background-color: #ff69b4;
      color: #1e1b2e;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s;
    }

    .taskbar-search button:hover {
      background-color: #ff8edb;
    }

    /* Message Notifications */
    .taskbar-messages {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }

    .messages-button {
      background-color: #ff69b4;
      color: #1e1b2e;
      border: none;
      padding: 8px 16px;
      font-weight: bold;
      font-size: 0.9rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .messages-button:hover {
      background-color: #ff8edb;
      transform: scale(1.05);
    }

    .messages-button.has-unread {
      background: linear-gradient(45deg, #ff69b4, #ff1493);
      animation: pulse-glow 2s infinite;
    }

    .message-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: linear-gradient(45deg, #ff4444, #ff6666);
      color: white;
      border-radius: 50%;
      min-width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
      border: 2px solid #2a243b;
      animation: bounce-badge 1s infinite;
    }

    @keyframes pulse-glow {
      0%, 100% {
        box-shadow: 0 0 5px rgba(255, 105, 180, 0.5);
      }
      50% {
        box-shadow: 0 0 20px rgba(255, 105, 180, 0.8);
      }
    }

    @keyframes bounce-badge {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
    }

    .message-preview-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background-color: #2a243b;
      border: 2px solid #ff69b4;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
      min-width: 320px;
      max-width: 400px;
      display: none;
      flex-direction: column;
      z-index: 1000;
      margin-top: 10px;
      max-height: 400px;
      overflow-y: auto;
    }

    .message-preview-dropdown.show {
      display: flex;
    }

    .message-preview-header {
      background: #3b3750;
      padding: 12px 16px;
      border-bottom: 1px solid #ff69b4;
      font-weight: bold;
      color: #ff69b4;
      text-align: center;
      border-radius: 10px 10px 0 0;
    }

    .message-preview-item {
      padding: 12px 16px;
      border-bottom: 1px solid #3b3750;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .message-preview-item:hover {
      background-color: #3b3750;
    }

    .message-preview-item.unread {
      background: linear-gradient(90deg, rgba(255, 105, 180, 0.1), transparent);
      border-left: 3px solid #ff69b4;
    }

    .message-preview-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      border: 2px solid #ff69b4;
      object-fit: cover;
      flex-shrink: 0;
    }

    .message-preview-content {
      flex: 1;
      min-width: 0;
    }

    .message-preview-sender {
      font-weight: bold;
      color: #ff69b4;
      font-size: 0.9rem;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .message-preview-text {
      color: #fefefe;
      font-size: 0.8rem;
      line-height: 1.3;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .message-preview-time {
      color: #999;
      font-size: 0.7rem;
      margin-top: 2px;
    }

    .message-preview-footer {
      padding: 10px 16px;
      text-align: center;
      border-top: 1px solid #3b3750;
      background: #3b3750;
      border-radius: 0 0 10px 10px;
    }

    .message-preview-footer button {
      background: linear-gradient(45deg, #ff69b4, #ff8edb);
      color: #1e1b2e;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.8rem;
    }

    .message-preview-footer button:hover {
      transform: scale(1.05);
    }

    .no-messages {
      text-align: center;
      color: #999;
      font-style: italic;
      padding: 20px;
      font-size: 0.9rem;
    }

    .taskbar-vip {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .taskbar-vip button {
      background-color: #ff69b4;
      color: #1e1b2e;
      border: none;
      padding: 8px 16px;
      font-weight: bold;
      font-size: 0.9rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .taskbar-vip button:hover {
      background-color: #ff8edb;
    }

    .vip-status {
      color: #2ecc71;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .free-status {
      color: #3498db;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .taskbar-auth {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }

    .taskbar-auth button {
      background-color: #ff69b4;
      color: #1e1b2e;
      border: none;
      padding: 8px 16px;
      font-weight: bold;
      font-size: 0.9rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .taskbar-auth button:hover {
      background-color: #ff8edb;
    }

    /* Dropdown styles */
    #suggestions-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background-color: #3b3750;
      border-radius: 8px;
      box-shadow: 0 4px 12px #00000077;
      display: none;
      flex-direction: column;
      z-index: 10;
      margin-top: 5px;
    }

    #suggestions-dropdown > div {
      padding: 8px 12px;
      cursor: pointer;
      transition: background-color 0.2s;
      color: #fefefe;
    }

    #suggestions-dropdown > div:hover {
      background-color: #ff69b4;
      color: #1e1b2e;
    }

    #user-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background-color: #3b3750;
      border: 2px solid #ff69b4;
      border-radius: 8px;
      box-shadow: 0 4px 12px #00000077;
      min-width: 150px;
      display: none;
      flex-direction: column;
      z-index: 1000;
      margin-top: 5px;
    }

    #user-dropdown button {
      background: none;
      border: none;
      color: #fefefe;
      padding: 12px 16px;
      text-align: left;
      font-weight: bold;
      font-family: 'Rubik Mono One', sans-serif;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
      width: 100%;
      border-radius: 0;
    }

    #user-dropdown button:hover {
      background-color: #ff69b4;
      color: #1e1b2e;
    }

    #user-dropdown button:first-child {
      border-radius: 6px 6px 0 0;
    }

    #user-dropdown button:last-child {
      border-radius: 0 0 6px 6px;
    }

    #user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }

    #user-info img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid #ff69b4;
      object-fit: cover;
    }

    @media (max-width: 900px) {
      #taskbar {
        max-width: 95%;
        flex-direction: column;
        gap: 15px;
        text-align: center;
        padding: 20px;
      }

      .taskbar-logo img {
        height: 75px;
      }

      .taskbar-nav {
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
      }

      .taskbar-search input {
        width: 200px;
      }

      .access-options {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .gate-buttons {
        flex-direction: column;
        align-items: center;
      }

      .choice-gate-content {
        padding: 20px 15px;
        margin: 10px;
        max-width: 95%;
      }

      .message-preview-dropdown {
        right: -50px;
        min-width: 280px;
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 10px;
      }

      .taskbar-logo img {
        height: 65px;
      }

      .choice-gate-content {
        padding: 15px 10px;
        margin: 5px;
      }

      .access-option {
        padding: 20px 15px;
      }

      .access-option h3 {
        font-size: 1.2rem;
      }

      .access-option .price {
        font-size: 1.5rem;
      }

      .message-preview-dropdown {
        right: -100px;
        min-width: 260px;
      }
    }
  </style>
</head>
<body>

<!-- Access Choice Gate -->
<div id="access-choice-gate">
  <div class="choice-gate-content">
    <h2>🎮 Welcome to BrownDogGames</h2>
    <p>Choose your access level - VIP membership or free browsing:</p>

    <div class="access-note">
      <strong>📌 Note:</strong> Anyone can post content, games, art, and videos to earn money! VIP membership unlocks exclusive community features and premium content sharing with other VIP members.
    </div>

    <div class="access-options">
      <!-- VIP Option -->
      <div class="access-option vip" id="vip-option">
        <h3>⭐ VIP Access</h3>
        <div class="price">£2/month</div>
        <ul class="feature-list">
          <li><span class="icon">👑</span> Exclusive VIP Members Dashboard</li>
          <li><span class="icon">💬</span> Direct messaging with VIP members</li>
          <li><span class="icon">🎁</span> Share exclusive content with VIPs</li>
          <li><span class="icon">💰</span> Get paid for playing games</li>
          <li><span class="icon">📊</span> Advanced member statistics</li>
          <li><span class="icon">✨</span> VIP content creation & sharing</li>
          <li><span class="icon">🏆</span> Priority support & features</li>
        </ul>
        <div class="vip-only-features">
          <strong>Premium Features:</strong> VIP-only dashboard, exclusive content sharing, member-to-member messaging, and premium community access
        </div>
      </div>

      <!-- Free Option -->
      <div class="access-option free" id="free-option">
        <h3>🆓 Free Access</h3>
        <div class="price">Free</div>
        <ul class="feature-list">
          <li><span class="icon">🎮</span> Browse & play all public games</li>
          <li><span class="icon">👀</span> View all user profiles</li>
          <li><span class="icon">🖼️</span> See user art & videos</li>
          <li><span class="icon">📤</span> Post your own content & games</li>
          <li><span class="icon">💰</span> Earn money from your uploads</li>
          <li><span class="icon">🔍</span> Search & discover content</li>
        </ul>
        <div class="free-features">
          <strong>Free Features:</strong> Full access to browse content, post your own creations, and earn money - perfect for creators and casual users
        </div>
      </div>
    </div>

    <!-- VIP Process (hidden initially) -->
    <div class="vip-process" id="vip-process">
      <div class="vip-step" id="login-step">
        <h4>Step 1: Create Account</h4>
        <p>Login with GitHub to create your VIP account</p>
        <button id="github-login-btn">🔑 Login with GitHub</button>
        <div class="login-status" id="login-status">✅ Successfully logged in!</div>
      </div>

      <div class="vip-step" id="payment-step" style="display: none;">
        <h4>Step 2: Subscribe for VIP Access</h4>
        <p>Subscribe to VIP for just £2/month - unlocks exclusive member features and premium community access!</p>
        <div id="vip-paypal-container"></div>
      </div>
    </div>
      
    <div id="access-message"></div>
      
    <div class="gate-buttons">
      <button id="back-to-options" style="display: none;">← Back to Options</button>
    </div>
  </div>
</div>

<!-- Taskbar -->
<div id="taskbar">
  <div class="taskbar-logo">
    <img 
      src="https://raw.githubusercontent.com/ItsMeDevX/BrownDogGames/main/BrownDogGamesLogo.png" 
      alt="BrownDogGames Logo"
      onclick="window.location.href='index.html'"
    >
  </div>

  <div class="taskbar-nav" id="taskbar-nav">
    <!-- Navigation buttons injected by JS -->
  </div>
  
  <div class="taskbar-search">
    <input type="text" id="game-search-input" placeholder="Search games..." />
    <button id="search-button">Search</button>
    <div id="suggestions-dropdown"></div>
  </div>

  <!-- Message Notifications -->
  <div class="taskbar-messages" id="taskbar-messages" style="display: none;">
    <button class="messages-button" id="messages-button">
      💬 Messages
      <span class="message-badge" id="message-badge" style="display: none;">0</span>
    </button>
    <div class="message-preview-dropdown" id="message-preview-dropdown">
      <div class="message-preview-header">Recent Messages</div>
      <div id="message-preview-list">
        <div class="no-messages">No new messages</div>
      </div>
      <div class="message-preview-footer">
        <button onclick="window.location.href='user-profiles.html'">View All Messages</button>
      </div>
    </div>
  </div>

  <div class="taskbar-vip" id="taskbar-vip">
    <!-- VIP button/status injected by JS -->
  </div>
  
  <div class="taskbar-auth" id="taskbar-auth">
    <!-- Auth content injected by JS -->
  </div>
</div>

<!-- Scripts -->
<script src="https://www.paypal.com/sdk/js?client-id=AYgrpkjHd7Ycq_8vUWm9nb3qigcwALSTbyMZ5o6LjMqjC1YscFwQ_1kDEMr7tm2D1xysfHSEiyhZ1pZl&vault=true&intent=subscription"></script>

<script>
  // Global variables
  let gateUser = null;
  let supabaseClient = null;
  let authInitialized = false;
  let messageUpdateInterval = null;

  // Access Management
  document.addEventListener('DOMContentLoaded', () => {
    const accessChoiceGate = document.getElementById('access-choice-gate');
    const vipOption = document.getElementById('vip-option');
    const freeOption = document.getElementById('free-option');
    const vipProcess = document.getElementById('vip-process');
    const backToOptionsBtn = document.getElementById('back-to-options');
    const accessMessage = document.getElementById('access-message');
    const githubLoginBtn = document.getElementById('github-login-btn');
    const loginStep = document.getElementById('login-step');
    const paymentStep = document.getElementById('payment-step');
    const loginStatus = document.getElementById('login-status');

    // Check if user already has access
    function checkExistingAccess() {
      const hasVIPAccess = localStorage.getItem('vipAccess') === 'true';
      const hasFreeAccess = localStorage.getItem('freeAccess') === 'true';

      // If user has any access, don't show gate
      if (hasVIPAccess || hasFreeAccess) {
        return true;
      }
      return false;
    }

    // Show access gate if no existing access
    if (!checkExistingAccess()) {
      accessChoiceGate.classList.add('show');
    }

    // VIP Option Click
    vipOption.addEventListener('click', () => {
      vipProcess.style.display = 'block';
      backToOptionsBtn.style.display = 'inline-block';
      document.querySelector('.access-options').style.display = 'none';
    });

    // Free Option Click
    freeOption.addEventListener('click', () => {
      // Grant free access
      localStorage.setItem('freeAccess', 'true');
      
      showAccessMessage('🎉 Free access granted! Welcome to BrownDogGames!');
      
      setTimeout(() => {
        accessChoiceGate.classList.remove('show');
        // Re-render taskbar to show free status
        if (window.renderVip) {
          window.renderVip();
        }
      }, 2000);
    });

    // Back to Options
    backToOptionsBtn.addEventListener('click', () => {
      vipProcess.style.display = 'none';
      backToOptionsBtn.style.display = 'none';
      document.querySelector('.access-options').style.display = 'grid';
      hideAccessMessage();
    });

    // GitHub Login
    githubLoginBtn.addEventListener('click', () => {
      githubLoginBtn.disabled = true;
      githubLoginBtn.textContent = 'Connecting...';
      
      if (window.supabaseClient) {
        window.supabaseClient.auth.signInWithOAuth({ provider: 'github' });
      } else {
        showAccessMessage('Loading login system...', true);
        setTimeout(() => {
          if (window.supabaseClient) {
            window.supabaseClient.auth.signInWithOAuth({ provider: 'github' });
          } else {
            githubLoginBtn.disabled = false;
            githubLoginBtn.textContent = '🔑 Login with GitHub';
            showAccessMessage('Login system failed to load. Please refresh the page.', true);
          }
        }, 2000);
      }
    });

    // Listen for login success
    let loginHandlerAdded = false;
    
    function addLoginHandler() {
      if (!loginHandlerAdded) {
        window.addEventListener('vip-user-logged-in', (event) => {
          gateUser = event.detail;
          showLoginSuccess();
        });
        loginHandlerAdded = true;
      }
    }
    
    addLoginHandler();

    function showLoginSuccess() {
      loginStep.classList.add('completed');
      githubLoginBtn.style.display = 'none';
      loginStatus.classList.add('show');
      
      setTimeout(() => {
        showPaymentStep();
      }, 1500);
    }

    function showPaymentStep() {
      paymentStep.style.display = 'block';
      
      setTimeout(() => {
        initVIPPayPal();
      }, 500);
    }

    function showAccessMessage(text, isError = false) {
      accessMessage.textContent = text;
      accessMessage.className = isError ? 'error-message' : 'success-message';
      accessMessage.style.display = 'block';
    }

    function hideAccessMessage() {
      accessMessage.style.display = 'none';
    }

    // Make initVIPPayPal available globally so upgrade button can use it
    window.initVIPPayPal = initVIPPayPal;

    function initVIPPayPal() {
      if (typeof paypal === 'undefined') {
        showAccessMessage('PayPal not loaded. Please refresh the page.', true);
        return;
      }

      if (!gateUser) {
        showAccessMessage('Please login first before subscribing.', true);
        return;
      }

      const container = document.getElementById('vip-paypal-container');
      if (container) {
        // Only clear if no active PayPal buttons exist
        if (!container.hasChildNodes() || !container.querySelector('.paypal-buttons')) {
          container.innerHTML = '';
        }
      }

      paypal.Buttons({
        style: {
          shape: 'rect',
          color: 'gold',
          layout: 'vertical',
          label: 'subscribe',
          height: 45
        },

        createSubscription(data, actions) {
          hideAccessMessage();
          return actions.subscription.create({
            plan_id: 'P-20H197268N8973414NBIXE2I'
          });
        },

        onApprove: async (data) => {
          hideAccessMessage();
          const subscriptionID = data.subscriptionID;

          try {
            // Save to database
            if (window.supabaseClient && gateUser) {
              const { error } = await window.supabaseClient
                .from('users')
                .upsert({
                  id: gateUser.id,
                  is_vip: true,
                  vip_expires_at: null,
                  paypal_transaction_id: subscriptionID
                });

              if (error) {
                console.error('Failed to update database:', error);
              }
            }

            // Grant VIP access
            localStorage.setItem('vipAccess', 'true');
            localStorage.setItem('vipSubscriptionId', subscriptionID);
            localStorage.setItem('vipActivatedAt', new Date().toISOString());

            showAccessMessage('🎉 VIP access activated! Welcome to BrownDogGames Premium!');

            setTimeout(() => {
              accessChoiceGate.classList.remove('show');
              if (window.renderVip) {
                window.renderVip();
              }
            }, 2000);

          } catch (error) {
            console.error('Error processing subscription:', error);
            showAccessMessage('Subscription successful, but there was an error. Please refresh the page.', true);
          }
        },

        onError: (err) => {
          console.error('PayPal error:', err);
          showAccessMessage('Payment error. Please try again or contact support.', true);
        },

        onCancel: (data) => {
          showAccessMessage('Payment cancelled. You can still choose free access instead.', true);
        }

      }).render('#vip-paypal-container');
    }

    // Check access every 30 seconds to prevent manipulation, only when page is not active
    setInterval(() => {
      if (document.hidden || !document.hasFocus()) {
        const hasVIPAccess = localStorage.getItem('vipAccess') === 'true';
        const hasFreeAccess = localStorage.getItem('freeAccess') === 'true';

        // If no access, show gate
        if (!(hasVIPAccess || hasFreeAccess)) {
          accessChoiceGate.classList.add('show');
        }
      }
    }, 30000);
  });

  // Message Notifications System
  function initMessageNotifications() {
    const messagesButton = document.getElementById('messages-button');
    const messagePreviewDropdown = document.getElementById('message-preview-dropdown');
    const messageBadge = document.getElementById('message-badge');
    
    if (!messagesButton) return;

    // Toggle dropdown
    messagesButton.addEventListener('click', (e) => {
      e.stopPropagation();
      const isVisible = messagePreviewDropdown.classList.contains('show');
      
      if (isVisible) {
        messagePreviewDropdown.classList.remove('show');
      } else {
        messagePreviewDropdown.classList.add('show');
        loadMessagePreviews();
      }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!messagePreviewDropdown.contains(e.target) && !messagesButton.contains(e.target)) {
        messagePreviewDropdown.classList.remove('show');
      }
    });
  }

  // Load message previews
  async function loadMessagePreviews() {
    const messagePreviewList = document.getElementById('message-preview-list');
    
    if (!window.supabaseClient || !window.currentUser || !window.currentUsername) {
      messagePreviewList.innerHTML = '<div class="no-messages">Please log in to see messages</div>';
      return;
    }

    try {
      // Get recent unread messages
      const { data: messages, error } = await window.supabaseClient
        .from('direct_messages')
        .select('*')
        .eq('recipient_username', window.currentUsername)
        .eq('is_read', false)
        .order('created_at', { ascending: false })
        .limit(5);

      if (error) {
        console.error('Error loading message previews:', error);
        messagePreviewList.innerHTML = '<div class="no-messages">Error loading messages</div>';
        return;
      }

      if (!messages || messages.length === 0) {
        messagePreviewList.innerHTML = '<div class="no-messages">No new messages</div>';
        return;
      }

      // Group by sender to show latest message from each
      const senderMap = new Map();
      for (const message of messages) {
        if (!senderMap.has(message.sender_username)) {
          senderMap.set(message.sender_username, message);
        }
      }

      const uniqueMessages = Array.from(senderMap.values());

      // Render message previews
      const previewsHtml = await Promise.all(uniqueMessages.map(async (message) => {
        const avatar = await getAvatarForUsername(message.sender_username);
        const time = new Date(message.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const preview = message.message_content.substring(0, 50) + (message.message_content.length > 50 ? '...' : '');
        
        return `
          <div class="message-preview-item unread" onclick="openUserProfile('${message.sender_username}')">
            ${avatar ? `<img src="${avatar}" alt="${message.sender_username}" class="message-preview-avatar">` : 
                      `<div class="message-preview-avatar" style="background: #ff4f9f; display: flex; align-items: center; justify-content: center; color: #1b1b2e; font-weight: bold; font-size: 0.8rem;">${message.sender_username.charAt(0).toUpperCase()}</div>`}
            <div class="message-preview-content">
              <div class="message-preview-sender">
                ${message.sender_username}
                <span class="message-preview-time">${time}</span>
              </div>
              <div class="message-preview-text">${preview}</div>
            </div>
          </div>
        `;
      }));

      messagePreviewList.innerHTML = previewsHtml.join('');

    } catch (error) {
      console.error('Error in loadMessagePreviews:', error);
      messagePreviewList.innerHTML = '<div class="no-messages">Error loading messages</div>';
    }
  }

  // Update message count and badge
  async function updateMessageNotifications() {
    if (!window.supabaseClient || !window.currentUser || !window.currentUsername) {
      return;
    }

    try {
      // Count unread messages
      const { count, error } = await window.supabaseClient
        .from('direct_messages')
        .select('*', { count: 'exact', head: true })
        .eq('recipient_username', window.currentUsername)
        .eq('is_read', false);

      if (error) {
        console.error('Error counting unread messages:', error);
        return;
      }

      const unreadCount = count || 0;
      const messagesButton = document.getElementById('messages-button');
      const messageBadge = document.getElementById('message-badge');
      const taskbarMessages = document.getElementById('taskbar-messages');

      if (unreadCount > 0) {
        // Show notifications
        taskbarMessages.style.display = 'flex';
        messagesButton.classList.add('has-unread');
        messageBadge.style.display = 'flex';
        messageBadge.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
      } else {
        // Hide badge but keep messages button visible for logged-in users
        messagesButton.classList.remove('has-unread');
        messageBadge.style.display = 'none';
        
        // Only show messages button if user is logged in
        if (window.currentUser) {
          taskbarMessages.style.display = 'flex';
        } else {
          taskbarMessages.style.display = 'none';
        }
      }

    } catch (error) {
      console.error('Error in updateMessageNotifications:', error);
    }
  }

  // Open user profile when clicking message preview
  window.openUserProfile = function(username) {
    const messagePreviewDropdown = document.getElementById('message-preview-dropdown');
    messagePreviewDropdown.classList.remove('show');
    
    // Mark messages from this user as read
    markMessagesAsRead(username);
    
    window.location.href = `user.html?user=${username}`;
  };

  // Mark messages as read when viewing
  async function markMessagesAsRead(senderUsername) {
    if (!window.supabaseClient || !window.currentUsername) return;
    
    try {
      const { error } = await window.supabaseClient
        .from('direct_messages')
        .update({ is_read: true })
        .eq('recipient_username', window.currentUsername)
        .eq('sender_username', senderUsername)
        .eq('is_read', false);
        
      if (error) {
        console.error('Error marking messages as read:', error);
      } else {
        // Update notification count immediately
        updateMessageNotifications();
      }
    } catch (error) {
      console.error('Error in markMessagesAsRead:', error);
    }
  }

  // Get avatar for username (helper function)
  async function getAvatarForUsername(username) {
    if (!window.supabaseClient) return null;
    
    try {
      // Try games first
      const { data: gameData } = await window.supabaseClient
        .from('game_submissions')
        .select('avatar_url')
        .eq('github_user', username)
        .limit(1);
      
      if (gameData && gameData.length > 0 && gameData[0].avatar_url) {
        return gameData[0].avatar_url;
      }

      // Try videos
      const { data: videoData } = await window.supabaseClient
        .from('game_videos')
        .select('avatar_url')
        .eq('github_username', username)
        .limit(1);
      
      if (videoData && videoData.length > 0 && videoData[0].avatar_url) {
        return videoData[0].avatar_url;
      }

      // Try art
      const { data: artData } = await window.supabaseClient
        .from('user_art')
        .select('avatar_url')
        .eq('github_username', username)
        .limit(1);
      
      if (artData && artData.length > 0 && artData[0].avatar_url) {
        return artData[0].avatar_url;
      }

      return null;
    } catch (error) {
      console.error('Error getting avatar:', error);
      return null;
    }
  }

  // Game Search
  const gamePages = [
    { title: 'Lapdance Dash', url: 'https://browndoggames.com/Lapdance-Dash.html' },
    { title: 'Naked Craft', url: 'https://browndoggames.com/naked-craft.html' },
    { title: 'Butt Blaster Arena', url: 'https://browndoggames.com/butt-blaster-arena.html' },
    { title: 'Streaker Run', url: 'https://browndoggames.com/streaker-run.html' },
    { title: 'Pet Penis Simulator', url: 'https://browndoggames.com/pet-penis-simulator.html' },
    { title: 'Naked Fang', url: 'https://browndoggames.com/naked-fang.html' },
    { title: 'Climax Clash', url: 'https://browndoggames.com/Climax-Clash.html' },
    { title: 'Shafted', url: 'https://browndoggames.com/Shafted.html' },
    { title: 'She Comes First', url: 'https://browndoggames.com/She-Comes-First.html' },
    { title: 'LustLab', url: 'https://browndoggames.com/LustLab.html' }
  ];

  const searchInput = document.getElementById('game-search-input');
  const suggestionsDropdown = document.getElementById('suggestions-dropdown');
  let highlightedIndex = -1;

  searchInput.addEventListener('input', () => {
    const query = searchInput.value.trim().toLowerCase();
    
    if (query) {
      const firstLetterMatches = gamePages.filter(game => 
        game.title.toLowerCase().startsWith(query[0])
      );

      const results = firstLetterMatches.concat(gamePages.filter(game => 
        game.title.toLowerCase().includes(query) && !game.title.toLowerCase().startsWith(query[0])
      ));

      if (results.length > 0) {
        suggestionsDropdown.style.display = 'flex';
        suggestionsDropdown.innerHTML = '';

        results.forEach((game, index) => {
          const suggestionItem = document.createElement('div');
          suggestionItem.innerHTML = game.title;
          suggestionItem.addEventListener('click', () => {
            window.location.href = game.url;
          });
          suggestionsDropdown.appendChild(suggestionItem);
        });
      } else {
        suggestionsDropdown.style.display = 'none';
      }
    } else {
      suggestionsDropdown.style.display = 'none';
    }
  });

  searchInput.addEventListener('keydown', (e) => {
    const suggestions = suggestionsDropdown.querySelectorAll('div');

    if (e.key === 'ArrowDown') {
      if (highlightedIndex < suggestions.length - 1) {
        highlightedIndex++;
        updateHighlightedItem(suggestions);
      }
    } else if (e.key === 'ArrowUp') {
      if (highlightedIndex > 0) {
        highlightedIndex--;
        updateHighlightedItem(suggestions);
      }
    } else if (e.key === 'Enter' && highlightedIndex >= 0) {
      suggestions[highlightedIndex].click();
    }
  });

  function updateHighlightedItem(suggestions) {
    suggestions.forEach((item, index) => {
      if (index === highlightedIndex) {
        item.style.backgroundColor = '#ff69b4';
        item.style.color = '#1e1b2e';
      } else {
        item.style.backgroundColor = 'transparent';
        item.style.color = '#fefefe';
      }
    });
  }

  document.getElementById('search-button').addEventListener('click', () => {
    const query = searchInput.value.trim().toLowerCase();
    const result = gamePages.find(game => game.title.toLowerCase() === query);

    if (result) {
      window.location.href = result.url;
    } else {
      alert('No game found for your search.');
    }
  });

  document.addEventListener('click', (event) => {
    if (!searchInput.contains(event.target) && !suggestionsDropdown.contains(event.target)) {
      suggestionsDropdown.style.display = 'none';
      highlightedIndex = -1;
    }
  });
</script>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

  const supabase = createClient(
    'https://fwslmbzfukriibnkpzou.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3c2xtYnpmdWtyaWlibmtwem91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4NTcxMDcsImV4cCI6MjA2NDQzMzEwN30.juWK3T16_-LGHPii7xLp92Tt5TAZKN3IcZVn6nR8cBA'
  );

  // Make supabase available globally
  window.supabaseClient = supabase;

  // Add error handling for Supabase initialization
  if (!supabase) {
    console.error('Failed to initialize Supabase client');
  }

  const taskbarNav = document.getElementById('taskbar-nav');
  const taskbarAuth = document.getElementById('taskbar-auth');
  const taskbarVip = document.getElementById('taskbar-vip');

  // Global state tracking
  let currentVIPStatus = false;
  let currentUser = null;
  let currentUsername = null;
  let isInitialized = false;
  let renderingInProgress = false;

  // State synchronization helper
  function syncAccessState() {
    const hasVIPAccess = localStorage.getItem('vipAccess') === 'true';
    const hasFreeAccess = localStorage.getItem('freeAccess') === 'true';
    
    // Update UI to match localStorage state
    if (window.renderVip) {
      window.renderVip();
    }
    
    // Update access gate visibility
    const accessChoiceGate = document.getElementById('access-choice-gate');
    if (accessChoiceGate) {
      if (hasVIPAccess || hasFreeAccess) {
        accessChoiceGate.classList.remove('show');
      } else {
        accessChoiceGate.classList.add('show');
      }
    }
  }

  // Make global variables accessible
  window.currentUser = null;
  window.currentUsername = null;

  function toggleDropdown(dropdown) {
    dropdown.style.display = (dropdown.style.display === 'flex') ? 'none' : 'flex';
  }

  async function checkVIPStatus(userId) {
    // Check local VIP access first
    const localVIP = localStorage.getItem('vipAccess') === 'true';
    
    if (localVIP) return true;
    if (!userId) return false;

    try {
      const { data: user, error } = await supabase
        .from('users')
        .select('is_vip')
        .eq('id', userId)
        .single();

      if (error) {
        console.error('Error fetching VIP status:', error);
        return false;
      }

      // If user is VIP in database, grant local access too
      if (user?.is_vip) {
        localStorage.setItem('vipAccess', 'true');
      }

      return user?.is_vip ?? false;
    } catch (error) {
      console.error('Exception in checkVIPStatus:', error);
      return false;
    }
  }

  function renderNav() {
    if (renderingInProgress) return;
    taskbarNav.innerHTML = '';

    // User Games (always available)
    const userGamesBtn = document.createElement('button');
    userGamesBtn.textContent = 'User Games';
    userGamesBtn.addEventListener('click', () => window.location.href = 'user-games.html');
    taskbarNav.appendChild(userGamesBtn);

    // User Video (always available)
    const userVideoBtn = document.createElement('button');
    userVideoBtn.textContent = 'User Video';
    userVideoBtn.addEventListener('click', () => window.location.href = 'user-videos.html');
    taskbarNav.appendChild(userVideoBtn);

    // User Music (always available)
    const userMusicBtn = document.createElement('button');
    userMusicBtn.textContent = 'User Music';
    userMusicBtn.addEventListener('click', () => window.location.href = 'user-music.html');
    taskbarNav.appendChild(userMusicBtn);

    // User Art (always available)
    const userArtBtn = document.createElement('button');
    userArtBtn.textContent = 'User Art';
    userArtBtn.addEventListener('click', () => window.location.href = 'user-art.html');
    taskbarNav.appendChild(userArtBtn);

    // User Profiles (always available)
    const userProfilesBtn = document.createElement('button');
    userProfilesBtn.textContent = 'User Profiles';
    userProfilesBtn.addEventListener('click', () => window.location.href = 'user-profiles.html');
    taskbarNav.appendChild(userProfilesBtn);
  }

  async function renderVip() {
    if (renderingInProgress) return;
    
    taskbarVip.innerHTML = '';
    
    const hasVIPAccess = localStorage.getItem('vipAccess') === 'true';
    const hasFreeAccess = localStorage.getItem('freeAccess') === 'true';
    
    if (hasVIPAccess || currentVIPStatus) {
      const vipStatus = document.createElement('div');
      vipStatus.className = 'vip-status';
      vipStatus.innerHTML = '⭐ VIP Member';
      taskbarVip.appendChild(vipStatus);
    } else if (hasFreeAccess) {
      const freeStatus = document.createElement('div');
      freeStatus.className = 'free-status';
      freeStatus.innerHTML = '🆓 Free Member';
      taskbarVip.appendChild(freeStatus);

      // Add upgrade button for free users
      const upgradeBtn = document.createElement('button');
      upgradeBtn.textContent = 'Upgrade to VIP';
      upgradeBtn.style.background = 'linear-gradient(45deg, #2ecc71, #27ae60)';
      upgradeBtn.addEventListener('click', () => {
        // Show access gate with VIP process
        const accessGate = document.getElementById('access-choice-gate');
        if (accessGate) {
          // If user is already logged in, skip to payment step
          if (currentUser) {
            // Set the gate user
            gateUser = currentUser;
            
            // Hide options and show VIP process
            document.querySelector('.access-options').style.display = 'none';
            document.getElementById('vip-process').style.display = 'block';
            document.getElementById('back-to-options').style.display = 'inline-block';
            
            // Mark login as completed and show payment step
            const loginStep = document.getElementById('login-step');
            const paymentStep = document.getElementById('payment-step');
            const loginStatus = document.getElementById('login-status');
            
            loginStep.classList.add('completed');
            document.getElementById('github-login-btn').style.display = 'none';
            loginStatus.classList.add('show');
            paymentStep.style.display = 'block';
            
            // Initialize PayPal
            setTimeout(() => {
              initVIPPayPal();
            }, 500);
            
            accessGate.classList.add('show');
          } else {
            // User not logged in, show normal flow
            gateUser = null; // Ensure gateUser is reset
            document.querySelector('.access-options').style.display = 'grid';
            document.getElementById('vip-process').style.display = 'none';
            document.getElementById('back-to-options').style.display = 'none';
            accessGate.classList.add('show');
          }
        }
      });
      taskbarVip.appendChild(upgradeBtn);
    } else {
      const noAccessNote = document.createElement('div');
      noAccessNote.style.color = '#888';
      noAccessNote.style.fontSize = '0.8rem';
      noAccessNote.textContent = 'Choose Access Level';
      taskbarVip.appendChild(noAccessNote);
    }
  }

  async function renderAuth() {
    if (renderingInProgress) return;
    renderingInProgress = true;

    try {
      const { data: { session } } = await supabase.auth.getSession();
      
      taskbarAuth.innerHTML = '';
      
      const existingDropdown = document.getElementById('user-dropdown');
      if (existingDropdown) {
        existingDropdown.remove();
      }

      if (session?.user) {
        currentUser = session.user;
        window.currentUser = currentUser;
        
        // Get username from metadata
        currentUsername = session.user.user_metadata?.user_name || 
                         session.user.user_metadata?.preferred_username;
        
        if (!currentUsername) {
          // Fallback: Get from game submissions
          try {
            const { data: gameData } = await supabase
              .from('game_submissions')
              .select('github_user')
              .eq('user_id', currentUser.id)
              .limit(1);
            
            if (gameData && gameData.length > 0) {
              currentUsername = gameData[0].github_user;
            } else {
              // Final fallback to email
              currentUsername = currentUser.email;
            }
          } catch (error) {
            console.error('Error getting username:', error);
            currentUsername = currentUser.email;
          }
        }
        
        window.currentUsername = currentUsername;
        
        currentVIPStatus = await checkVIPStatus(session.user.id);
        
        // Notify VIP gate if it's showing and user isn't already set
        const accessGate = document.getElementById('access-choice-gate');
        if (accessGate && accessGate.classList.contains('show') && !gateUser) {
          window.dispatchEvent(new CustomEvent('vip-user-logged-in', { detail: session.user }));
        }
        
        const { user_metadata } = session.user;
        const name = user_metadata.full_name || 'GitHub User';
        const avatar = user_metadata.avatar_url || '';

        const userInfo = document.createElement('div');
        userInfo.id = 'user-info';

        if (avatar) {
          const img = document.createElement('img');
          img.src = avatar;
          img.alt = name;
          userInfo.appendChild(img);
        }

        const nameDiv = document.createElement('div');
        nameDiv.innerHTML = `
          <strong style="
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background-color: #ff69b4;
            color: #1e1b2e;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            box-shadow: 0 0 10px #ff8edb;
          " title="Click for options">
            ${name}
            <span style="font-size: 1.2rem; margin-left: 4px;">▾</span>
          </strong>
        `;
        userInfo.appendChild(nameDiv);
        taskbarAuth.appendChild(userInfo);

        const dropdown = document.createElement('div');
        dropdown.id = 'user-dropdown';

        const myPageBtn = document.createElement('button');
        myPageBtn.textContent = 'My Page';
        myPageBtn.onclick = async () => {
          dropdown.style.display = 'none';
          try {
            const { data: { user }, error: userError } = await supabase.auth.getUser();
            if (userError || !user) {
              console.error('Unable to get user:', userError);
              return;
            }

            const { data, error } = await supabase
              .from('game_submissions')
              .select('id')
              .eq('user_id', user.id)
              .limit(1);

            if (error) {
              console.error('Error checking submission:', error);
              return;
            }

            if (data && data.length > 0 && currentUsername) {
              window.location.href = `user.html?user=${currentUsername}`;
            } else {
              window.location.href = 'dashboard.html';
            }
          } catch (error) {
            console.error('Error in myPageBtn click:', error);
          }
        };

        const dashboardBtn = document.createElement('button');
        dashboardBtn.textContent = 'Dashboard';
        dashboardBtn.onclick = () => {
          dropdown.style.display = 'none';
          window.location.href = 'dashboard.html';
        };

        const logoutBtn = document.createElement('button');
        logoutBtn.textContent = 'Logout';
        logoutBtn.onclick = async () => {
          try {
            // Clear message update interval
            if (messageUpdateInterval) {
              clearInterval(messageUpdateInterval);
              messageUpdateInterval = null;
            }
            
            await supabase.auth.signOut();
            
            // Clear all access data on logout
            localStorage.removeItem('vipAccess');
            localStorage.removeItem('freeAccess');
            localStorage.removeItem('vipSubscriptionId');
            localStorage.removeItem('vipActivatedAt');
            
            currentUser = null;
            currentUsername = null;
            window.currentUser = null;
            window.currentUsername = null;
            currentVIPStatus = false;
            
            // Hide message notifications
            const taskbarMessages = document.getElementById('taskbar-messages');
            if (taskbarMessages) {
              taskbarMessages.style.display = 'none';
            }
            
            // Show access gate again after logout
            const accessChoiceGate = document.getElementById('access-choice-gate');
            if (accessChoiceGate) {
              accessChoiceGate.classList.add('show');
            }
            
            window.location.reload();
          } catch (error) {
            console.error('Error during logout:', error);
          }
        };

        dropdown.appendChild(myPageBtn);
        dropdown.appendChild(dashboardBtn);
        dropdown.appendChild(logoutBtn);

        taskbarAuth.appendChild(dropdown);
        userInfo.addEventListener('click', () => toggleDropdown(dropdown));

        // Start message notifications for logged-in users
        updateMessageNotifications();
        
        // Set up periodic message checking
        if (messageUpdateInterval) {
          clearInterval(messageUpdateInterval);
          messageUpdateInterval = null;
        }
        messageUpdateInterval = setInterval(updateMessageNotifications, 30000); // Check every 30 seconds

      } else {
        currentUser = null;
        currentUsername = null;
        window.currentUser = null;
        window.currentUsername = null;
        currentVIPStatus = false;
        
        // Clear message update interval
        if (messageUpdateInterval) {
          clearInterval(messageUpdateInterval);
          messageUpdateInterval = null;
        }
        
        // Hide message notifications
        const taskbarMessages = document.getElementById('taskbar-messages');
        if (taskbarMessages) {
          taskbarMessages.style.display = 'none';
        }
        
        const loginBtn = document.createElement('button');
        loginBtn.textContent = 'Login with GitHub';
        loginBtn.addEventListener('click', () => {
          supabase.auth.signInWithOAuth({ provider: 'github' });
        });
        taskbarAuth.appendChild(loginBtn);
      }
    } catch (error) {
      console.error('Error in renderAuth:', error);
    } finally {
      renderingInProgress = false;
    }
  }

  // Global click handler for dropdowns
  let globalClickHandlerAdded = false;
  
  function addGlobalClickHandler() {
    if (!globalClickHandlerAdded) {
      document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('user-dropdown');
        const userInfo = document.getElementById('user-info');
        const messageDropdown = document.getElementById('message-preview-dropdown');
        const messagesButton = document.getElementById('messages-button');
        
        // Handle user dropdown
        if (dropdown && userInfo && !userInfo.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.style.display = 'none';
        }
        
        // Handle message dropdown (ensure consistency)
        if (messageDropdown && messagesButton && 
            !messageDropdown.contains(e.target) && !messagesButton.contains(e.target)) {
          messageDropdown.classList.remove('show');
        }
      });
      globalClickHandlerAdded = true;
    }
  }

  // Initialize everything
  async function initializeApp() {
    if (isInitialized) return;
    isInitialized = true;

    try {
      renderNav();
      await renderAuth();
      await renderVip();
      addGlobalClickHandler();
      initMessageNotifications();

      let authChangeTimeout;
      supabase.auth.onAuthStateChange(async (event, session) => {
        clearTimeout(authChangeTimeout);
        authChangeTimeout = setTimeout(async () => {
          if (!renderingInProgress) {
            await renderAuth();
            await renderVip();
            renderNav(); // Re-render nav to update VIP features
          }
        }, 100);
      });

    } catch (error) {
      console.error('Error initializing app:', error);
    }
  }

  // Make render functions globally accessible
  window.renderVip = renderVip;
  window.renderAuth = renderAuth;
  window.renderNav = renderNav;

  // Start the app when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApp);
  } else {
    initializeApp();
  }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VIP Members Dashboard - BrownDogGames</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Rubik+Mono+One&display=swap');
    
    body {
      background-color: #1e1b2e;
      background-image: linear-gradient(135deg, #361c3e, #1a1328);
      color: #fefefe;
      font-family: 'Rubik Mono One', sans-serif;
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      line-height: 1.6;
      text-align: left;
    }
    
    .vip-header {
      text-align: center;
      margin-bottom: 2rem;
      position: relative;
    }
    
    .vip-crown {
      font-size: 4rem;
      margin-bottom: 0.5rem;
      animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    h1 {
      color: #ffd700;
      font-size: 3rem;
      text-shadow: 3px 3px 0 #000, 0 0 20px #ffd700;
      margin-bottom: 0.5rem;
      background: linear-gradient(45deg, #ffd700, #ffed4a);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .vip-subtitle {
      color: #ff8edb;
      font-size: 1.2rem;
      margin-bottom: 2rem;
    }
    
    .access-denied {
      text-align: center;
      padding: 3rem 2rem;
      background: linear-gradient(145deg, #3d1a1a, #4a2020);
      border: 2px solid #ff4444;
      border-radius: 15px;
      margin: 2rem 0;
    }
    
    .access-denied h2 {
      color: #ff4444;
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    
    .access-denied p {
      color: #ff8888;
      font-size: 1.1rem;
      margin-bottom: 2rem;
    }
    
    .access-denied button {
      background: linear-gradient(45deg, #ff69b4, #ff8edb);
      color: #1e1b2e;
      border: none;
      padding: 1rem 2rem;
      border-radius: 8px;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 0.5rem;
    }
    
    .access-denied button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 105, 180, 0.4);
    }
    
    .loading {
      text-align: center;
      color: #ffd700;
      font-size: 1.2rem;
      margin: 2rem 0;
    }
    
    .vip-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .vip-stat-card {
      background: linear-gradient(145deg, #2d1a3a, #3b2750);
      border: 2px solid #ffd700;
      border-radius: 15px;
      padding: 2rem;
      text-align: center;
      position: relative;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .vip-stat-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255, 215, 0, 0.1), transparent);
      transform: rotate(45deg);
      animation: shimmer 3s linear infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-200%) translateY(-200%) rotate(45deg); }
      100% { transform: translateX(200%) translateY(200%) rotate(45deg); }
    }
    
    @keyframes slideIn {
      from { transform: translateX(300px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(300px); opacity: 0; }
    }
    
    .vip-stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(255, 215, 0, 0.3);
    }
    
    .vip-stat-icon {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      position: relative;
      z-index: 1;
    }
    
    .vip-stat-value {
      color: #ffd700;
      font-size: 2.2rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
      position: relative;
      z-index: 1;
    }
    
    .vip-stat-label {
      color: #ff8edb;
      font-size: 1rem;
      position: relative;
      z-index: 1;
    }
    
    .vip-perks-section {
      background: linear-gradient(145deg, #2d1a3a, #3b2750);
      border: 2px solid #ff69b4;
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
    }
    
    .vip-perks-title {
      color: #ffd700;
      font-size: 1.8rem;
      text-align: center;
      margin-bottom: 1.5rem;
      text-shadow: 2px 2px 0 #000;
    }
    
    .perks-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }
    
    .perk-item {
      background: linear-gradient(135deg, #3b2750, #4a3157);
      border: 1px solid #ff69b4;
      border-radius: 10px;
      padding: 1.5rem;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .perk-item:hover {
      transform: scale(1.05);
      border-color: #ffd700;
      box-shadow: 0 5px 20px rgba(255, 215, 0, 0.2);
    }
    
    .perk-emoji {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    
    .perk-title {
      color: #ff69b4;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }
    
    .perk-desc {
      color: #ffc0cb;
      font-size: 0.9rem;
      line-height: 1.4;
    }
    
    .vip-members-section {
      background: linear-gradient(145deg, #2d1a3a, #3b2750);
      border: 2px solid #8dffa1;
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
    }
    
    .members-title {
      color: #8dffa1;
      font-size: 1.8rem;
      text-align: center;
      margin-bottom: 1.5rem;
      text-shadow: 2px 2px 0 #000;
    }
    
    .members-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
    }
    
    .member-card {
      background: linear-gradient(135deg, #3b2750, #4a3157);
      border: 1px solid #8dffa1;
      border-radius: 10px;
      padding: 1.5rem;
      text-align: center;
      position: relative;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .member-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(141, 255, 161, 0.2);
      border-color: #ffd700;
    }
    
    .member-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 3px solid #8dffa1;
      margin: 0 auto 1rem;
      object-fit: cover;
    }
    
    .member-avatar-placeholder {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 3px solid #8dffa1;
      margin: 0 auto 1rem;
      background: linear-gradient(45deg, #ff69b4, #8dffa1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: bold;
      color: #1e1b2e;
    }
    
    .member-status {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #8dffa1;
      color: #1e1b2e;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    .member-username {
      color: #8dffa1;
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
      font-weight: bold;
    }
    
    .member-since {
      color: #ffc0cb;
      font-size: 0.9rem;
      margin-bottom: 0.3rem;
    }
    
    .member-expires {
      color: #ff8edb;
      font-size: 0.8rem;
    }
    
    .member-actions {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
      justify-content: center;
    }
    
    .member-actions button {
      background: linear-gradient(45deg, #ff69b4, #ff8edb);
      color: #1e1b2e;
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .member-actions button:hover {
      transform: scale(1.05);
      box-shadow: 0 3px 10px rgba(255, 105, 180, 0.3);
    }
    
    .vip-message-center {
      background: linear-gradient(145deg, #2d1a3a, #3b2750);
      border: 2px solid #ff8d8d;
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
    }
    
    .message-title {
      color: #ff8d8d;
      font-size: 1.8rem;
      text-align: center;
      margin-bottom: 1.5rem;
      text-shadow: 2px 2px 0 #000;
    }
    
    .message-input-group {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    
    .message-input {
      flex: 1;
      min-width: 200px;
      padding: 0.8rem;
      background: #3b2750;
      border: 2px solid #ff69b4;
      border-radius: 8px;
      color: #fefefe;
      font-family: inherit;
    }
    
    .message-send-btn {
      background: linear-gradient(45deg, #ff69b4, #ff8edb);
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      color: #1e1b2e;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .message-send-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 105, 180, 0.4);
    }
    
    .message-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ff69b4;
      border-radius: 8px;
      padding: 1rem;
      background: rgba(59, 39, 80, 0.5);
    }
    
    .message-item {
      background: #3b2750;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.5rem;
      border-left: 3px solid #ff69b4;
      transition: all 0.2s ease;
    }
    
    .message-item:hover {
      background: #4a3157;
      transform: translateX(5px);
    }
    
    .message-sender {
      color: #ff8edb;
      font-weight: bold;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .message-content {
      color: #ffc0cb;
      margin-bottom: 0.5rem;
      line-height: 1.4;
    }
    
    .message-time {
      color: #999;
      font-size: 0.8rem;
    }
    
    .vip-extras-section {
      background: linear-gradient(145deg, #2d1a3a, #3b2750);
      border: 2px solid #ff69b4;
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
    }
    
    .extras-title {
      color: #ffd700;
      font-size: 1.8rem;
      text-align: center;
      margin-bottom: 1.5rem;
      text-shadow: 2px 2px 0 #000;
    }
    
    .extras-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
    }
    
    .add-content-btn {
      background: linear-gradient(45deg, #ff69b4, #ff8edb);
      color: #1e1b2e;
      border: none;
      padding: 1rem 2rem;
      border-radius: 12px;
      font-weight: bold;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255, 105, 180, 0.3);
    }
    
    .add-content-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(255, 105, 180, 0.4);
    }
    
    .content-form {
      background: linear-gradient(145deg, #3b2750, #4a3157);
      border: 2px solid #ff69b4;
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-group label {
      display: block;
      color: #ff8edb;
      font-weight: bold;
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.8rem;
      background: #2d1a3a;
      border: 2px solid #8dffa1;
      border-radius: 8px;
      color: #fefefe;
      font-family: inherit;
      font-size: 0.9rem;
      transition: border-color 0.3s ease;
    }
    
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #ffd700;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
    }
    
    .form-group small {
      display: block;
      color: #999;
      font-size: 0.8rem;
      margin-top: 0.3rem;
      font-style: italic;
    }
    
    .form-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .form-buttons button {
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 150px;
    }
    
    #submit-content-btn {
      background: linear-gradient(45deg, #2ecc71, #27ae60);
      color: #fff;
    }
    
    #submit-content-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
    }
    
    #submit-content-btn:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    #cancel-content-btn {
      background: linear-gradient(45deg, #666, #888);
      color: #fff;
    }
    
    #cancel-content-btn:hover {
      background: linear-gradient(45deg, #777, #999);
    }
    
    .extra-item {
      background: linear-gradient(135deg, #3b2750, #4a3157);
      border: 1px solid #ff69b4;
      border-radius: 10px;
      padding: 1.5rem;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }
    
    .extra-item:hover {
      transform: translateY(-5px);
      border-color: #ffd700;
      box-shadow: 0 10px 25px rgba(255, 105, 180, 0.2);
    }
    
    .extra-type-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: linear-gradient(45deg, #8dffa1, #7dd87d);
      color: #1e1b2e;
      padding: 0.3rem 0.6rem;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: bold;
    }
    
    .extra-title {
      color: #ff69b4;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
      font-weight: bold;
      padding-right: 60px; /* Make room for badge */
    }
    
    .extra-description {
      color: #ffc0cb;
      font-size: 0.9rem;
      line-height: 1.4;
      margin-bottom: 1rem;
    }
    
    .extra-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .extra-creator {
      color: #8dffa1;
      font-size: 0.8rem;
      font-weight: bold;
    }
    
    .extra-date {
      color: #999;
      font-size: 0.7rem;
    }
    
    .extra-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .extra-actions button {
      background: linear-gradient(45deg, #ff69b4, #ff8edb);
      color: #1e1b2e;
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .extra-actions button:hover {
      transform: scale(1.05);
    }
    
    .extra-actions .delete-btn {
      background: linear-gradient(45deg, #e74c3c, #c0392b);
      color: #fff;
    }
    
    .extra-actions .delete-btn:hover {
      background: linear-gradient(45deg, #c0392b, #a93226);
    }
    
    .back-button {
      background: linear-gradient(45deg, #666, #888);
      color: #fff;
      border: none;
      padding: 1rem 2rem;
      border-radius: 8px;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 2rem auto;
      display: block;
    }
    
    .back-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    #error-message {
      display: none;
      text-align: center;
      color: #ff8d8d;
      font-size: 1.1rem;
      margin: 2rem 0;
      padding: 1rem;
      background: rgba(255, 68, 68, 0.1);
      border: 1px solid #ff4444;
      border-radius: 8px;
    }
    
    /* New styles for member bio, location, points */
    .member-bio {
      color: #ffc0cb;
      font-size: 0.8rem;
      margin-top: 0.5rem;
      line-height: 1.3;
    }
    
    .member-location {
      color: #8dffa1;
      font-size: 0.8rem;
      margin-bottom: 0.3rem;
    }
    
    .member-points {
      color: #ffd700;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      font-weight: bold;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 10px;
        margin: 20px auto;
      }
      
      .vip-stats-grid {
        grid-template-columns: 1fr;
      }
      
      .perks-grid {
        grid-template-columns: 1fr;
      }
      
      .members-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
      
      .extras-grid {
        grid-template-columns: 1fr;
      }
      
      .message-input-group {
        flex-direction: column;
      }
      
      h1 {
        font-size: 2.2rem;
      }
      
      .vip-subtitle {
        font-size: 1rem;
      }
      
    }
  </style>
</head>
<body>
  <div class="vip-header">
    <div class="vip-crown">👑</div>
    <h1>VIP MEMBERS ONLY</h1>
    <p class="vip-subtitle">Welcome to your exclusive VIP dashboard</p>
  </div>

  <!-- Access Denied Section (shown for non-VIP users) -->
  <div class="access-denied" id="access-denied" style="display: none;">
    <h2>🚫 VIP Access Required</h2>
    <p>This exclusive dashboard is only available to VIP members. Upgrade your account to access premium features, direct messaging, social engagement tools, and connect with other VIP members!</p>
    <button onclick="window.location.href='index.html'">🏠 Return to Home</button>
    <button onclick="showUpgradeOptions()">⭐ Upgrade to VIP</button>
  </div>

  <!-- Loading Screen -->
  <div class="loading" id="loading">
    ✨ Loading your VIP experience...
  </div>

  <!-- VIP Dashboard Content -->
  <div id="vip-content" style="display: none;">
    <!-- VIP Stats Overview -->
    <div class="vip-stats-grid" id="vip-stats">
      <div class="vip-stat-card">
        <div class="vip-stat-icon">💎</div>
        <div class="vip-stat-value" id="totalVips">0</div>
        <div class="vip-stat-label">Active VIP Members</div>
      </div>
      
      <div class="vip-stat-card">
        <div class="vip-stat-icon">⏰</div>
        <div class="vip-stat-value" id="yourExpiry">--</div>
        <div class="vip-stat-label">Your VIP Status</div>
      </div>
      
      <div class="vip-stat-card">
        <div class="vip-stat-icon">💌</div>
        <div class="vip-stat-value" id="unreadMessages">0</div>
        <div class="vip-stat-label">Unread Messages</div>
      </div>
      
      <div class="vip-stat-card">
        <div class="vip-stat-icon">🎯</div>
        <div class="vip-stat-value" id="vipSince">--</div>
        <div class="vip-stat-label">VIP Member Since</div>
      </div>
    </div>

    <!-- VIP Perks Section -->
    <div class="vip-perks-section">
      <h2 class="vip-perks-title">🌟 Your VIP Perks</h2>
      <div class="perks-grid">
        <div class="perk-item">
          <div class="perk-emoji">🔓</div>
          <div class="perk-title">Exclusive Content</div>
          <div class="perk-desc">Access to premium games, videos, and special features not available to free users</div>
        </div>
        
        <div class="perk-item">
          <div class="perk-emoji">💬</div>
          <div class="perk-title">Direct Messaging</div>
          <div class="perk-desc">Send and receive private messages with other VIP members in the community</div>
        </div>
        
        <div class="perk-item">
          <div class="perk-emoji">🎮</div>
          <div class="perk-title">VIP Games</div>
          <div class="perk-desc">Access to exclusive games and interactive content created by community members</div>
        </div>
        
        <div class="perk-item">
          <div class="perk-emoji">🏆</div>
          <div class="perk-title">Priority Support</div>
          <div class="perk-desc">Get priority customer support and faster responses to your questions</div>
        </div>
        
        <div class="perk-item">
          <div class="perk-emoji">🎨</div>
          <div class="perk-title">Custom Requests</div>
          <div class="perk-desc">Request custom content and personalized experiences from creators</div>
        </div>
        
        <div class="perk-item">
          <div class="perk-emoji">📊</div>
          <div class="perk-title">Advanced Stats</div>
          <div class="perk-desc">View detailed analytics and exclusive leaderboards for games and content</div>
        </div>
      </div>
    </div>

    <!-- VIP Extras Section -->
    <div class="vip-extras-section">
      <h2 class="extras-title">🎁 VIP Exclusive Content</h2>
      
      <!-- Add Content Button -->
      <div style="text-align: center; margin-bottom: 2rem;">
        <button id="add-content-btn" class="add-content-btn">
          ➕ Share New Content
        </button>
      </div>
      
      <!-- Content Submission Form (Hidden by default) -->
      <div class="content-form" id="content-form" style="display: none;">
        <h3 style="color: #ff69b4; text-align: center; margin-bottom: 1rem;">📤 Share VIP Content</h3>
        
        <div class="form-group">
          <label for="content-title">Title:</label>
          <input type="text" id="content-title" placeholder="Give your content a catchy title..." maxlength="100" />
        </div>
        
        <div class="form-group">
          <label for="content-description">Description:</label>
          <textarea id="content-description" placeholder="Describe what VIP members will find..." maxlength="500" rows="3"></textarea>
        </div>
        
        <div class="form-group">
          <label for="content-type">Content Type:</label>
          <select id="content-type">
            <option value="game">🎮 Game</option>
            <option value="video">🎥 Video</option>
            <option value="art">🎨 Art/Image</option>
            <option value="story">📖 Story/Text</option>
            <option value="tutorial">📚 Tutorial</option>
            <option value="other">✨ Other</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="content-url">Content URL:</label>
          <input type="url" id="content-url" placeholder="https://..." />
          <small>Link to your game, video, image, or any content you want to share</small>
        </div>
        
        <div class="form-buttons">
          <button id="submit-content-btn">🚀 Share with VIPs</button>
          <button id="cancel-content-btn" type="button">❌ Cancel</button>
        </div>
      </div>
      
      <!-- Content List -->
      <div class="extras-grid" id="vip-extras-list">
        <!-- VIP extras will be loaded here -->
      </div>
    </div>

    <!-- VIP Members List -->
    <div class="vip-members-section">
      <h2 class="members-title">👥 Fellow VIP Members</h2>
      <div class="members-grid" id="members-list">
        <!-- Members will load here -->
      </div>
    </div>

    <!-- VIP Message Center -->
    <div class="vip-message-center">
      <h2 class="message-title">💬 VIP Message Center</h2>
      
      <div class="message-input-group">
        <input type="text" class="message-input" id="recipient-input" placeholder="Recipient username..." />
        <input type="text" class="message-input" id="message-input" placeholder="Your message..." />
        <button class="message-send-btn" id="send-message-btn">Send ✉️</button>
      </div>
      
      <div class="message-list" id="message-list">
        <div style="text-align: center; color: #999; padding: 2rem;">
          📭 No messages yet. Start a conversation!
        </div>
      </div>
    </div>
  </div>

  <div id="error-message">
    😢 Error loading VIP dashboard
  </div>

  <button onclick="window.location.href='index.html'" class="back-button">
    🏠 Return to Home
  </button>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    
    const supabase = createClient(
      'https://fwslmbzfukriibnkpzou.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3c2xtYnpmdWtyaWlibmtwem91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4NTcxMDcsImV4cCI6MjA2NDQzMzEwN30.juWK3T16_-LGHPii7xLp92Tt5TAZKN3IcZVn6nR8cBA'
    );

    // Global variables
    let currentUser = null;
    let currentUsername = null;
    let isVIPUser = false;
    let consolidationMap = {}; // Store consolidation mapping

    // Tab Management
    window.showTab = function(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active class from all buttons
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(tabName + '-tab').classList.add('active');
      
      // Add active class to clicked button
      event.target.classList.add('active');
    };

    // Utility Functions
    function showMessage(elementId, text, type = '') {
      const element = document.getElementById(elementId);
      element.textContent = text;
      element.className = `message ${type}`;
    }

    function formatDate(dateString) {
      if (!dateString) return '--';
      return new Date(dateString).toLocaleDateString('en-GB', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      });
    }

    function getTimeUntilExpiry(expiryDate) {
      if (!expiryDate) return 'Lifetime';
      
      const expiry = new Date(expiryDate);
      const now = new Date();
      const diff = expiry - now;
      
      if (diff <= 0) return 'Expired';
      
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      if (days === 0) return 'Expires today';
      if (days === 1) return '1 day left';
      return `${days} days left`;
    }

    function showError(message) {
      const errorEl = document.getElementById('error-message');
      const loadingEl = document.getElementById('loading');
      
      loadingEl.style.display = 'none';
      errorEl.textContent = `😢 ${message}`;
      errorEl.style.display = 'block';
    }

    function showAccessDenied() {
      const accessDeniedEl = document.getElementById('access-denied');
      const loadingEl = document.getElementById('loading');
      
      loadingEl.style.display = 'none';
      accessDeniedEl.style.display = 'block';
    }

    function showVIPContent() {
      const vipContentEl = document.getElementById('vip-content');
      const loadingEl = document.getElementById('loading');
      
      loadingEl.style.display = 'none';
      vipContentEl.style.display = 'block';
    }

    // Check authentication and VIP status
    async function checkUserAccess() {
      try {
        // Get current session
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        
        if (sessionError) {
          console.error('Session error:', sessionError);
          showAccessDenied();
          return false;
        }

        if (!session?.user) {
          console.log('No authenticated user');
          showAccessDenied();
          return false;
        }

        currentUser = session.user;
        
        // Get username from metadata with better fallback
        currentUsername = session.user.user_metadata?.user_name || 
                         session.user.user_metadata?.preferred_username;
        
        // If no username from metadata, try to get from database
        if (!currentUsername) {
          try {
            const { data: userData, error: userError } = await supabase
              .from('users')
              .select('github_username')
              .eq('id', currentUser.id)
              .single();
            
            if (userError) {
              console.error('Error fetching username from users:', userError);
            }
            
            if (userData && userData.github_username) {
              currentUsername = userData.github_username;
            }
          } catch (error) {
            console.error('Error getting username from database:', error);
          }
        }
        
        // Final fallback to email prefix
        if (!currentUsername) {
          currentUsername = currentUser.email?.split('@')[0] || currentUser.id;
        }

        // Check VIP status in database
        const { data: userData, error: userError } = await supabase
          .from('users')
          .select('*')
          .eq('id', currentUser.id)
          .single();

        if (userError && userError.code !== 'PGRST116') { // PGRST116 is "not found"
          console.error('User lookup error:', userError);
        }

        // Check local VIP access or database VIP status
        const localVIP = localStorage.getItem('vipAccess') === 'true';
        const dbVIP = userData?.is_vip === true;
        
        isVIPUser = localVIP || dbVIP;

        if (!isVIPUser) {
          console.log('User is not VIP');
          showAccessDenied();
          return false;
        }

        // If local VIP but not in database, create/update user record
        if (localVIP && !dbVIP) {
          try {
            await supabase
              .from('users')
              .upsert({
                id: currentUser.id,
                is_vip: true,
                created_at: new Date().toISOString(),
                github_username: currentUsername
              });
          } catch (error) {
            console.error('Error updating user VIP status:', error);
          }
        }

        return true;

      } catch (error) {
        console.error('Error checking user access:', error);
        showError('Authentication check failed');
        return false;
      }
    }

    // Enhanced username extraction function (same as leaderboard)
    function extractUsername(fullUsername) {
      console.log(`🔍 Dashboard: Extracting username from: "${fullUsername}"`);
      
      // Handle extra format: ItsMeDevX_extra_ae77d5d3-334d-404c-904f-7c62e8107377
      if (fullUsername.includes('_extra_')) {
        const username = fullUsername.split('_extra_')[0];
        console.log(`✅ Dashboard: Extracted from extra: "${username}"`);
        return { username, contentType: 'extras' };
      }
      
      // Handle video format: jsZenO_video_6736ba9f-d596-4429-8a00-a220ff2c40ff
      if (fullUsername.includes('_video_')) {
        const username = fullUsername.split('_video_')[0];
        console.log(`✅ Dashboard: Extracted from video: "${username}"`);
        return { username, contentType: 'videos' };
      }
      
      // Handle game format: livestrong-cell_game_926810a5-c696-4a3d-9b4d-126126761134
      if (fullUsername.includes('_game_')) {
        const username = fullUsername.split('_game_')[0];
        console.log(`✅ Dashboard: Extracted from game: "${username}"`);
        return { username, contentType: 'games' };
      }
      
      // Handle artwork format: kenzolerd145_artwork_c0041829-37ec-46ae-9db9-de24d2637abf
      if (fullUsername.includes('_artwork_')) {
        const username = fullUsername.split('_artwork_')[0];
        console.log(`✅ Dashboard: Extracted from artwork: "${username}"`);
        return { username, contentType: 'art' };
      }
      
      // Handle music format: ItsMeDevX_music_1
      if (fullUsername.includes('_music_')) {
        const username = fullUsername.split('_music_')[0];
        console.log(`✅ Dashboard: Extracted from music: "${username}"`);
        return { username, contentType: 'music' };
      }
      
      // Handle old extra format: extra_someId (map to creator via VIP extras table)
      if (fullUsername.startsWith('extra_')) {
        console.log(`⚠️ Dashboard: Found old extra format: "${fullUsername}" - needs creator lookup`);
        return { username: fullUsername, contentType: 'extras', needsCreatorLookup: true };
      }
      
      // Default case - assume it's a page view
      console.log(`✅ Dashboard: Treating as page view: "${fullUsername}"`);
      return { username: fullUsername, contentType: 'page' };
    }

    // Get consolidation mapping from users table + manual rules (removed game submissions)
    async function getConsolidationMapping() {
      try {
        console.log('🔍 Dashboard: Getting consolidation mappings...');
        
        // Get users with github_username
        const { data: users, error: usersError } = await supabase
          .from('users')
          .select('id, github_username');
        
        if (usersError) {
          console.error('Error fetching users:', usersError);
          return {};
        }

        console.log(`👥 Dashboard: Found ${users?.length || 0} users`);

        // Create mapping (only manual for now)
        const consolidationMap = {};
        
        // Add manual consolidation rules (only for known duplicate accounts)
        const manualRules = {
          'browndoggames': 'itsmedevx',
          'itsmedevX': 'itsmedevx',  // Handle capital X variation
        };

        Object.entries(manualRules).forEach(([from, to]) => {
          consolidationMap[from] = to;
          consolidationMap[from.toLowerCase()] = to;
          console.log(`🔧 Dashboard manual mapping: "${from}" → "${to}"`);
        });

        console.log(`🗺️ Dashboard: Total mappings: ${Object.keys(consolidationMap).length}`);
        return consolidationMap;
        
      } catch (error) {
        console.error('Error getting consolidation mapping:', error);
        return {};
      }
    }

    // Apply consolidation to username (same as leaderboard)
    function consolidateUsername(username, consolidationMap) {
      const lower = username.toLowerCase();
      
      // Check exact match first
      if (consolidationMap[username]) {
        console.log(`✅ Dashboard consolidating: "${username}" → "${consolidationMap[username]}"`);
        return consolidationMap[username];
      }
      
      // Check lowercase match
      if (consolidationMap[lower]) {
        console.log(`✅ Dashboard consolidating (lowercase): "${username}" → "${consolidationMap[lower]}"`);
        return consolidationMap[lower];
      }
      
      return username;
    }

    // FIXED: Enhanced function to get ALL likes across all content types with same logic as leaderboard
    async function getAllLikesBreakdown(targetUsername) {
      if (!targetUsername) return { page: 0, videos: 0, games: 0, art: 0, music: 0, extras: 0, gamePoints: 0, total: 0 };

      try {
        console.log(`🔍 Dashboard: Getting likes breakdown for ${targetUsername}`);

        // Get fresh consolidation mapping
        consolidationMap = await getConsolidationMapping();

        // Step 1: Get ALL VIP extras to map extra IDs to creators (for old format)
        const { data: vipExtras, error: extrasError } = await supabase
          .from('vip_extras')
          .select('id, creator_name, created_by');

        if (extrasError) {
          console.error('Error fetching extras:', extrasError);
        }

        // Create a map from extra ID to creator info (for old extra format)
        const extraCreatorMap = {};
        if (vipExtras) {
          vipExtras.forEach(extra => {
            extraCreatorMap[extra.id] = {
              creatorName: extra.creator_name || 'Unknown Creator',
              createdBy: extra.created_by
            };
          });
        }

        console.log(`🗺️ Dashboard: Created creator map for ${Object.keys(extraCreatorMap).length} extras`);

        // Step 2: Get all view records
        const { data: allViews, error: viewsError } = await supabase
          .from('vip_page_views')
          .select('username, view_count, game_points');

        if (viewsError) throw viewsError;

        console.log(`📊 Dashboard: Found ${allViews?.length || 0} total view records`);

        // Step 3: Initialize the target user's data
        const userLikesData = {
          username: targetUsername,
          page: 0,
          videos: 0,
          games: 0,
          art: 0,
          music: 0,
          extras: 0,
          gamePoints: 0,
          total: 0
        };

        // Step 4: Process all views using same logic as leaderboard
        if (allViews) {
          allViews.forEach((view, index) => {
            const fullUsername = view.username;
            const viewCount = view.view_count || 0;
            const gamePoints = view.game_points || 0;
            
            if (!fullUsername) {
              console.log(`⚠️ Dashboard: Skipping view ${index}: no username`);
              return;
            }

            console.log(`\n--- Dashboard: Processing view ${index + 1}/${allViews.length} ---`);
            console.log(`Full username: "${fullUsername}", views: ${viewCount}, game points: ${gamePoints}`);

            // Extract username and content type using same function as leaderboard
            const { username: extractedUsername, contentType, needsCreatorLookup } = extractUsername(fullUsername);
            
            let finalUsername = extractedUsername;
            let finalContentType = contentType;

            // Handle old extra format that needs creator lookup
            if (needsCreatorLookup && contentType === 'extras') {
              const extraId = fullUsername.replace('extra_', '');
              const creatorInfo = extraCreatorMap[extraId];
              if (creatorInfo && creatorInfo.creatorName) {
                finalUsername = creatorInfo.creatorName;
                console.log(`✅ Dashboard: Mapped old extra ${extraId} to creator: ${finalUsername}`);
              } else {
                console.log(`⚠️ Dashboard: No creator found for old extra ${extraId}, skipping`);
                return;
              }
            }

            // Apply consolidation
            finalUsername = consolidateUsername(finalUsername, consolidationMap);
            console.log(`Dashboard: Final username after consolidation: "${finalUsername}"`);

            // Check if this content belongs to the target user (after consolidation)
            const consolidatedTargetUser = consolidateUsername(targetUsername, consolidationMap);
            
            if (finalUsername === consolidatedTargetUser) {
              // Add to appropriate category
              if (finalContentType === 'page' || finalContentType === 'videos' || finalContentType === 'games' || finalContentType === 'art' || finalContentType === 'music' || finalContentType === 'extras') {
                userLikesData[finalContentType] += viewCount;
                userLikesData.gamePoints += gamePoints;
                console.log(`📈 Dashboard: Added ${viewCount} ${finalContentType} likes + ${gamePoints} game points to ${targetUsername} (consolidated: ${consolidatedTargetUser})`);
                console.log(`Dashboard: Current totals: page:${userLikesData.page}, videos:${userLikesData.videos}, games:${userLikesData.games}, art:${userLikesData.art}, music:${userLikesData.music}, extras:${userLikesData.extras}, gamePoints:${userLikesData.gamePoints}`);
              }
            }
          });
        }

        // Step 5: Calculate total
        const likesTotal = userLikesData.page + userLikesData.videos + userLikesData.games + userLikesData.art + userLikesData.music + userLikesData.extras;
        userLikesData.total = likesTotal + userLikesData.gamePoints;

        console.log(`📊 Dashboard: Final breakdown for ${targetUsername}:`, {
          ...userLikesData,
          likesOnly: likesTotal,
          totalWithGamePoints: userLikesData.total
        });

        return userLikesData;

      } catch (error) {
        console.error('Error getting likes breakdown:', error);
        return { page: 0, videos: 0, games: 0, art: 0, music: 0, extras: 0, gamePoints: 0, total: 0 };
      }
    }

    async function getUserPoints(username) {
      const breakdown = await getAllLikesBreakdown(username);
      return breakdown.total;
    }
    
    // Load VIP dashboard data with comprehensive error handling
    async function loadVIPDashboard() {
      try {
        // Show loading state
        const loadingEl = document.getElementById('loading');
        if (loadingEl && loadingEl.style.display !== 'none') {
          loadingEl.style.display = 'block';
        }

        // Parallel data fetching with individual error handling
        const [usersResult, messagesResult, extrasResult] = await Promise.allSettled([
          supabase
            .from('users')
            .select('*')
            .eq('is_vip', true)
            .order('created_at', { ascending: false }),
          
          supabase
            .from('direct_messages')
            .select('*')
            .or(`sender_username.eq.${currentUsername},recipient_username.eq.${currentUsername}`)
            .order('created_at', { ascending: false })
            .limit(50),
          
          supabase
            .from('vip_extras')
            .select('*')
            .eq('is_active', true)
            .order('created_at', { ascending: false })
        ]);

        // Handle users data
        let vipUsers = [];
        if (usersResult.status === 'fulfilled' && !usersResult.value.error) {
          vipUsers = usersResult.value.data || [];
        } else {
          console.error('Users fetch error:', usersResult.status === 'fulfilled' ? usersResult.value.error : usersResult.reason);
        }

        // Handle messages data
        let messages = [];
        if (messagesResult.status === 'fulfilled' && !messagesResult.value.error) {
          messages = messagesResult.value.data || [];
        } else {
          console.error('Messages fetch error:', messagesResult.status === 'fulfilled' ? messagesResult.value.error : messagesResult.reason);
        }

        // Handle extras data
        let vipExtras = [];
        if (extrasResult.status === 'fulfilled' && !extrasResult.value.error) {
          vipExtras = extrasResult.value.data || [];
        } else {
          console.error('VIP extras fetch error:', extrasResult.status === 'fulfilled' ? extrasResult.value.error : extrasResult.reason);
        }

        // Update components with available data
        await updateVIPStats(vipUsers, messages);
        await loadVIPMembers(vipUsers);
        loadMessages(messages);
        loadVIPExtras(vipExtras);

        // Show VIP content
        showVIPContent();

        // Hide loading
        if (loadingEl) {
          loadingEl.style.display = 'none';
        }

      } catch (error) {
        console.error('Critical error loading VIP dashboard:', error);
        showError('Failed to load VIP dashboard. Please refresh the page.');
      }
    }

    // Update VIP statistics with better error handling
    async function updateVIPStats(vipUsers, messages) {
      try {
        if (!Array.isArray(vipUsers)) vipUsers = [];
        if (!Array.isArray(messages)) messages = [];
        
        const totalVips = vipUsers.length;
        const currentUserData = vipUsers.find(u => u && u.id === currentUser?.id) || {};
        const unreadCount = messages.filter(m => 
          m && m.recipient_username === currentUsername && !m.is_read
        ).length;

        // Safely update DOM elements
        const totalVipsEl = document.getElementById('totalVips');
        const yourExpiryEl = document.getElementById('yourExpiry');
        const unreadMessagesEl = document.getElementById('unreadMessages');
        const vipSinceEl = document.getElementById('vipSince');

        if (totalVipsEl) totalVipsEl.textContent = totalVips;
        if (yourExpiryEl) yourExpiryEl.textContent = getTimeUntilExpiry(currentUserData.vip_expires_at);
        if (unreadMessagesEl) unreadMessagesEl.textContent = unreadCount;
        if (vipSinceEl) vipSinceEl.textContent = formatDate(currentUserData.created_at);
      } catch (error) {
        console.error('Error updating VIP stats:', error);
      }
    }

    // Load VIP members list with improved username resolution
    async function loadVIPMembers(users) {
      const membersList = document.getElementById('members-list');
      
      if (!membersList) {
        console.error('Members list element not found');
        return;
      }
      
      if (users.length === 0) {
        membersList.innerHTML = '<div style="text-align: center; color: #999; grid-column: 1/-1; padding: 2rem;">No VIP members found</div>';
        return;
      }

      try {
        const membersHtml = [];
        for (const user of users) {
          if (!user || !user.id) continue;
          
          const isActive = user.vip_expires_at ? new Date(user.vip_expires_at) > new Date() : true;
          
          const displayUsername = user.github_username || `VIP-${user.id.split('-')[0]}`;
          
          const isCurrentUser = user.id === currentUser.id;
          
          // Fetch profile from user_profiles
          const { data: profile, error: profileError } = await supabase
            .from('user_profiles')
            .select('*')
            .eq('user_id', user.id)
            .single();

          if (profileError) {
            console.error('Error fetching profile for user:', user.id, profileError);
          }
          
          // Get points
          let points = 0;
          if (displayUsername && !displayUsername.startsWith('VIP-')) {
            points = await getUserPoints(displayUsername);
          }
          
          let bioHtml = '';
          if (profile && profile.bio) {
            const safeBio = profile.bio.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            bioHtml = `<div class="member-bio">${safeBio.slice(0,100)}${safeBio.length > 100 ? '...' : ''}</div>`;
          }
          
          let locationHtml = '';
          if (profile && profile.location) {
            const safeLocation = profile.location.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            locationHtml = `<div class="member-location">📍 ${safeLocation}</div>`;
          }
          
          let pointsHtml = `<div class="member-points">⭐ ${points} points</div>`;
          
          membersHtml.push(`
            <div class="member-card" onclick="openMemberProfile('${displayUsername}')">
              <div class="member-status">${isActive ? '✅' : '⏰'}</div>
              <div class="member-avatar-placeholder">${displayUsername.charAt(0).toUpperCase()}</div>
              <div class="member-username">${displayUsername}${isCurrentUser ? ' (You)' : ''}</div>
              ${locationHtml}
              <div class="member-since">Since: ${formatDate(user.created_at)}</div>
              <div class="member-expires">
                ${user.vip_expires_at ? 
                  `Expires: ${formatDate(user.vip_expires_at)}` : 
                  'Lifetime VIP'
                }
              </div>
              ${bioHtml}
              ${pointsHtml}
              ${!isCurrentUser && !displayUsername.startsWith('VIP-') ? `
                <div class="member-actions">
                  <button onclick="event.stopPropagation(); startMessage('${displayUsername}')">Message</button>
                  <button onclick="event.stopPropagation(); viewProfile('${displayUsername}')">Profile</button>
                </div>
              ` : (!isCurrentUser ? `
                <div class="member-actions">
                  <button onclick="event.stopPropagation(); alert('Username not available for messaging')" style="opacity: 0.5; cursor: not-allowed;">Message</button>
                  <button onclick="event.stopPropagation(); alert('Profile not available')" style="opacity: 0.5; cursor: not-allowed;">Profile</button>
                </div>
              ` : '')}
            </div>
          `);
        }

        membersList.innerHTML = membersHtml.join('');

      } catch (error) {
        console.error('Error rendering VIP members:', error);
        membersList.innerHTML = '<div style="text-align: center; color: #ff8d8d; grid-column: 1/-1; padding: 2rem;">Error loading VIP members</div>';
      }
    }

    // Load messages
    function loadMessages(messages) {
      const messageList = document.getElementById('message-list');
      
      if (!messageList) {
        console.error('Message list element not found');
        return;
      }
      
      if (!messages || messages.length === 0) {
        messageList.innerHTML = '<div style="text-align: center; color: #999; padding: 2rem;">📭 No messages yet. Start a conversation!</div>';
        return;
      }

      try {
        const messagesHtml = messages.map(msg => {
          if (!msg || !msg.id) {
            console.warn('Invalid message data:', msg);
            return '';
          }
          
          const isUnread = !msg.is_read && msg.recipient_username === currentUsername;
          const isFromCurrentUser = msg.sender_username === currentUsername;
          const safeContent = (msg.message_content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          
          return `
            <div class="message-item ${isUnread ? 'unread' : ''}" onclick="markAsRead('${msg.id}')">
              <div class="message-sender">
                ${isFromCurrentUser ? '📤 You' : `📥 ${msg.sender_username || 'Unknown'}`}
                ${!isFromCurrentUser ? ` → You` : ` → ${msg.recipient_username || 'Unknown'}`}
                ${isUnread ? ' 🔴' : ''}
              </div>
              <div class="message-content">${safeContent}</div>
              <div class="message-time">${msg.created_at ? new Date(msg.created_at).toLocaleString() : 'Unknown time'}</div>
            </div>
          `;
        }).filter(html => html !== '');

        messageList.innerHTML = messagesHtml.join('');
      } catch (error) {
        console.error('Error rendering messages:', error);
        messageList.innerHTML = '<div style="text-align: center; color: #ff8d8d; padding: 2rem;">Error loading messages</div>';
      }
    }

    // Load VIP extras with enhanced display and user actions
    function loadVIPExtras(extras) {
      const extrasList = document.getElementById('vip-extras-list');
      
      if (!extrasList) {
        console.error('VIP extras list element not found');
        return;
      }
      
      if (!extras || extras.length === 0) {
        extrasList.innerHTML = `
          <div style="text-align: center; color: #999; grid-column: 1/-1; padding: 3rem;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">📭</div>
            <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">No VIP content shared yet</div>
            <div style="font-size: 0.9rem;">Be the first to share something amazing with fellow VIPs!</div>
          </div>
        `;
        return;
      }

      try {
        const extrasHtml = extras.map(extra => {
          if (!extra || !extra.id) {
            console.warn('Invalid extra data:', extra);
            return '';
          }
          
          const safeTitle = (extra.title || 'Untitled').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          const safeDescription = (extra.description || 'No description').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          const safeCreator = (extra.creator_name || extra.created_by || 'Unknown Creator').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          const contentType = extra.type || 'other';
          const createdDate = extra.created_at ? new Date(extra.created_at).toLocaleDateString() : 'Unknown date';
          const isOwnContent = extra.created_by === currentUsername;
          
          // Type emoji mapping
          const typeEmojis = {
            'game': '🎮',
            'video': '🎥', 
            'art': '🎨',
            'story': '📖',
            'tutorial': '📚',
            'other': '✨'
          };
          
          return `
            <div class="extra-item" onclick="openExtra('${extra.url || '#'}')">
              <div class="extra-type-badge">${typeEmojis[contentType] || '✨'} ${contentType.charAt(0).toUpperCase() + contentType.slice(1)}</div>
              <div class="extra-title">${safeTitle}</div>
              <div class="extra-description">${safeDescription}</div>
              <div class="extra-footer">
                <div class="extra-creator">👤 ${safeCreator}</div>
                <div class="extra-date">📅 ${createdDate}</div>
              </div>
              ${isOwnContent ? `
                <div class="extra-actions" onclick="event.stopPropagation();">
                  <button onclick="editContent('${extra.id}')">✏️ Edit</button>
                  <button class="delete-btn" onclick="deleteContent('${extra.id}')">🗑️ Delete</button>
                </div>
              ` : ''}
            </div>
          `;
        }).filter(html => html !== '');

        extrasList.innerHTML = extrasHtml.join('');
      } catch (error) {
        console.error('Error rendering VIP extras:', error);
        extrasList.innerHTML = '<div style="text-align: center; color: #ff8d8d; grid-column: 1/-1; padding: 2rem;">Error loading VIP content</div>';
      }
    }

    // Content submission functionality
    function initContentSubmission() {
      // Wait for elements to be available
      const checkElements = () => {
        const addContentBtn = document.getElementById('add-content-btn');
        const contentForm = document.getElementById('content-form');
        const submitBtn = document.getElementById('submit-content-btn');
        const cancelBtn = document.getElementById('cancel-content-btn');
        
        if (!addContentBtn || !contentForm || !submitBtn || !cancelBtn) {
          console.log('Content form elements not ready, retrying...');
          setTimeout(checkElements, 500);
          return;
        }
        
        console.log('Initializing content submission form...');
        
        // Remove any existing listeners
        addContentBtn.replaceWith(addContentBtn.cloneNode(true));
        cancelBtn.replaceWith(cancelBtn.cloneNode(true));
        submitBtn.replaceWith(submitBtn.cloneNode(true));
        
        // Get fresh references
        const newAddBtn = document.getElementById('add-content-btn');
        const newCancelBtn = document.getElementById('cancel-content-btn');
        const newSubmitBtn = document.getElementById('submit-content-btn');
        
        // Show form
        newAddBtn.addEventListener('click', () => {
          console.log('Show content form clicked');
          contentForm.style.display = 'block';
          newAddBtn.style.display = 'none';
          document.getElementById('content-title').focus();
        });
        
        // Hide form
        newCancelBtn.addEventListener('click', () => {
          console.log('Cancel content form clicked');
          contentForm.style.display = 'none';
          newAddBtn.style.display = 'inline-block';
          clearContentForm();
        });
        
        // Submit content
        newSubmitBtn.addEventListener('click', submitContent);
        
        console.log('Content submission initialized successfully');
      };
      
      checkElements();
    }

    // Submit new VIP content
    async function submitContent() {
      const titleInput = document.getElementById('content-title');
      const descriptionInput = document.getElementById('content-description');
      const typeInput = document.getElementById('content-type');
      const urlInput = document.getElementById('content-url');
      const submitBtn = document.getElementById('submit-content-btn');
      
      if (!titleInput || !descriptionInput || !typeInput || !urlInput || !submitBtn) {
        alert('Form elements not found');
        return;
      }
      
      const title = titleInput.value.trim();
      const description = descriptionInput.value.trim();
      const type = typeInput.value;
      const url = urlInput.value.trim();
      
      // Validation
      if (!title) {
        alert('Please enter a title');
        titleInput.focus();
        return;
      }
      
      if (!description) {
        alert('Please enter a description');
        descriptionInput.focus();
        return;
      }
      
      if (!url) {
        alert('Please enter a content URL');
        urlInput.focus();
        return;
      }
      
      // Validate URL format
      try {
        new URL(url);
      } catch (error) {
        alert('Please enter a valid URL (starting with http:// or https://)');
        urlInput.focus();
        return;
      }
      
      // Disable submit button
      submitBtn.disabled = true;
      submitBtn.textContent = '🚀 Sharing...';
      
      try {
        const { error } = await supabase
          .from('vip_extras')
          .insert({
            title: title,
            description: description,
            type: type,
            url: url,
            created_by: currentUsername,
            creator_name: currentUsername,
            is_active: true,
            created_at: new Date().toISOString()
          });
        
        if (error) throw error;
        
        // Success - hide form and refresh content
        const contentForm = document.getElementById('content-form');
        const addContentBtn = document.getElementById('add-content-btn');
        
        contentForm.style.display = 'none';
        addContentBtn.style.display = 'inline-block';
        clearContentForm();
        
        // Show success message
        showSuccessNotification('🎉 Content shared successfully with VIP members!');
        
        // Refresh VIP extras
        const { data: vipExtras } = await supabase
          .from('vip_extras')
          .select('*')
          .eq('is_active', true)
          .order('created_at', { ascending: false });
        
        loadVIPExtras(vipExtras || []);
        
      } catch (error) {
        console.error('Error submitting content:', error);
        alert(`Failed to share content: ${error.message}`);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '🚀 Share with VIPs';
      }
    }

    // Clear content form
    function clearContentForm() {
      const form = document.getElementById('content-form');
      if (form) {
        form.querySelectorAll('input, textarea, select').forEach(input => {
          input.value = '';
        });
      }
    }

    // Delete content (only for content creator)
    window.deleteContent = async function(contentId) {
      if (!contentId) return;
      
      const confirmed = confirm('Are you sure you want to delete this content? This action cannot be undone.');
      if (!confirmed) return;
      
      try {
        const { error } = await supabase
          .from('vip_extras')
          .update({ is_active: false })
          .eq('id', contentId)
          .eq('created_by', currentUsername); // Security: only creator can delete
        
        if (error) throw error;
        
        showSuccessNotification('🗑️ Content deleted successfully');
        
        // Refresh content list
        const { data: vipExtras } = await supabase
          .from('vip_extras')
          .select('*')
          .eq('is_active', true)
          .order('created_at', { ascending: false });
        
        loadVIPExtras(vipExtras || []);
        
      } catch (error) {
        console.error('Error deleting content:', error);
        alert(`Failed to delete content: ${error.message}`);
      }
    };

    // Edit content (placeholder for future enhancement)
    window.editContent = function(contentId) {
      alert('Edit functionality coming soon! For now, you can delete and re-share content.');
    };

    // Show success notification
    function showSuccessNotification(message) {
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(45deg, #2ecc71, #27ae60);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: bold;
        z-index: 10000;
        animation: slideIn 0.3s ease;
        box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Send message with comprehensive validation and error handling
    async function sendMessage() {
      const recipientInput = document.getElementById('recipient-input');
      const messageInput = document.getElementById('message-input');
      const sendBtn = document.getElementById('send-message-btn');
      
      if (!recipientInput || !messageInput || !sendBtn) {
        console.error('Message input elements not found');
        return;
      }
      
      const recipient = recipientInput.value.trim();
      const message = messageInput.value.trim();
      
      // Input validation
      if (!recipient) {
        alert('Please enter a recipient username');
        recipientInput.focus();
        return;
      }
      
      if (!message) {
        alert('Please enter a message');
        messageInput.focus();
        return;
      }
      
      if (message.length > 1000) {
        alert('Message is too long. Please keep it under 1000 characters.');
        messageInput.focus();
        return;
      }

      if (recipient === currentUsername) {
        alert('You cannot send a message to yourself');
        recipientInput.focus();
        return;
      }

      // Disable send button to prevent double-sending
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';

      try {
        // Verify recipient is a VIP user
        const { data: recipientCheck, error: recipientError } = await supabase
          .from('users')
          .select('id, is_vip')
          .eq('github_username', recipient)
          .single();
        
        if (recipientError || !recipientCheck || !recipientCheck.is_vip) {
          throw new Error('Recipient not found or not a VIP member. Please check the username.');
        }

        const { error } = await supabase
          .from('direct_messages')
          .insert({
            sender_username: currentUsername,
            recipient_username: recipient,
            message_content: message,
            is_read: false,
            created_at: new Date().toISOString()
          });

        if (error) throw error;

        // Clear inputs
        recipientInput.value = '';
        messageInput.value = '';

        // Reload messages and stats
        const { data: messages } = await supabase
          .from('direct_messages')
          .select('*')
          .or(`sender_username.eq.${currentUsername},recipient_username.eq.${currentUsername}`)
          .order('created_at', { ascending: false })
          .limit(50);

        loadMessages(messages || []);
        
        // Update stats
        const { data: vipUsers } = await supabase
          .from('users')
          .select('*')
          .eq('is_vip', true);
        
        await updateVIPStats(vipUsers || [], messages || []);

        // Show success feedback
        const successMsg = document.createElement('div');
        successMsg.textContent = '✉️ Message sent successfully!';
        successMsg.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: linear-gradient(45deg, #2ecc71, #27ae60);
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          font-weight: bold;
          z-index: 10000;
          animation: slideIn 0.3s ease;
        `;
        document.body.appendChild(successMsg);
        
        setTimeout(() => {
          successMsg.remove();
        }, 3000);

      } catch (error) {
        console.error('Error sending message:', error);
        alert(`Failed to send message: ${error.message}`);
      } finally {
        // Re-enable send button
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send ✉️';
      }
    }

    // Mark message as read
    async function markAsRead(messageId) {
      if (!messageId || !currentUsername) {
        console.error('Invalid message ID or username');
        return;
      }
      
      try {
        const { error } = await supabase
          .from('direct_messages')
          .update({ is_read: true })
          .eq('id', messageId)
          .eq('recipient_username', currentUsername);

        if (error) {
          console.error('Error marking message as read:', error);
        } else {
          // Refresh messages and stats without full reload
          const { data: messages } = await supabase
            .from('direct_messages')
            .select('*')
            .or(`sender_username.eq.${currentUsername},recipient_username.eq.${currentUsername}`)
            .order('created_at', { ascending: false })
            .limit(50);
          
          loadMessages(messages || []);
          
          // Update unread count
          const { data: vipUsers } = await supabase
            .from('users')
            .select('*')
            .eq('is_vip', true);
          
          await updateVIPStats(vipUsers || [], messages || []);
        }
      } catch (error) {
        console.error('Error in markAsRead:', error);
      }
    }

    // Start message to specific user
    window.startMessage = function(username) {
      if (!username || username.trim() === '') {
        console.error('Invalid username for message');
        return;
      }
      
      const recipientInput = document.getElementById('recipient-input');
      const messageInput = document.getElementById('message-input');
      
      if (recipientInput && messageInput) {
        recipientInput.value = username;
        messageInput.focus();
        
        // Scroll to message center
        const messageCenter = document.querySelector('.vip-message-center');
        if (messageCenter) {
          messageCenter.scrollIntoView({ 
            behavior: 'smooth' 
          });
        }
      }
    };

    // View user profile
    window.viewProfile = function(username) {
      if (username && username.trim() !== '') {
        window.location.href = `user.html?user=${encodeURIComponent(username)}`;
      }
    };

    // Open member profile  
    window.openMemberProfile = function(username) {
      if (username && username.trim() !== '' && username !== currentUsername) {
        window.location.href = `user.html?user=${encodeURIComponent(username)}`;
      }
    };

    // Open VIP extra content
    window.openExtra = function(url) {
      if (url && url !== '#' && url.trim() !== '') {
        try {
          // Validate URL format
          new URL(url);
          window.open(url, '_blank', 'noopener,noreferrer');
        } catch (error) {
          console.error('Invalid URL:', url);
          alert('Invalid content URL');
        }
      } else {
        alert('Content URL not available');
      }
    };

    // Show upgrade options for non-VIP users
    window.showUpgradeOptions = function() {
      alert('Redirecting to upgrade page...');
      window.location.href = 'index.html';
    };

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      const sendBtn = document.getElementById('send-message-btn');
      const messageInput = document.getElementById('message-input');
      
      if (sendBtn) {
        sendBtn.addEventListener('click', sendMessage);
      }
      
      if (messageInput) {
        messageInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
      }
      
      // Initialize content submission after DOM is loaded
      setTimeout(() => {
        initContentSubmission();
      }, 1000);
    });

    // Initialize the dashboard with better error recovery
    async function initializeDashboard() {
      try {
        const hasAccess = await checkUserAccess();
        
        if (hasAccess) {
          await loadVIPDashboard();
          
          // Initialize content submission functionality with retry
          const initContentWithRetry = () => {
            setTimeout(() => {
              initContentSubmission();
            }, 2000);
          };
          
          initContentWithRetry();
          
          // Auto-refresh every 30 seconds with error handling
          const refreshInterval = setInterval(async () => {
            try {
              // Only refresh if user is still on the page and has access
              if (document.visibilityState === 'visible' && isVIPUser) {
                await loadVIPDashboard();
              }
            } catch (error) {
              console.error('Error in auto-refresh:', error);
              // If too many errors, stop auto-refresh
              if (error.message && error.message.includes('Network')) {
                console.warn('Network issues detected, reducing refresh frequency');
                clearInterval(refreshInterval);
                // Retry with longer interval
                setTimeout(() => {
                  setInterval(async () => {
                    try {
                      if (document.visibilityState === 'visible' && isVIPUser) {
                        await loadVIPDashboard();
                      }
                    } catch (retryError) {
                      console.error('Retry refresh failed:', retryError);
                    }
                  }, 60000); // 1 minute intervals
                }, 30000);
              }
            }
          }, 30000);
          
          // Clean up interval when page unloads
          window.addEventListener('beforeunload', () => {
            clearInterval(refreshInterval);
          });
        }
      } catch (error) {
        console.error('Failed to initialize dashboard:', error);
        showError('Failed to initialize VIP dashboard. Please refresh the page.');
      }
    }

    // Start the application
    initializeDashboard();
  </script>
</body>
</html>



